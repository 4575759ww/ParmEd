<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>parmed.structure &mdash; ParmEd 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="ParmEd 2.0 documentation" href="../../index.html" />
    <link rel="up" title="parmed" href="../parmed.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ParmEd 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../parmed.html" accesskey="U">parmed</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for parmed.structure</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the core base class for all of the chemical structures with</span>
<span class="sd">various topological and force field features.</span>

<span class="sd">Author: Jason Swails</span>
<span class="sd">Contributors: Pawel Janowski</span>

<span class="sd">Copyright (C) 2014 - 2015  Jason Swails</span>

<span class="sd">This program is free software; you can redistribute it and/or modify it under</span>
<span class="sd">the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="sd">Software Foundation; either version 2 of the License, or (at your option) any</span>
<span class="sd">later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="sd">WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span class="sd">PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU Lesser General Public License along</span>
<span class="sd">with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="sd">59 Temple Place - Suite 330</span>
<span class="sd">Boston, MA 02111-1307, USA.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pd</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">from</span> <span class="nn">parmed.constants</span> <span class="kn">import</span> <span class="n">DEG_TO_RAD</span><span class="p">,</span> <span class="n">SMALL</span>
<span class="kn">from</span> <span class="nn">parmed.exceptions</span> <span class="kn">import</span> <span class="n">ParameterError</span>
<span class="kn">from</span> <span class="nn">parmed.geometry</span> <span class="kn">import</span> <span class="p">(</span><span class="n">box_lengths_and_angles_to_vectors</span><span class="p">,</span>
        <span class="n">box_vectors_to_lengths_and_angles</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">parmed.residue</span> <span class="kn">import</span> <span class="n">WATER_NAMES</span>
<span class="kn">from</span> <span class="nn">parmed.topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AtomList</span><span class="p">,</span> <span class="n">ResidueList</span><span class="p">,</span> <span class="n">TrackedList</span><span class="p">,</span>
        <span class="n">DihedralTypeList</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span> <span class="n">ImproperType</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Dihedral</span><span class="p">,</span>
        <span class="n">UreyBradley</span><span class="p">,</span> <span class="n">Improper</span><span class="p">,</span> <span class="n">Cmap</span><span class="p">,</span> <span class="n">TrigonalAngle</span><span class="p">,</span> <span class="n">OutOfPlaneBend</span><span class="p">,</span> <span class="n">PiTorsion</span><span class="p">,</span>
        <span class="n">StretchBend</span><span class="p">,</span> <span class="n">TorsionTorsion</span><span class="p">,</span> <span class="n">NonbondedException</span><span class="p">,</span> <span class="n">AcceptorDonor</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span>
        <span class="n">Atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">,</span> <span class="n">TwoParticleExtraPointFrame</span><span class="p">,</span> <span class="n">ChiralFrame</span><span class="p">,</span>
        <span class="n">MultipoleFrame</span><span class="p">,</span> <span class="n">NoUreyBradley</span><span class="p">,</span> <span class="n">ThreeParticleExtraPointFrame</span><span class="p">,</span>
        <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">parmed.utils</span> <span class="kn">import</span> <span class="n">tag_molecules</span>
<span class="kn">from</span> <span class="nn">parmed.utils.decorators</span> <span class="kn">import</span> <span class="n">needs_openmm</span>
<span class="kn">from</span> <span class="nn">parmed.utils.six</span> <span class="kn">import</span> <span class="n">string_types</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">,</span> <span class="n">iteritems</span>
<span class="kn">from</span> <span class="nn">parmed.utils.six.moves</span> <span class="kn">import</span> <span class="nb">zip</span><span class="p">,</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">parmed.vec3</span> <span class="kn">import</span> <span class="n">Vec3</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="c"># Try to import the OpenMM modules</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm</span> <span class="kn">import</span> <span class="n">app</span>
    <span class="kn">from</span> <span class="nn">simtk</span> <span class="kn">import</span> <span class="n">openmm</span> <span class="k">as</span> <span class="n">mm</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm.app.internal.unitcell</span> <span class="kn">import</span> <span class="n">reducePeriodicBoxVectors</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">=</span> <span class="bp">None</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="c"># Private attributes and methods</span>

<span class="n">relatere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;RELATED ID: *(\w+) *RELATED DB: *(\w+)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_compare_atoms</span><span class="p">(</span><span class="n">old_atom</span><span class="p">,</span> <span class="n">new_atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two atom instances, along with the residue name, number, and chain</span>
<span class="sd">    identifier, to determine if two atoms are actually the *same* atom, but</span>
<span class="sd">    simply different conformations</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    old_atom : :class:`Atom`</span>
<span class="sd">        The original atom that has been added to the structure already</span>
<span class="sd">    new_atom : :class:`Atom`</span>
<span class="sd">        The new atom that we want to see if it is the same as the old atom</span>
<span class="sd">    resname : ``str``</span>
<span class="sd">        The name of the residue that the new atom would belong to</span>
<span class="sd">    resid : ``int``</span>
<span class="sd">        The number of the residue that the new atom would belong to</span>
<span class="sd">    chain : ``str``</span>
<span class="sd">        The chain identifier that the new atom would belong to</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if they are the same atom, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">new_atom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">resname</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">resid</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span> <span class="o">!=</span> <span class="n">chain</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.7</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.55</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span> <span class="k">return</span> <span class="mf">2.1</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.8</span>
    <span class="k">return</span> <span class="mf">1.5</span>

<span class="k">def</span> <span class="nf">_mbondi</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">bondeds</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span>
        <span class="k">if</span> <span class="n">bondeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.3</span>
        <span class="k">if</span> <span class="n">bondeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.8</span>
        <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">return</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.3</span>
        <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">return</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mbondi3</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;GLU&#39;</span><span class="p">,</span> <span class="s">&#39;ASP&#39;</span><span class="p">,</span> <span class="s">&#39;GL4&#39;</span><span class="p">,</span> <span class="s">&#39;AS4&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;OE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;OD&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.4</span>
    <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;ARG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HH&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HE&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.17</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;OXT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.4</span>
    <span class="k">return</span> <span class="n">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="nd">@needs_openmm</span>
<span class="k">def</span> <span class="nf">_gb_rad_screen</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the default GB parameters for a given atom according to a specific</span>
<span class="sd">    Generalized Born model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atom : :class:`Atom`</span>
<span class="sd">        The atom to get the default GB parameters for</span>
<span class="sd">    model : ``app.HCT, app.OBC1, or app.OBC2``</span>
<span class="sd">        The GB model to get the default parameters for (app.GBn and app.GBn2 are</span>
<span class="sd">        already handled in Structure._get_gb_parameters)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    radius, screen [,alpha, beta, gamma] : ``float, float [,float, float, float]``</span>
<span class="sd">        The intrinsic radius of the atom and the screening factor of the atom.</span>
<span class="sd">        If the model is GBn2, alpha, beta, and gamma parameters are also</span>
<span class="sd">        returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">_mbondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.72</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.79</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.88</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.86</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.96</span>
    <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.8</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A chemical structure composed of atoms, bonds, angles, torsions, and other</span>
<span class="sd">    topological features</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : :class:`AtomList`</span>
<span class="sd">        List of all atoms in the structure</span>
<span class="sd">    residues : :class:`ResidueList`</span>
<span class="sd">        List of all residues in the structure</span>
<span class="sd">    bonds : :class:`TrackedList` (:class:`Bond`)</span>
<span class="sd">        List of all bonds in the structure</span>
<span class="sd">    angles : :class:`TrackedList` (:class:`Angle`)</span>
<span class="sd">        List of all angles in the structure</span>
<span class="sd">    dihedrals : :class:`TrackedList` (:class:`Dihedral`)</span>
<span class="sd">        List of all dihedrals in the structure</span>
<span class="sd">    rb_torsions : :class:`TrackedList` (:class:`RBTorsion`)</span>
<span class="sd">        List of all Ryckaert-Bellemans torsions in the structure</span>
<span class="sd">    urey_bradleys : :class:`TrackedList` (:class:`UreyBradley`)</span>
<span class="sd">        List of all Urey-Bradley angle bends in the structure</span>
<span class="sd">    impropers : :class:`TrackedList` (:class:`Improper`)</span>
<span class="sd">        List of all CHARMM-style improper torsions in the structure</span>
<span class="sd">    cmaps : :class:`TrackedList` (:class:`Cmap`)</span>
<span class="sd">        List of all CMAP objects in the structure</span>
<span class="sd">    trigonal_angles : :class:`TrackedList` (:class:`TrigonalAngle`)</span>
<span class="sd">        List of all AMOEBA-style trigonal angles in the structure</span>
<span class="sd">    out_of_plane_bends : :class:`TrackedList` (:class:`OutOfPlaneBends`)</span>
<span class="sd">        List of all AMOEBA-style out-of-plane bending angles</span>
<span class="sd">    pi_torsions : :class:`TrackedList` (:class:`PiTorsion`)</span>
<span class="sd">        List of all AMOEBA-style pi-torsion angles</span>
<span class="sd">    stretch_bends : :class:`TrackedList` (:class:`StretchBend`)</span>
<span class="sd">        List of all AMOEBA-style stretch-bend compound bond/angle terms</span>
<span class="sd">    torsion_torsions : :class:`TrackedList` (:class:`TorsionTorsion`)</span>
<span class="sd">        List of all AMOEBA-style coupled torsion-torsion terms</span>
<span class="sd">    chiral_frames : :class:`TrackedList` (:class:`ChiralFrame`)</span>
<span class="sd">        List of all AMOEBA-style chiral frames defined in the structure</span>
<span class="sd">    multipole_frames : :class:`TrackedList` (:class:`MultipoleFrame`)</span>
<span class="sd">        List of all AMOEBA-style multipole frames defined in the structure</span>
<span class="sd">    adjusts : :class:`TrackedList` (:class:`NonbondedException`)</span>
<span class="sd">        List of all nonbonded pair-exception rules</span>
<span class="sd">    acceptors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond acceptors, if that information is present</span>
<span class="sd">    donors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond donors, if that information is present</span>
<span class="sd">    groups : :class:`TrackedList` (:class:`Group`)</span>
<span class="sd">        List of all CHARMM-style GROUP objects (whatever those are used for)</span>
<span class="sd">    box : ``list of 6 floats``</span>
<span class="sd">        Box dimensions (a, b, c, alpha, beta, gamma) for the unit cell. If no</span>
<span class="sd">        box is defined, `box` is set to `None`</span>
<span class="sd">    space_group : ``str``</span>
<span class="sd">        The space group of the structure (default is &quot;P 1&quot;)</span>
<span class="sd">    nrexcl : ``int``</span>
<span class="sd">        The number of bonds away that an atom can be in order to be excluded</span>
<span class="sd">        from the direct nonbonded summation</span>
<span class="sd">    title : ``str``</span>
<span class="sd">        Cosmetic only, it is an arbitrary title assigned to the system. Default</span>
<span class="sd">        value is an empty string</span>
<span class="sd">    positions : u.Quantity(list(Vec3), u.angstroms)</span>
<span class="sd">        Unit-bearing atomic coordinates. If not all atoms have coordinates, this</span>
<span class="sd">        property is None</span>
<span class="sd">    coordinates : np.ndarray of shape (nframes, natom, 3)</span>
<span class="sd">        If no coordinates are set, this is set to None. The first frame will</span>
<span class="sd">        match the coordinates present on the atoms.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This class also has a handful of type lists for each of the attributes above</span>
<span class="sd">    (excluding `atoms`, `residues`, `chiral_frames`, and `multipole_frames`).</span>
<span class="sd">    They are all TrackedList instances that are designed to hold the relevant</span>
<span class="sd">    parameter type. The list is:</span>
<span class="sd">        bond_types, angle_types, dihedral_types, urey_bradley_types,</span>
<span class="sd">        improper_types, cmap_types, trigonal_angle_types,</span>
<span class="sd">        out_of_plane_bend_types, pi_torsion_types, stretch_bend_types,</span>
<span class="sd">        torsion_torsion_types, adjust_types</span>

<span class="sd">    dihedral_types _may_ be a list of :class:`DihedralType` instances, since</span>
<span class="sd">    torsion profiles are often represented by a Fourier series with multiple</span>
<span class="sd">    terms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Force groups assigned to each type of force</span>
    <span class="n">BOND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ANGLE_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DIHEDRAL_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">UREY_BRADLEY_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">IMPROPER_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">CMAP_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">TRIGONAL_ANGLE_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">OUT_OF_PLANE_BEND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">PI_TORSION_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">STRETCH_BEND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">TORSION_TORSION_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">NONBONDED_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="n">RB_TORSION_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="c">#===================================================</span>

<div class="viewcode-block" id="Structure.__init__"><a class="viewcode-back" href="../../structobj/parmed.structure.Structure.html#parmed.structure.Structure.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Topological object lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">AtomList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="o">=</span> <span class="n">ResidueList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="c"># Extraneous information stored in CHARMM PSF files... not used as far</span>
        <span class="c"># as I can tell for much of anything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donors</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>

        <span class="c"># Parameter type lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="s">&quot;P 1&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrexcl</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combining_rule</span> <span class="o">=</span> <span class="s">&#39;lorentz&#39;</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">nres</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
        <span class="n">nextra</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> atoms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">natom</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">nextra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; [</span><span class="si">%d</span><span class="s"> EPs]&#39;</span> <span class="o">%</span> <span class="n">nextra</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; </span><span class="si">%d</span><span class="s"> residues&#39;</span> <span class="o">%</span> <span class="n">nres</span><span class="p">)</span>
        <span class="n">nbond</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; </span><span class="si">%d</span><span class="s"> bonds&#39;</span> <span class="o">%</span> <span class="n">nbond</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; PBC&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SMALL</span> <span class="ow">or</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SMALL</span> <span class="ow">or</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">SMALL</span><span class="p">):</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; (triclinic)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; (orthogonal)&#39;</span><span class="p">)</span>
        <span class="c"># Just assume that if the first bond has a defined type, so does</span>
        <span class="c"># everything else... we don&#39;t want __repr__ to be super expensive</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; parametrized&gt;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; NOT parametrized&gt;&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span>

    <span class="c">#===================================================</span>

<div class="viewcode-block" id="Structure.add_atom"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.add_atom">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">inscode</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new atom to the Structure, adding a new residue to `residues` if</span>
<span class="sd">        it has a different name or number as the last residue added and adding</span>
<span class="sd">        it to the `atoms` list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom : :class:`Atom`</span>
<span class="sd">            The atom to add to this residue list</span>
<span class="sd">        resname : ``str``</span>
<span class="sd">            The name of the residue this atom belongs to</span>
<span class="sd">        resnum : ``int``</span>
<span class="sd">            The number of the residue this atom belongs to</span>
<span class="sd">        chain : ``str``</span>
<span class="sd">            The chain ID character for this residue</span>
<span class="sd">        inscode : ``str``</span>
<span class="sd">            The insertion code ID character for this residue (it is stripped)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the residue name and number differ from the last residue in this</span>
<span class="sd">        list, a new residue is added and the atom is added to that residue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">inscode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.add_atom_to_residue"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.add_atom_to_residue">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom_to_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">residue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new atom to the Structure at the end if the given residue</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom : :class:`Atom`</span>
<span class="sd">            The atom to add to the system</span>
<span class="sd">        residue : :class:`Residue`</span>
<span class="sd">            The residue to which to add this atom. It MUST be part of this</span>
<span class="sd">            Structure instance already or a ValueError is raised</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This atom is added at the end of the residue and is inserted into the</span>
<span class="sd">        `atoms` list in such a way that all residues are composed of atoms</span>
<span class="sd">        contiguous in the atoms list. For large systems, this may be a</span>
<span class="sd">        relatively expensive operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make sure residue belongs to this list</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Residue is not part of the structure&#39;</span><span class="p">)</span>
        <span class="n">last_atom</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">residue</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="c"># Special-case if this is going to be the last atom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">or</span> <span class="n">last_atom</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">last_atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A deep copy of the Structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="c">#===================================================</span>

<div class="viewcode-block" id="Structure.copy"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">split_dihedrals</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a copy of the current structure as an instance of a specified</span>
<span class="sd">        subclass</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls : Structure subclass</span>
<span class="sd">            The returned object is a copy of this structure as a `cls` instance</span>
<span class="sd">        split_dihedrals : ``bool``</span>
<span class="sd">            If True, then the Dihedral entries will be split up so that each one</span>
<span class="sd">            is paired with a single DihedralType (rather than a</span>
<span class="sd">            DihedralTypeList)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        *cls* instance</span>
<span class="sd">            The instance of the Structure subclass `cls` with a copy of the</span>
<span class="sd">            current Structure&#39;s topology information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
        <span class="c"># Now copy all of the types</span>
        <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">bt</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">split_dihedrals</span><span class="p">:</span>
            <span class="n">ndt</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mapdt</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">idt</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                        <span class="n">mapdt</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">idt</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndt</span><span class="p">)</span>
                        <span class="n">ndt</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mapdt</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">idt</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ndt</span><span class="p">)</span>
                    <span class="n">ndt</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">dt</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ut</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">rt</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ta</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">ot</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">pt</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">st</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">tt</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">at</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="c"># Now create the topological objects</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Bond</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">b</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">funct</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Angle</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                          <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                          <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">funct</span>
        <span class="k">if</span> <span class="n">split_dihedrals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">)):</span>
                        <span class="n">ie</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">ti</span> <span class="o">=</span> <span class="n">mapdt</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">ie</span><span class="p">,</span>
                                         <span class="nb">type</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_funct</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_funct</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ti</span> <span class="o">=</span> <span class="n">mapdt</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_funct</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_funct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">typ</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_funct</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">_funct</span>
        <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">NoUreyBradley</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">c</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">UreyBradley</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">ub</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Improper</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="n">i</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">rb_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="n">atoms</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="nb">type</span><span class="o">=</span><span class="n">r</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_funct</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">_funct</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Cmap</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">cm</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">funct</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TrigonalAngle</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                  <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                  <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">OutOfPlaneBend</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">o</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">PiTorsion</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">p</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">StretchBend</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">s</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TorsionTorsion</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">t</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChiralFrame</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">ch</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">MultipoleFrame</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">frame_pt_num</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">vectail</span><span class="p">,</span>
                                   <span class="n">m</span><span class="o">.</span><span class="n">vechead</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">nvec</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">NonbondedException</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                       <span class="n">a</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AcceptorDonor</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">donors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AcceptorDonor</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">move</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.to_dataframe"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a DataFrame from the current Structure&#39;s atomic properties</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            DataFrame with all atomic properties</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`parmed.utils.pandautils.create_dataframe` for full</span>
<span class="sd">        documentation of the generated DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.utils.pandautils</span> <span class="kn">import</span> <span class="n">create_dataframe</span>
        <span class="k">return</span> <span class="n">create_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.load_dataframe"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.load_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">load_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads atomic properties from an input DataFrame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            A pandas DataFrame with atomic properties that will be used to set</span>
<span class="sd">            the properties on the current list of atoms</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`parmed.utils.pandautils.load_dataframe` for full documentation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.utils.pandautils</span> <span class="kn">import</span> <span class="n">load_dataframe</span>
        <span class="k">return</span> <span class="n">load_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.is_changed"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.is_changed">[docs]</a>    <span class="k">def</span> <span class="nf">is_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines if any of the topology has changed for this structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.unchange"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.unchange">[docs]</a>    <span class="k">def</span> <span class="nf">unchange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Toggles all lists so that they do not indicate any changes &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Parameter type lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.prune_empty_terms"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.prune_empty_terms">[docs]</a>    <span class="k">def</span> <span class="nf">prune_empty_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks through all of the topological lists and gets rid of terms</span>
<span class="sd">        in which at least one of the atoms is None or has an `idx` attribute set</span>
<span class="sd">        to -1 (indicating that it has been removed from the `atoms` atom list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_bonds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_angles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_dihedrals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_rb_torsions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_ureys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_impropers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_cmaps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_trigonal_angles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_out_of_plane_bends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_pi_torsions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_stretch_bends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_torsion_torsions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_chiral_frames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_multipole_frames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_adjusts</span><span class="p">()</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.update_dihedral_exclusions"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.update_dihedral_exclusions">[docs]</a>    <span class="k">def</span> <span class="nf">update_dihedral_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nonbonded exclusions and exceptions have the following priority:</span>

<span class="sd">        bond -&gt; angle -&gt; dihedral</span>

<span class="sd">        Since bonds and angles are completely excluded, any ring systems in</span>
<span class="sd">        which two atoms are attached by a bond or angle as well as a dihedral</span>
<span class="sd">        should be completely excluded as the bond and angle exclusion rules take</span>
<span class="sd">        precedence.  If a Bond or Angle was _added_ to the structure between a</span>
<span class="sd">        pair of atoms previously connected only by a dihedral term, it&#39;s</span>
<span class="sd">        possible that those two atoms have both an exclusion *and* an exception</span>
<span class="sd">        defined. The result of this scenario is that sander and pmemd will</span>
<span class="sd">        happily compute an energy, _including_ the 1-4 nonbonded terms between</span>
<span class="sd">        atoms now connected by a bond or an Angle.  OpenMM, on the other hand,</span>
<span class="sd">        will complain about an exception specified multiple times. This method</span>
<span class="sd">        scans through all of the dihedrals in which `ignore_end` is `False` and</span>
<span class="sd">        turns it to `True` if the two end atoms are in the bond or angle</span>
<span class="sd">        partners arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">set14</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span> <span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">):</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span> <span class="ow">in</span> <span class="n">set14</span><span class="p">:</span>
                <span class="c"># Avoid double counting of 1-4 in a six-membered ring</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">set14</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>
                <span class="n">set14</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">))</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.strip"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a subset of the atoms corresponding to an atom-based selection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection : :class:`AmberMask`, ``str``, or ``iterable``</span>
<span class="sd">            This is the selection of atoms that will be deleted from this</span>
<span class="sd">            structure. If it is a string, it will be interpreted as an</span>
<span class="sd">            AmberMask. If it is an AmberMask, it will be converted to a</span>
<span class="sd">            selection of atoms. If it is an iterable, it must be the same length</span>
<span class="sd">            as the `atoms` list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="kn">import</span> <span class="n">AmberMask</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">AmberMask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;passed mask does not belong to Structure&#39;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Selection not a supported type [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Selection iterable wrong length&#39;</span><span class="p">)</span>
        <span class="n">atomlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">atomlist</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">prune</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span>
        <span class="c"># Slice out coordinates if present</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Allows extracting a single atom from the structure or a slice of atoms</span>
<span class="sd">        as a new Structure instance. The following syntaxes are allowed:</span>

<span class="sd">            - struct[str] : str is interpreted as an Amber selection mask</span>
<span class="sd">            - struct[[sel,[sel,]],sel] : sel can be a list of indices (or</span>
<span class="sd">                            strings for chain selection) an integer, or a slice</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection : str, or slice|iter|str, slice|iter|int, slice|iter|int</span>
<span class="sd">            Which atoms to select for the new structure</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        struct : :class:`Structure`</span>
<span class="sd">            If more than one atom is selected, the resulting return value is a</span>
<span class="sd">            new structure containing all selected atoms and all valence terms</span>
<span class="sd">            (and types) in which all involved atoms are present</span>

<span class="sd">        or</span>

<span class="sd">        atom : :class:`Atom`</span>
<span class="sd">            If the selection is a single integer, a tuple of two integers, or a</span>
<span class="sd">            tuple of a string and two integers. This is equivalent to selecting</span>
<span class="sd">            a particular atom, a particular atom from a particular residue, or a</span>
<span class="sd">            particular atom from a particular residue from a particular chain,</span>
<span class="sd">            respectively. All other selections return a Structure instance, even</span>
<span class="sd">            if that selection happens to only select a single atom.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        When selecting more than 1 atom, this is a costly operation. It is</span>
<span class="sd">        currently implemented by making a full copy of the object and then</span>
<span class="sd">        stripping the unused atoms.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ``TypeError`` : if selection (or any part of the selection) is not an</span>
<span class="sd">                        allowed type</span>

<span class="sd">        ``ValueError`` : if the selection is a boolean-like list and its length</span>
<span class="sd">                         is not the same as the number of atoms in the system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>

        <span class="n">selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_selection_array</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="c"># _get_selection_array might have returned either an Atom or None if</span>
        <span class="c"># there is no selection. Handle those and return, or continue if we got</span>
        <span class="c"># a list of atoms</span>
        <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">selection</span>
        <span class="n">sumsel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sumsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># No atoms selected. Return None</span>
            <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="c"># The cumulative sum of selection will give our index + 1 of each</span>
        <span class="c"># selected atom into the new structure</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)):</span>
            <span class="n">scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c"># Zero-out the unselected atoms</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">selection</span><span class="p">)]</span>
        <span class="c"># Copy all parameters</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">idx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">number</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">copy_valence_terms</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span> <span class="n">otyp</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">styp</span><span class="p">,</span> <span class="n">attrlist</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Copies the valence terms from one list to another;</span>
<span class="sd">            oval=Other VALence; otyp=Other TYPe; sval=Self VALence;</span>
<span class="sd">            styp=Self TYPe; attrlist=ATTRibute LIST (atom1, atom2, ...)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">otypcp</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">styp</span><span class="p">]</span>
            <span class="n">used_types</span> <span class="o">=</span> <span class="p">[</span><span class="bp">False</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">otypcp</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sval</span><span class="p">:</span>
                <span class="n">ats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrlist</span><span class="p">]</span>
                <span class="c"># Make sure all of our atoms in this valence term is &quot;selected&quot;</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ats</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Atom</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c"># Add the type if applicable</span>
                <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">otypcp</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">kws</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">otypcp</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                    <span class="n">used_types</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ats</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
                        <span class="n">ats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">oval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)(</span><span class="o">*</span><span class="n">ats</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;funct&#39;</span><span class="p">):</span>
                    <span class="n">oval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">funct</span>
            <span class="c"># Now tack on the &quot;new&quot; types copied from `other`</span>
            <span class="k">for</span> <span class="n">used</span><span class="p">,</span> <span class="n">typ</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">used_types</span><span class="p">,</span> <span class="n">otypcp</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">used</span><span class="p">:</span> <span class="n">otyp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">otyp</span><span class="p">,</span> <span class="s">&#39;claim&#39;</span><span class="p">):</span>
                <span class="n">otyp</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span>
                           <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span>
                           <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                           <span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">,</span>
                            <span class="s">&#39;atom6&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;chirality&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span>
                           <span class="p">[],</span> <span class="p">[</span><span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;frame_pt_num&#39;</span><span class="p">,</span> <span class="s">&#39;vectail&#39;</span><span class="p">,</span> <span class="s">&#39;vechead&#39;</span><span class="p">,</span>
                           <span class="s">&#39;nvec&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;bs&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;move&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">struct</span>

    <span class="k">def</span> <span class="nf">_get_selection_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to convert a selection into an array -- common use for</span>
<span class="sd">        viewing and regular selection</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection : selector (slice, tuple, ... etc.)</span>
<span class="sd">            The selection given to the [] operator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.amber</span> <span class="kn">import</span> <span class="n">AmberMask</span>
        <span class="c"># Now we select a subset of atoms. Convert &quot;selection&quot; into a natom list</span>
        <span class="c"># with 0s and 1s, depending on what the input selection is</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))[</span><span class="n">selection</span><span class="p">]:</span>
                <span class="n">sel</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">sel</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
            <span class="c"># This is a selection of chains, and/or residues, and/or atoms</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c"># Select just residues and atoms. Special-case a single-atom</span>
                <span class="c"># selection for speed -- orders of magnitude improvement in</span>
                <span class="c"># efficiency</span>
                <span class="n">ressel</span><span class="p">,</span> <span class="n">atomsel</span> <span class="o">=</span> <span class="n">selection</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ressel</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">atomsel</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="n">ressel</span><span class="p">][</span><span class="n">atomsel</span><span class="p">]</span>
                <span class="n">has_chain</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">chainsel</span><span class="p">,</span> <span class="n">ressel</span><span class="p">,</span> <span class="n">atomsel</span> <span class="o">=</span> <span class="n">selection</span>
                <span class="n">chainmap</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="n">TrackedList</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                    <span class="n">chainmap</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">chainsel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">ressel</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">atomsel</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">)):</span>
                    <span class="c"># Special-case single-atom selection for efficiency</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">chainmap</span><span class="p">[</span><span class="n">chainsel</span><span class="p">][</span><span class="n">ressel</span><span class="p">][</span><span class="n">atomsel</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;No chain </span><span class="si">%s</span><span class="s"> in Structure&#39;</span> <span class="o">%</span> <span class="n">chainsel</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chainsel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">chainsel</span> <span class="ow">in</span> <span class="n">chainmap</span><span class="p">:</span>
                        <span class="n">chainset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">chainsel</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># The selected chain is not in the system. Cannot</span>
                        <span class="c"># possibly select *any* atoms. Bail now for speed</span>
                        <span class="k">return</span> <span class="bp">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chainsel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                    <span class="c"># Build an ordered set of chains</span>
                    <span class="n">chains</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chain</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span> <span class="o">!=</span> <span class="n">chains</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">chains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">)</span>
                    <span class="n">chainset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chains</span><span class="p">[</span><span class="n">chainsel</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chainset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">chainsel</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chainset</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">chainmap</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># No requested chain is present. Bail now for speed</span>
                    <span class="k">return</span> <span class="bp">None</span>
                <span class="n">has_chain</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c"># Residue selection can either be by name or index</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ressel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">resset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)))[</span><span class="n">ressel</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ressel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ressel</span><span class="p">,</span>
                    <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">resset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">ressel</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ressel</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atomsel</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
                <span class="n">atomset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)))[</span><span class="n">atomsel</span><span class="p">])</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atomsel</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atomsel</span><span class="p">,</span>
                    <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">atomset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">atomsel</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atomset</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atomsel</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_chain</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c"># To allow us to index the atoms residues from their list of</span>
                    <span class="c"># chains, temporarily have the chainmap lists claim the</span>
                    <span class="c"># residues. This must be reversed or the Structure will be</span>
                    <span class="c"># broken</span>
                    <span class="k">for</span> <span class="n">chain_name</span><span class="p">,</span> <span class="n">chain</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">chainmap</span><span class="p">):</span>
                        <span class="n">chain</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
                    <span class="n">selection</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span> <span class="ow">in</span> <span class="n">chainset</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">resset</span> <span class="ow">or</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">resset</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">atomset</span> <span class="ow">or</span>
                                <span class="n">a</span><span class="o">.</span><span class="n">idx</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomset</span><span class="p">)</span>

                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
                    <span class="p">]</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c"># Make sure that the residues list *always* reclaims its</span>
                    <span class="c"># contents</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">selection</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">atomset</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">idx</span><span class="o">-</span><span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">atomset</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">resset</span> <span class="ow">or</span> <span class="n">a</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span> <span class="ow">in</span> <span class="n">resset</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span>
                <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Assume it is an iterable. If it is the same length as the atoms,</span>
            <span class="c"># it is a boolean mask array. Otherwise, it is a list of atom</span>
            <span class="c"># indices to select</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">:</span> <span class="n">sel</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Selection iterable is too long&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">:</span>
                        <span class="n">sel</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Selected atom out of range&#39;</span><span class="p">)</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">sel</span>
        <span class="c"># Make sure we have an integer array of 0s and 1s</span>
        <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="nd">@property</span>
<div class="viewcode-block" id="Structure.view"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.view">[docs]</a>    <span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an indexable object that can be indexed like a standard</span>
<span class="sd">        Structure, but returns a *view* rather than a copy</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        Structure.__getitem__</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_StructureViewerCreator</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.split"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split the current Structure into separate Structure instances for each</span>
<span class="sd">        unique molecule. A molecule is defined as all atoms connected by a graph</span>
<span class="sd">        of covalent bonds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        [structs, counts] : list of (:class:`Structure`, list) tuples</span>
<span class="sd">            List of all molecules in the order that they appear first in the</span>
<span class="sd">            parent structure accompanied by the list of the molecule numbers</span>
<span class="sd">            in which that molecule appears in the Structure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">tag_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">mollist</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">marked</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">nmol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mollist</span><span class="p">)</span>
        <span class="n">structs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">res_molecules</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c"># Divvy up the atoms into their separate molecules</span>
        <span class="n">molatoms</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">molatoms</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">marked</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmol</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">molatoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">involved_residues</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">idx</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">sel</span><span class="p">)</span>
            <span class="c"># Shortcut -- keep names of single-residue molecules and the number</span>
            <span class="c"># of atoms present in those residues in a dict and use that to see</span>
            <span class="c"># if two molecules are unique -- this gives drastic speedup for</span>
            <span class="c"># systems with many duplicated single-residue molecules</span>
            <span class="c"># (i.e., just about every solvent out there)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">involved_residues</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">residue</span>
                <span class="n">names</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">res</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">names</span><span class="p">)</span> <span class="ow">in</span> <span class="n">res_molecules</span><span class="p">:</span>
                    <span class="n">counts</span><span class="p">[</span><span class="n">res_molecules</span><span class="p">[(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">names</span><span class="p">)]]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">res_molecules</span><span class="p">[(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">names</span><span class="p">)]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">structs</span><span class="p">)</span>
            <span class="n">is_duplicate</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">struct</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">structs</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">sel</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a2</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                                <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">a2</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">elif</span> <span class="n">a1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">a1</span><span class="o">.</span><span class="n">type</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">a2</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">break</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">a1</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">a2</span><span class="o">.</span><span class="n">type</span><span class="p">:</span> <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">counts</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="n">is_duplicate</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_duplicate</span><span class="p">:</span>
                <span class="n">mol</span> <span class="o">=</span> <span class="bp">self</span><span class="p">[[</span><span class="n">atom</span><span class="o">.</span><span class="n">marked</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">mol</span><span class="p">),</span> <span class="n">mol</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">mol</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                               <span class="n">mol</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
                    <span class="n">mol</span> <span class="o">=</span> <span class="n">s</span>
                <span class="n">structs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">structs</span><span class="p">,</span> <span class="n">counts</span><span class="p">))</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.save"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">format</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the current Structure in the requested file format. Supported</span>
<span class="sd">        formats can be specified explicitly or determined by file-name</span>
<span class="sd">        extension. The following formats are supported, with the recognized</span>
<span class="sd">        suffix and ``format`` keyword shown in parentheses:</span>

<span class="sd">            - PDB (.pdb, pdb)</span>
<span class="sd">            - PDBx/mmCIF (.cif, cif)</span>
<span class="sd">            - PQR (.pqr, pqr)</span>
<span class="sd">            - Amber topology file (.prmtop/.parm7, amber)</span>
<span class="sd">            - CHARMM PSF file (.psf, charmm)</span>
<span class="sd">            - CHARMM coordinate file (.crd, charmmcrd)</span>
<span class="sd">            - Gromacs topology file (.top, gromacs)</span>
<span class="sd">            - Gromacs GRO file (.gro, gro)</span>
<span class="sd">            - Mol2 file (.mol2, mol2)</span>
<span class="sd">            - Mol3 file (.mol3, mol3)</span>
<span class="sd">            - Amber ASCII restart (.rst7/.inpcrd/.restrt, rst7)</span>
<span class="sd">            - Amber NetCDF restart (.ncrst, ncrst)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fname : str</span>
<span class="sd">            Name of the file to save. If ``format`` is ``None`` (see below), the</span>
<span class="sd">            file type will be determined based on the filename extension. If the</span>
<span class="sd">            type cannot be determined, a ValueError is raised.</span>
<span class="sd">        format : str, optional</span>
<span class="sd">            The case-insensitive keyword specifying what type of file ``fname``</span>
<span class="sd">            should be saved as. If ``None`` (default), the file type will be</span>
<span class="sd">            determined from filename extension of ``fname``</span>
<span class="sd">        overwrite : bool, optional</span>
<span class="sd">            If True, allow the target file to be overwritten. Otherwise, an</span>
<span class="sd">            IOError is raised if the file exists. Default is False</span>
<span class="sd">        kwargs : keyword-arguments</span>
<span class="sd">            Remaining arguments are passed on to the file writing routines that</span>
<span class="sd">            are called by this function</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError if either filename extension or ``format`` are not recognized</span>
<span class="sd">        TypeError if the structure cannot be converted to the desired format for</span>
<span class="sd">        whatever reason</span>
<span class="sd">        IOError if the file cannot be written either because it exists and</span>
<span class="sd">        ``overwrite`` is ``False``, the filesystem is read-only, or write</span>
<span class="sd">        permissions are not granted for the user</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed</span> <span class="kn">import</span> <span class="n">amber</span><span class="p">,</span> <span class="n">charmm</span><span class="p">,</span> <span class="n">formats</span><span class="p">,</span> <span class="n">gromacs</span>
        <span class="n">extmap</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;.pdb&#39;</span> <span class="p">:</span> <span class="s">&#39;PDB&#39;</span><span class="p">,</span>
                <span class="s">&#39;.pqr&#39;</span> <span class="p">:</span> <span class="s">&#39;PQR&#39;</span><span class="p">,</span>
                <span class="s">&#39;.cif&#39;</span> <span class="p">:</span> <span class="s">&#39;CIF&#39;</span><span class="p">,</span>
                <span class="s">&#39;.pdbx&#39;</span> <span class="p">:</span> <span class="s">&#39;CIF&#39;</span><span class="p">,</span>
                <span class="s">&#39;.parm7&#39;</span> <span class="p">:</span> <span class="s">&#39;AMBER&#39;</span><span class="p">,</span>
                <span class="s">&#39;.prmtop&#39;</span> <span class="p">:</span> <span class="s">&#39;AMBER&#39;</span><span class="p">,</span>
                <span class="s">&#39;.psf&#39;</span> <span class="p">:</span> <span class="s">&#39;PSF&#39;</span><span class="p">,</span>
                <span class="s">&#39;.top&#39;</span> <span class="p">:</span> <span class="s">&#39;GROMACS&#39;</span><span class="p">,</span>
                <span class="s">&#39;.gro&#39;</span> <span class="p">:</span> <span class="s">&#39;GRO&#39;</span><span class="p">,</span>
                <span class="s">&#39;.mol2&#39;</span> <span class="p">:</span> <span class="s">&#39;MOL2&#39;</span><span class="p">,</span>
                <span class="s">&#39;.mol3&#39;</span> <span class="p">:</span> <span class="s">&#39;MOL3&#39;</span><span class="p">,</span>
                <span class="s">&#39;.crd&#39;</span> <span class="p">:</span> <span class="s">&#39;CHARMMCRD&#39;</span><span class="p">,</span>
                <span class="s">&#39;.rst7&#39;</span> <span class="p">:</span> <span class="s">&#39;RST7&#39;</span><span class="p">,</span>
                <span class="s">&#39;.inpcrd&#39;</span> <span class="p">:</span> <span class="s">&#39;RST7&#39;</span><span class="p">,</span>
                <span class="s">&#39;.restrt&#39;</span> <span class="p">:</span> <span class="s">&#39;RST7&#39;</span><span class="p">,</span>
                <span class="s">&#39;.ncrst&#39;</span> <span class="p">:</span> <span class="s">&#39;NCRST&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c"># Basically everybody uses atom type names instead of type indexes. So</span>
        <span class="c"># convert to atom type names and switch back if need be</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> exists; not overwriting&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
        <span class="n">all_ints</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">all_ints</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">format</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;.bz2&#39;</span><span class="p">,</span> <span class="s">&#39;.gz&#39;</span><span class="p">):</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ext</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">format</span> <span class="o">=</span> <span class="n">extmap</span><span class="p">[</span><span class="n">ext</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Could not determine file type of </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">fname</span><span class="p">)</span>
            <span class="c"># Dispatch</span>
            <span class="k">if</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;PDB&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;CIF&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_cif</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;PQR&#39;</span><span class="p">:</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">PQRFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;PSF&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_psf</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;GRO&#39;</span><span class="p">:</span>
                <span class="n">gromacs</span><span class="o">.</span><span class="n">GromacsGroFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;MOL2&#39;</span><span class="p">:</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">Mol2File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;MOL3&#39;</span><span class="p">:</span>
                <span class="n">formats</span><span class="o">.</span><span class="n">Mol2File</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">mol3</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;GROMACS&#39;</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">gromacs</span><span class="o">.</span><span class="n">GromacsTopologyFile</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">s</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;CHARMMCRD&#39;</span><span class="p">:</span>
                <span class="n">charmm</span><span class="o">.</span><span class="n">CharmmCrdFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="o">==</span> <span class="s">&#39;AMBER&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">):</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">amber</span><span class="o">.</span><span class="n">AmoebaParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">amber</span><span class="o">.</span><span class="n">ChamberParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">amber</span><span class="o">.</span><span class="n">AmberParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s">&#39;Cannot translate exceptions&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                            <span class="n">s</span> <span class="o">=</span> <span class="n">amber</span><span class="o">.</span><span class="n">ChamberParm</span><span class="o">.</span><span class="n">from_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="n">s</span><span class="o">.</span><span class="n">write_parm</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">format</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;RST7&#39;</span><span class="p">,</span> <span class="s">&#39;NCRST&#39;</span><span class="p">):</span>
                <span class="n">rst7</span> <span class="o">=</span> <span class="n">amber</span><span class="o">.</span><span class="n">Rst7</span><span class="p">(</span><span class="n">natom</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">coordinates</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span>
                <span class="n">rst7</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">netcdf</span><span class="o">=</span><span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="s">&#39;NCRST&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No file type matching </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">format</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">all_ints</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">combining_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combining_rule</span>

    <span class="nd">@combining_rule.setter</span>
<div class="viewcode-block" id="Structure.combining_rule"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.combining_rule">[docs]</a>    <span class="k">def</span> <span class="nf">combining_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">thing</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;lorentz&#39;</span><span class="p">,</span> <span class="s">&#39;geometric&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;combining_rule must be &#39;lorentz&#39; or &#39;geometric&#39;&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_combining_rule</span> <span class="o">=</span> <span class="n">thing</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.topology"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.topology">[docs]</a>    <span class="k">def</span> <span class="nf">topology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The OpenMM Topology object. Cached when possible, but any changes to the</span>
<span class="sd">        Structure instance results in the topology being deleted and rebuilt</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function calls ``prune_empty_terms`` if any topology lists have</span>
<span class="sd">        changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_changed</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span> <span class="o">=</span> <span class="n">top</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chain</span>
            <span class="n">last_residue</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">last_omm_residue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c"># Empty topology</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span>
        <span class="c"># Add the atoms</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="c"># See if we need to add a new residue</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">last_residue</span><span class="p">:</span>
                <span class="c"># See if we need a new chain</span>
                <span class="k">if</span> <span class="n">last_chain</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span>
                    <span class="n">last_chain</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span>
                    <span class="n">chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
                <span class="n">last_residue</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
                <span class="n">last_omm_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">getByAtomicNumber</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">top</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">last_omm_residue</span><span class="p">)</span>
        <span class="c"># Add the bonds</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">top</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
        <span class="c"># Set the unit cell dimensions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">top</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span>
                    <span class="n">reducePeriodicBoxVectors</span><span class="p">(</span>
                        <span class="n">box_lengths_and_angles_to_vectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
                    <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">top</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic positions for every atom in the system. If set with unitless</span>
<span class="sd">        numbers, those numbers are assumed to be in angstroms. If any atoms do</span>
<span class="sd">        not have coordinates, this is simply ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Vec3</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@positions.setter</span>
<div class="viewcode-block" id="Structure.positions"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.positions">[docs]</a>    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic positions for every atom in the system. If set with unitless</span>
<span class="sd">        numbers, those numbers are assumed to be in angstroms.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError if the positions are not either a (natom, 3)-shape iterable</span>
<span class="sd">        of iterables or a (natom*3)-length iterable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="c"># See if the array is flattened</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="c"># It had better all be 3-length iterables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong shape for position array&#39;</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>

    <span class="nd">@coordinates.setter</span>
<div class="viewcode-block" id="Structure.coordinates"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setting coordinates will also set xx, xy, and xz on the atoms &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># Wipe out coordinates</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">xyz</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="n">coords</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># We set coordinates to an empty iterable. Wipe them out here</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
</div>
<div class="viewcode-block" id="Structure.get_coordinates"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.get_coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In some cases, multiple conformations may be stored in the Structure.</span>
<span class="sd">        This function retrieves a particular frame&#39;s coordinates</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frame : int or &#39;all&#39;, optional</span>
<span class="sd">            The frame number whose coordinates should be retrieved. Default is</span>
<span class="sd">            &#39;all&#39;</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        coords : np.ndarray, shape([#,] natom, 3) or None</span>
<span class="sd">            If frame is &#39;all&#39;, all coordinates are returned with shape</span>
<span class="sd">            (#, natom, 3). Otherwise the requested frame is returned with shape</span>
<span class="sd">            (natom, 3). If no coordinates exist and &#39;all&#39; is requested, None is</span>
<span class="sd">            returned</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        IndexError if there are fewer than ``frame`` coordinates</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span>
        <span class="c"># Wipe out our existing coordinates if we think anything might have</span>
        <span class="c"># changed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">coords</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">coords</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">SMALL</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span>
            <span class="k">elif</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">coords</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">coords</span>
            <span class="c"># Requested NOT the first frame</span>
            <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s">&#39;No coordinate frames present&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">[</span><span class="n">frame</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span>

    <span class="nd">@box.setter</span>
<div class="viewcode-block" id="Structure.box"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.box">[docs]</a>    <span class="k">def</span> <span class="nf">box</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">box</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">box</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">box</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Box information must be 6 floats&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
                    <span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
            <span class="n">box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">subok</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">box</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Box information must be 6 floats&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">box</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A (natom, 3)-shape numpy array with atomic velocities for every atom in</span>
<span class="sd">        the system (in units of angstrom/picosecond), or None if there are no</span>
<span class="sd">        velocities</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">vz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="nd">@velocities.setter</span>
<div class="viewcode-block" id="Structure.velocities"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.velocities">[docs]</a>    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic velocities for every atom in the system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">picoseconds</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">atom</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vz</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">atom</span><span class="p">,</span> <span class="n">xyz</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="n">xyz</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.has_NBFIX"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.has_NBFIX">[docs]</a>    <span class="k">def</span> <span class="nf">has_NBFIX</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns whether or not any pairs of atom types have their LJ</span>
<span class="sd">        interactions modified by an NBFIX definition</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        has_nbfix : bool</span>
<span class="sd">            If True, at least two atom types have NBFIX mod definitions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">typemap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">atom_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">typemap</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">atom_type</span><span class="p">)]</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">atom_type</span>
        <span class="c"># Now we have a map of all atom types that we have defined in our</span>
        <span class="c"># system. Look through all of the atom types and see if any of their</span>
        <span class="c"># NBFIX definitions are also keys in typemap</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="nb">type</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">typemap</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">type</span><span class="o">.</span><span class="n">nbfix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">typemap</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        3, 3-element tuple of unit cell vectors that are Quantity objects of</span>
<span class="sd">        dimension length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">box_lengths_and_angles_to_vectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>

    <span class="nd">@box_vectors.setter</span>
<div class="viewcode-block" id="Structure.box_vectors"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.box_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        3, 3-element tuple of unit cell vectors that are Quantity objects of</span>
<span class="sd">        dimension length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">=</span> <span class="n">box_vectors_to_lengths_and_angles</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">G</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.createSystem"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.createSystem">[docs]</a>    <span class="k">def</span> <span class="nf">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">8.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                     <span class="n">switchDistance</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                     <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">rigidWater</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">implicitSolvent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">implicitSolventSaltConc</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liters</span><span class="p">,</span>
                     <span class="n">temperature</span><span class="o">=</span><span class="mf">298.15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                     <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                     <span class="n">useSASA</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">removeCMMotion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">hydrogenMass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                     <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">forceNBFIX</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct an OpenMM System representing the topology described by the</span>
<span class="sd">        prmtop file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating point number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff.</span>
<span class="sd">        switchDistance : float or distance Quantity</span>
<span class="sd">            The distance at which the switching function is turned on for van</span>
<span class="sd">            der Waals interactions. This is ignored when no cutoff is used, and</span>
<span class="sd">            no switch is used if switchDistance is 0, negative, or greater than</span>
<span class="sd">            the cutoff</span>
<span class="sd">        constraints : None, app.HBonds, app.HAngles, or app.AllBonds</span>
<span class="sd">            Which type of constraints to add to the system (e.g., SHAKE). None</span>
<span class="sd">            means no bonds are constrained. HBonds means bonds with hydrogen are</span>
<span class="sd">            constrained</span>
<span class="sd">        rigidWater : bool=True</span>
<span class="sd">            If True, water is kept rigid regardless of the value of constraints.</span>
<span class="sd">            A value of False is ignored if constraints is not None.</span>
<span class="sd">        implicitSolvent : None, app.HCT, app.OBC1, app.OBC2, app.GBn, app.GBn2</span>
<span class="sd">            The Generalized Born implicit solvent model to use.</span>
<span class="sd">        implicitSolventKappa : float or 1/distance Quantity = None</span>
<span class="sd">            This is the Debye kappa property related to modeling saltwater</span>
<span class="sd">            conditions in GB. It should have units of 1/distance (1/nanometers</span>
<span class="sd">            is assumed if no units present). A value of None means that kappa</span>
<span class="sd">            will be calculated from implicitSolventSaltConc (below)</span>
<span class="sd">        implicitSolventSaltConc : float or amount/volume Quantity=0 moles/liter</span>
<span class="sd">            If implicitSolventKappa is None, the kappa will be computed from the</span>
<span class="sd">            salt concentration. It should have units compatible with mol/L</span>
<span class="sd">        temperature : float or temperature Quantity = 298.15 kelvin</span>
<span class="sd">            This is only used to compute kappa from implicitSolventSaltConc</span>
<span class="sd">        soluteDielectric : float=1.0</span>
<span class="sd">            The dielectric constant of the protein interior used in GB</span>
<span class="sd">        solventDielectric : float=78.5</span>
<span class="sd">            The dielectric constant of the water used in GB</span>
<span class="sd">        useSASA : bool=False</span>
<span class="sd">            If True, use the ACE non-polar solvation model. Otherwise, use no</span>
<span class="sd">            SASA-based nonpolar solvation model.</span>
<span class="sd">        removeCMMotion : bool=True</span>
<span class="sd">            If True, the center-of-mass motion will be removed periodically</span>
<span class="sd">            during the simulation. If False, it will not.</span>
<span class="sd">        hydrogenMass : float or mass quantity = None</span>
<span class="sd">            If not None, hydrogen masses will be changed to this mass and the</span>
<span class="sd">            difference subtracted from the attached heavy atom (hydrogen mass</span>
<span class="sd">            repartitioning)</span>
<span class="sd">        ewaldErrorTolerance : float=0.0005</span>
<span class="sd">            When using PME or Ewald, the Ewald parameters will be calculated</span>
<span class="sd">            from this value</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If False, the energies and forces from the constrained degrees of</span>
<span class="sd">            freedom will NOT be computed. If True, they will (but those degrees</span>
<span class="sd">            of freedom will *still* be constrained).</span>
<span class="sd">        verbose : bool=False</span>
<span class="sd">            If True, the progress of this subroutine will be printed to stdout</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This function calls prune_empty_terms if any Topology lists have changed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">unknown_functional</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot createSystem: unknown functional&#39;</span><span class="p">)</span>
        <span class="c"># Establish defaults</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
        <span class="c"># Make sure periodic simulations have a box</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No periodic boundary conditions detected&#39;</span><span class="p">)</span>
        <span class="c"># Do hydrogen mass repartitioning if necessary</span>
        <span class="n">masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hydrogenMass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">hydrogenMass</span><span class="p">):</span>
                <span class="n">hydrogenMass</span> <span class="o">=</span> <span class="n">hydrogenMass</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dalton</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hydrogenMass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Hydrogen mass must be positive&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">heavy_atom</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">a2</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">heavy_atom</span> <span class="o">=</span> <span class="n">a2</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">heavy_atom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">masses</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrogenMass</span>
                        <span class="n">masses</span><span class="p">[</span><span class="n">heavy_atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">hydrogenMass</span> <span class="o">-</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="n">masses</span><span class="p">:</span> <span class="n">system</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omm_add_constraints</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">)</span>
        <span class="c"># Prune empty terms if we have changed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_changed</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span>
        <span class="c"># Add the various types of forces</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding bonds...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_bond_force</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">,</span>
                                    <span class="n">flexibleConstraints</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding angles...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_angle_force</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">flexibleConstraints</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding dihedrals...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_dihedral_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding Ryckaert-Bellemans torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_rb_torsion_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding Urey-Bradleys...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_urey_bradley_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding improper torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_improper_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding CMAP torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_cmap_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding trigonal angle terms...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_trigonal_angle_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding out-of-plane bends...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_out_of_plane_bend_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding pi-torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_pi_torsion_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding stretch-bends...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_stretch_bend_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding torsion-torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_torsion_torsion_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding Nonbonded force...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rf_dielc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_dielc</span> <span class="o">=</span> <span class="mf">78.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_nonbonded_force</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span>
                                         <span class="n">switchDistance</span><span class="p">,</span><span class="n">ewaldErrorTolerance</span><span class="p">,</span>
                                         <span class="n">rf_dielc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding GB force...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omm_gbsa_force</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span>
                                        <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span>
                                        <span class="n">solventDielectric</span><span class="p">,</span> <span class="n">implicitSolventKappa</span><span class="p">,</span>
                                        <span class="n">implicitSolventSaltConc</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span>
                                        <span class="n">useSASA</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">removeCMMotion</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">(</span>
                    <span class="o">*</span><span class="n">reducePeriodicBoxVectors</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omm_set_virtual_sites</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_add_constraints"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_add_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">omm_add_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds constraints to a given system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : mm.System</span>
<span class="sd">            The OpenMM system for which constraints should be added</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            Which kind of constraints should be used</span>
<span class="sd">        rigidWater : bool</span>
<span class="sd">            If True, water bonds are constrained regardless of whether</span>
<span class="sd">            constrains is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rigidWater</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">AllBonds</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unrecognized constraints option (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                             <span class="n">constraints</span><span class="p">)</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="c"># Rigid water only</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="c"># Skip all extra points... don&#39;t constrain those</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">WATER_NAMES</span> <span class="ow">or</span>
                        <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">WATER_NAMES</span><span class="p">):</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                         <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># Other types of constraints</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span> <span class="ow">or</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">num_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_h</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
                    <span class="c"># Constrain this angle</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                            <span class="n">l1</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">*</span> <span class="n">length_conv</span>
                        <span class="k">elif</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                            <span class="n">l2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">*</span> <span class="n">length_conv</span>
                    <span class="c"># Law of cosines to find the constraint distance</span>
                    <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">l2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># no bonds found...</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">)</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l1</span><span class="o">*</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">l2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="o">*</span><span class="n">l2</span><span class="o">*</span><span class="n">cost</span><span class="p">)</span><span class="o">*</span><span class="n">length_conv</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span><span class="n">length</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_set_virtual_sites"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_set_virtual_sites">[docs]</a>    <span class="k">def</span> <span class="nf">omm_set_virtual_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the virtual sites in a given OpenMM `System` object from the extra</span>
<span class="sd">        points defined in this system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : mm.System</span>
<span class="sd">            The system for which the virtual sites will be set. All particles</span>
<span class="sd">            must have already been added to this System before calling this</span>
<span class="sd">            method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;OpenMM System does not correspond to Structure&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c"># This is a virtual site... get its frame type</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">frame_type</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
            <span class="n">refatoms</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">TwoParticleExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">TwoParticleAverageSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">ThreeParticleExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">ThreeParticleAverageSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                                    <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">OutOfPlaneSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_bond_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_bond_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_bond_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                       <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an OpenMM Bond Force object (or AmoebaBondForce if the bonds are</span>
<span class="sd">        for an Amoeba-parametrized system)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            The types of constraints that are on the system. If</span>
<span class="sd">            flexibleConstraints is False, then the constrained bonds will not be</span>
<span class="sd">            added to the resulting Force</span>
<span class="sd">        rigidWater : bool=True</span>
<span class="sd">            Should water-H bonds be constrained regardless of `constraints`?</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If True, all bonds are added to the force regardless of</span>
<span class="sd">            `constraints`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force</span>
<span class="sd">            HarmonicBondForce (or AmoebaBondForce if this is an Amoeba system),</span>
<span class="sd">            or None if there are no bonds to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flexibleConstraints</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">AllBonds</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span> <span class="c"># No bonds to add</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">_ambfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">_ommfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">_ambfrc</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">_ommfrc</span><span class="p">)</span>
        <span class="c"># See if we need to add Amoeba bonds or regular bonds</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaBondForce</span><span class="p">()</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setGlobalBondCubic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">length_conv</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setGlobalBondQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">length_conv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BOND_FORCE_GROUP</span><span class="p">)</span>
        <span class="c"># Add the bonds</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">flexibleConstraints</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find necessary parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                          <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="c"># Done adding the force</span>
        <span class="k">if</span> <span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_angle_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_angle_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_angle_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an OpenMM HarmonicAngleForce object (or AmoebaAngleForce if the</span>
<span class="sd">        angles are for an Amoeba-parametrized system)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            The types of constraints that are on the system. If</span>
<span class="sd">            flexibleConstraints is False, then the constrained bonds will not be</span>
<span class="sd">            added to the resulting Force</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If True, all bonds are added to the force regardless of</span>
<span class="sd">            `constraints`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force</span>
<span class="sd">            HarmonicAngleForce (or AmoebaAngleForce if this is an Amoeba</span>
<span class="sd">            system), or None if there are no angles to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">coeffs</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaAngleForce</span><span class="p">()</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAnglePentic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicAngleForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ANGLE_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">num_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flexibleConstraints</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find angle parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                           <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span><span class="o">.</span><span class="n">getNumAngles</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_dihedral_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_dihedral_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_dihedral_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM PeriodicTorsionForce modeling dihedrals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PeriodicTorsionForce</span>
<span class="sd">            Or None if no torsions are present in this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DIHEDRAL_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find torsion parameters&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="n">tor</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">per</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">phase</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">,</span>
                                     <span class="n">typ</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                 <span class="n">tor</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span><span class="p">),</span>
                                 <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">,</span>
                                 <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_rb_torsion_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_rb_torsion_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_rb_torsion_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM RBTorsionForce for Ryckaert-Bellemans torsions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        RBTorsionForce</span>
<span class="sd">            Or None if no torsions are present in this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">RBTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RB_TORSION_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find R-B torsion parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">tor</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c0</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c1</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                             <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c2</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c3</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span>
                             <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c4</span><span class="o">*</span><span class="n">conv</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">c5</span><span class="o">*</span><span class="n">conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_urey_bradley_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_urey_bradley_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_urey_bradley_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM Urey-Bradley force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        HarmonicBondForce</span>
<span class="sd">            Or None, if no urey-bradleys are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">_ambfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">_ommfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">_ambfrc</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">_ommfrc</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UREY_BRADLEY_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">urey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">urey</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find urey-bradley parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">urey</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">urey</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                          <span class="n">urey</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">urey</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_improper_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_improper_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_improper_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM improper torsion force (quadratic bias)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CustomTorsionForce</span>
<span class="sd">            With the formula k*(phi-phi0)^2, or None if there are no impropers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomTorsionForce</span><span class="p">(</span><span class="s">&quot;k*(theta-theta0)^2&quot;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s">&#39;theta0&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IMPROPER_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imp</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find improper torsion &#39;</span>
                                       <span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">,</span>
                             <span class="n">imp</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_eq</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_cmap_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_cmap_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_cmap_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM CMAP torsion force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CMAPTorsionForce</span>
<span class="sd">            Or None, if no CMAP terms are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CMAPTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CMAP_FORCE_GROUP</span><span class="p">)</span>
        <span class="c"># First get the list of cmap maps we&#39;re going to use. Just store the IDs</span>
        <span class="c"># so we have simple integer comparisons to do later</span>
        <span class="n">cmap_type_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cmap_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmap</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Cannot find CMAP torsion parameters&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cmap_type_list</span><span class="p">:</span>
                <span class="n">ct</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">type</span>
                <span class="n">cmap_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
                <span class="c"># OpenMM takes the correction maps in the range 0 to 360</span>
                <span class="c"># degrees, but we store it in -180 -- 180 (and in the transpose</span>
                <span class="c"># of what OpenMM expects).</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">switch_range</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">addMap</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">frc_conv</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">])</span>
                <span class="n">cmap_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">ct</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="c"># Now add all of the cmaps</span>
        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">cmap_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">type</span><span class="p">)],</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_nonbonded_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_nonbonded_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_nonbonded_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">switchDistance</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                            <span class="n">reactionFieldDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM NonbondedForce instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating point number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff.</span>
<span class="sd">        switchDistance : float or distance Quantity</span>
<span class="sd">            The distance at which the switching function is turned on for van</span>
<span class="sd">            der Waals interactions. This is ignored when no cutoff is used, and</span>
<span class="sd">            no switch is used if switchDistance is 0, negative, or greater than</span>
<span class="sd">            the cutoff</span>
<span class="sd">        ewaldErrorTolerance : float=0.0005</span>
<span class="sd">            When using PME or Ewald, the Ewald parameters will be calculated</span>
<span class="sd">            from this value</span>
<span class="sd">        reactionFieldDielectric : float=78.5</span>
<span class="sd">            If the nonbondedMethod is CutoffPeriodic or CutoffNonPeriodic, the</span>
<span class="sd">            region beyond the cutoff is treated using a reaction field method</span>
<span class="sd">            with this dielectric constant. It should be set to 1 if another</span>
<span class="sd">            implicit solvent model is being used (e.g., GB)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NonbondedForce</span>
<span class="sd">            This just implements the very basic NonbondedForce with the typical</span>
<span class="sd">            charge-charge and 12-6 Lennard-Jones interactions with the</span>
<span class="sd">            Lorentz-Berthelot combining rules.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This method calls update_dihedral_exclusions, which might alter the</span>
<span class="sd">        ``ignore_end`` attribute of some</span>
<span class="sd">        :class:`parmed.topologyobjects.Dihedral` instances based on any</span>
<span class="sd">        changes that might have been made to the bonds and angles since the last</span>
<span class="sd">        time it was called.</span>

<span class="sd">        Subclasses of Structure for which this nonbonded treatment is inadequate</span>
<span class="sd">        should override this method to implement what is needed.</span>

<span class="sd">        If nrexcl is set to 3 and no exception parameters are stored in the</span>
<span class="sd">        adjusts list, the 1-4 interactions are determined from the list of</span>
<span class="sd">        dihedrals</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">):</span>
            <span class="n">nonbondedCutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">PME</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="n">ewaldErrorTolerance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">Ewald</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="n">ewaldErrorTolerance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized nonbondedMethod (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setReactionFieldDielectric</span><span class="p">(</span><span class="n">reactionFieldDielectric</span><span class="p">)</span>
        <span class="c"># Now add the particles</span>
        <span class="n">sigma_scale</span> <span class="o">=</span> <span class="n">length_conv</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                              <span class="nb">abs</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">ene_conv</span><span class="p">))</span>
        <span class="c"># Add exclusions from the bond graph out to nrexcl-1 bonds away (atoms</span>
        <span class="c"># nrexcl bonds away will be exceptions defined later)</span>
        <span class="k">def</span> <span class="nf">exclude_to</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">level</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">:</span> <span class="k">return</span>
            <span class="k">for</span> <span class="n">partner</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">partner</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span> <span class="c"># Handled later</span>
                <span class="k">if</span> <span class="n">partner</span> <span class="ow">is</span> <span class="n">origin</span><span class="p">:</span> <span class="k">continue</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">origin</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="c"># Exclude EP children, too</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">origin</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">partner</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                       <span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">partner</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">origin</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
                                       <span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">origin</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">child2</span> <span class="ow">in</span> <span class="n">partner</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">child2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
                                           <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="n">exclude_to</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">partner</span><span class="p">,</span> <span class="n">level</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span> <span class="c"># Handled separately</span>
            <span class="n">exclude_to</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrexcl</span><span class="p">)</span>
        <span class="c"># Add the exceptions from the dihedral list IFF no explicit exceptions</span>
        <span class="c"># (or *adjusts*) have been specified. If dihedral.ignore_end is False, a</span>
        <span class="c"># 1-4 with the appropriate scaling factor is used as the exception.</span>
        <span class="n">sigma_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_conv</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s">&#39;lorentz&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sig1</span> <span class="o">+</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="n">comb_sig</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">sig1</span><span class="p">,</span> <span class="n">sig2</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sig1</span> <span class="o">*</span> <span class="n">sig2</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dih</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dih</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">scee</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">scnb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                        <span class="n">scee</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scee</span>
                        <span class="n">scnb</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scnb</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">scee</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">scnb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Detected scaling constants of 0 for &#39;</span>
                                         <span class="s">&#39;dihedral containing 1-4 info!&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                    <span class="n">scnb</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rij</span><span class="p">,</span> <span class="n">wdij</span><span class="p">,</span> <span class="n">rij14</span><span class="p">,</span> <span class="n">wdij14</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">nbfix</span><span class="p">[</span>
                                                    <span class="nb">str</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">atom_type</span><span class="p">)]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                    <span class="n">sigprod</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span>
                    <span class="n">sigprod</span> <span class="o">*=</span> <span class="n">length_conv</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="n">wdij14</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                    <span class="n">sigprod</span> <span class="o">=</span> <span class="n">rij14</span> <span class="o">*</span> <span class="n">length_conv</span> <span class="o">*</span> <span class="n">sigma_scale</span>
                <span class="n">chgprod</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">scee</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span>
                                   <span class="n">sigprod</span><span class="p">,</span> <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                    <span class="n">sigprod</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span>
                    <span class="n">sigprod</span> <span class="o">*=</span> <span class="n">length_conv</span>
                    <span class="n">chgprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">charge</span><span class="p">)</span> <span class="o">/</span> <span class="n">scee</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span>
                                       <span class="n">sigprod</span><span class="p">,</span> <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                    <span class="n">sigprod</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span>
                    <span class="n">sigprod</span> <span class="o">*=</span> <span class="n">length_conv</span>
                    <span class="n">chgprod</span> <span class="o">=</span> <span class="n">child</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">scee</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span>
                                       <span class="n">sigprod</span><span class="p">,</span> <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">c2</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                        <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                        <span class="n">sigprod</span> <span class="o">=</span> <span class="n">comb_sig</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">sigma_14</span><span class="p">)</span>
                        <span class="n">sigprod</span> <span class="o">*=</span> <span class="n">length_conv</span>
                        <span class="n">chgprod</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">c2</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">scee</span>
                        <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span> <span class="n">sigprod</span><span class="p">,</span>
                                           <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="c"># Allow our specific exceptions (in adjusts) to override anything that</span>
        <span class="c"># came before</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="n">chgprod</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">chgscale</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">pair</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">pair</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span>
                               <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                               <span class="n">pair</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">ene_conv</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="c"># Any exclusion partners we already added will zero-out existing</span>
        <span class="c"># exclusions/exceptions</span>
        <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">exclusion_partners</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">switchDistance</span> <span class="ow">and</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">switchDistance</span><span class="p">):</span>
                <span class="n">switchDistance</span> <span class="o">=</span> <span class="n">switchDistance</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">switchDistance</span> <span class="o">&lt;</span> <span class="n">nonbondedCutoff</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">switchDistance</span><span class="p">)</span>

        <span class="c"># Now see if we have any NBFIXes that we need to implement via a</span>
        <span class="c"># CustomNonbondedForce</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">combining_rule</span> <span class="o">==</span> <span class="s">&#39;geometric&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">():</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omm_nbfixed_force</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_omm_geometric_force</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omm_geometric_force</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_NBFIX</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">force</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_omm_nbfixed_force</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">_omm_nbfixed_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbfrc</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Private method for creating a CustomNonbondedForce with a lookup</span>
<span class="sd">        table. This should not be called by users -- you have been warned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbfrc : NonbondedForce</span>
<span class="sd">            NonbondedForce for the &quot;standard&quot; nonbonded interactions. This will</span>
<span class="sd">            be modified (specifically, L-J ixns will be zeroed)</span>
<span class="sd">        nonbondedMethod : Nonbonded Method (e.g., NoCutoff, PME, etc.)</span>
<span class="sd">            The nonbonded method to apply here. Ewald and PME will be</span>
<span class="sd">            interpreted as CutoffPeriodic for the CustomNonbondedForce.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force : CustomNonbondedForce</span>
<span class="sd">            The L-J force with NBFIX implemented as a lookup table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="c"># We need a CustomNonbondedForce to implement the NBFIX functionality.</span>
        <span class="c"># First derive the type lookup tables</span>
        <span class="n">lj_idx_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="n">lj_radii</span><span class="p">,</span> <span class="n">lj_depths</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="n">num_lj_types</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lj_type_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">atype</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">atom_type</span>
            <span class="k">if</span> <span class="n">lj_idx_list</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span> <span class="c"># already assigned</span>
            <span class="n">num_lj_types</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">lj_idx_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_lj_types</span>
            <span class="n">ljtype</span> <span class="o">=</span> <span class="p">(</span><span class="n">atype</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atype</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
            <span class="n">lj_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atype</span><span class="p">)</span>
            <span class="n">lj_radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atype</span><span class="o">.</span><span class="n">rmin</span><span class="p">)</span>
            <span class="n">lj_depths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">atype</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)):</span>
                <span class="n">atype2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">atom_type</span>
                <span class="k">if</span> <span class="n">lj_idx_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># already assigned</span>
                <span class="k">if</span> <span class="n">atype2</span> <span class="ow">is</span> <span class="n">atype</span><span class="p">:</span>
                    <span class="n">lj_idx_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_lj_types</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">atype</span><span class="o">.</span><span class="n">nbfix</span><span class="p">:</span>
                    <span class="c"># Only non-NBFIXed atom types can be compressed</span>
                    <span class="n">ljtype2</span> <span class="o">=</span> <span class="p">(</span><span class="n">atype2</span><span class="o">.</span><span class="n">rmin</span><span class="p">,</span> <span class="nb">abs</span><span class="p">(</span><span class="n">atype2</span><span class="o">.</span><span class="n">epsilon</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">ljtype</span> <span class="o">==</span> <span class="n">ljtype2</span><span class="p">:</span>
                        <span class="n">lj_idx_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">num_lj_types</span>
        <span class="c"># Now everything is assigned. Create the A- and B-coefficient arrays</span>
        <span class="n">acoef</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lj_types</span><span class="o">*</span><span class="n">num_lj_types</span><span class="p">)]</span>
        <span class="n">bcoef</span> <span class="o">=</span> <span class="n">acoef</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lj_types</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_lj_types</span><span class="p">):</span>
                <span class="n">namej</span> <span class="o">=</span> <span class="n">lj_type_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rij</span><span class="p">,</span> <span class="n">wdij</span><span class="p">,</span> <span class="n">rij14</span><span class="p">,</span> <span class="n">wdij14</span> <span class="o">=</span> <span class="n">lj_type_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">nbfix</span><span class="p">[</span><span class="n">namej</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">rij</span> <span class="o">=</span> <span class="p">(</span><span class="n">lj_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">lj_radii</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">length_conv</span>
                    <span class="n">wdij</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lj_depths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lj_depths</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">*</span> <span class="n">ene_conv</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rij</span> <span class="o">*=</span> <span class="n">length_conv</span>
                    <span class="n">wdij</span> <span class="o">*=</span> <span class="n">ene_conv</span>
                <span class="n">rij6</span> <span class="o">=</span> <span class="n">rij</span><span class="o">**</span><span class="mi">6</span>
                <span class="n">acoef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">num_lj_types</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">wdij</span><span class="p">)</span> <span class="o">*</span> <span class="n">rij6</span>
                <span class="n">bcoef</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">num_lj_types</span><span class="o">*</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">wdij</span> <span class="o">*</span> <span class="n">rij6</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s">&#39;(a/r6)^2-b/r6; r6=r2*r2*r2; r2=r^2; &#39;</span>
                                        <span class="s">&#39;a=acoef(type1, type2); &#39;</span>
                                        <span class="s">&#39;b=bcoef(type1, type2)&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s">&#39;acoef&#39;</span><span class="p">,</span>
                <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">num_lj_types</span><span class="p">,</span> <span class="n">num_lj_types</span><span class="p">,</span> <span class="n">acoef</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addTabulatedFunction</span><span class="p">(</span><span class="s">&#39;bcoef&#39;</span><span class="p">,</span>
                <span class="n">mm</span><span class="o">.</span><span class="n">Discrete2DFunction</span><span class="p">(</span><span class="n">num_lj_types</span><span class="p">,</span> <span class="n">num_lj_types</span><span class="p">,</span> <span class="n">bcoef</span><span class="p">))</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span> <span class="ow">or</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span> <span class="ow">or</span>
                <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized nonbonded method [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="c"># Add the particles</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">lj_idx_list</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,))</span>
        <span class="c"># Now wipe out the L-J parameters in the nonbonded force</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="n">chg</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nonbfrc</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chg</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c"># Now transfer the exclusions</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="c"># Now transfer the other properties (cutoff, switching function, etc.)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unsupported nonbonded method </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">():</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_omm_geometric_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbfrc</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Private method for creating a CustomNonbondedForce with a lookup</span>
<span class="sd">        table. This should not be called by users -- you have been warned.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbfrc : NonbondedForce</span>
<span class="sd">            NonbondedForce for the &quot;standard&quot; nonbonded interactions. This will</span>
<span class="sd">            be modified (specifically, L-J ixns will be zeroed)</span>
<span class="sd">        nonbondedMethod : Nonbonded Method (e.g., NoCutoff, PME, etc.)</span>
<span class="sd">            The nonbonded method to apply here. Ewald and PME will be</span>
<span class="sd">            interpreted as CutoffPeriodic for the CustomNonbondedForce.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force : CustomNonbondedForce</span>
<span class="sd">            The L-J force with NBFIX implemented as a lookup table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="c"># We need a CustomNonbondedForce to implement the geometric combining</span>
        <span class="c"># rules</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="p">(</span><span class="s">&#39;eps1*eps2*(sigr6^2-sigr6); &#39;</span>
                                        <span class="s">&#39;sigr6=sigr2*sigr2*sigr2; &#39;</span>
                                        <span class="s">&#39;sigr2=(sigc/r)^2; sigc=sig1*sig2&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&#39;eps&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerParticleParameter</span><span class="p">(</span><span class="s">&#39;sig&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span> <span class="ow">or</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span> <span class="ow">or</span>
                <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized nonbonded method [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="c"># Add the particles</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">eps</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">ene_conv</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">sigma</span><span class="o">*</span><span class="n">length_conv</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">((</span><span class="n">eps</span><span class="p">,</span> <span class="n">sig</span><span class="p">))</span>
        <span class="c"># Now wipe out the L-J parameters in the nonbonded force</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()):</span>
            <span class="n">chg</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">eps</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">nonbfrc</span><span class="o">.</span><span class="n">setParticleParameters</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">chg</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="c"># Now transfer the exclusions</span>
        <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getNumExceptions</span><span class="p">()):</span>
            <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">ee</span> <span class="o">=</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getExceptionParameters</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addExclusion</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
        <span class="c"># Now transfer the other properties (cutoff, switching function, etc.)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setUseLongRangeCorrection</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomNonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unsupported nonbonded method </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getCutoffDistance</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nonbfrc</span><span class="o">.</span><span class="n">getUseSwitchingFunction</span><span class="p">():</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">nonbfrc</span><span class="o">.</span><span class="n">getSwitchingDistance</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>

    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_gbsa_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_gbsa_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_gbsa_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">,</span>
                       <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                       <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                       <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">implicitSolventSaltConc</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liter</span><span class="p">,</span>
                       <span class="n">temperature</span><span class="o">=</span><span class="mf">298.15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                       <span class="n">useSASA</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Generalized Born force for running implicit solvent</span>
<span class="sd">        calculations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        implicitSolvent : app.HCT, app.OBC1, app.OBC2, app.GBn, app.GBn2</span>
<span class="sd">            The Generalized Born implicit solvent model to use.</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace. Default is NoCutoff</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating opint number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff</span>
<span class="sd">        implicitSolventKappa : float or 1/distance Quantity = None</span>
<span class="sd">            This is the Debye kappa property related to modeling saltwater</span>
<span class="sd">            conditions in GB. It should have units of 1/distance (1/nanometers</span>
<span class="sd">            is assumed if no units present). A value of None means that kappa</span>
<span class="sd">            will be calculated from implicitSolventSaltConc (below)</span>
<span class="sd">        implicitSolventSaltConc : float or amount/volume Quantity=0 moles/liter</span>
<span class="sd">            If implicitSolventKappa is None, the kappa will be computed from the</span>
<span class="sd">            salt concentration. It should have units compatible with mol/L</span>
<span class="sd">        temperature : float or temperature Quantity = 298.15 kelvin</span>
<span class="sd">            This is only used to compute kappa from implicitSolventSaltConc</span>
<span class="sd">        soluteDielectric : float=1.0</span>
<span class="sd">            The dielectric constant of the protein interior used in GB</span>
<span class="sd">        solventDielectric : float=78.5</span>
<span class="sd">            The dielectric constant of the water used in GB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">simtk.openmm.app.internal.customgbforces</span> <span class="kn">import</span> <span class="p">(</span><span class="n">GBSAHCTForce</span><span class="p">,</span>
                <span class="n">GBSAOBC1Force</span><span class="p">,</span> <span class="n">GBSAOBC2Force</span><span class="p">,</span> <span class="n">GBSAGBnForce</span><span class="p">,</span> <span class="n">GBSAGBn2Force</span><span class="p">,</span>
                <span class="n">convertParameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">useSASA</span><span class="p">:</span>
            <span class="n">sasa</span> <span class="o">=</span> <span class="s">&#39;ACE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sasa</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">HCT</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized implicit solvent model&#39;</span><span class="p">)</span>
        <span class="n">gb_parms</span> <span class="o">=</span> <span class="n">convertParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gb_parameters</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">),</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">implicitSolventKappa</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">implicitSolventSaltConc</span><span class="p">):</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">implicitSolventSaltConc</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liter</span><span class="p">)</span>
                <span class="n">implicitSolventSaltConc</span> <span class="o">=</span> <span class="n">sc</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">temperature</span><span class="p">):</span>
                <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">)</span>
            <span class="c"># The constant is 1 / sqrt(eps_0 * kB / (2*NA*q^2*1000)) where NA is</span>
            <span class="c"># Avogadro&#39;s number, eps_0 is the permittivity of free space, q is</span>
            <span class="c"># the charge (this # matches Amber&#39;s conversion factor)</span>
            <span class="n">implicitSolventKappa</span> <span class="o">=</span> <span class="mf">50.33355</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">implicitSolventSaltConc</span>
                                          <span class="o">/</span> <span class="n">solventDielectric</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span>
            <span class="c"># Multiply by 0.73 to account for ion exclusions, and multiply by 10</span>
            <span class="c"># to convert to 1/nm from 1/angstroms</span>
            <span class="n">implicitSolventKappa</span> <span class="o">*=</span> <span class="mf">7.3</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">implicitSolventKappa</span><span class="p">):</span>
            <span class="n">implicitSolventKappa</span> <span class="o">=</span> <span class="n">implicitSolventKappa</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">):</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HCT</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAHCTForce</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                 <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAOBC1Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAOBC2Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAGBnForce</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                 <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAGBn2Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unexpected implicit solvent model... &#39;</span>
                             <span class="s">&#39;should not be here&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">gb_parms</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c"># Set cutoff method</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># cutoff periodic (PME, CutoffPeriodic, Ewald)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>

    <span class="c"># Amoeba-specific forces below</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_trigonal_angle_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_trigonal_angle_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_trigonal_angle_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba trigonal-angle force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaInPlaneAngleForce</span>
<span class="sd">            The trigonal in-plane Angle force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Do not have the trigonal angle force &#39;</span>
                                   <span class="s">&#39;table parameters&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaInPlaneAngleForce</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">coeffs</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleQuintic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TRIGONAL_ANGLE_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Missing trigonal angle parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                           <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                           <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_out_of_plane_bend_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_out_of_plane_bend_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_out_of_plane_bend_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba out-of-plane bend force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaOutOfPlaneBendForce</span>
<span class="sd">            The out-of-plane bend Angle force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Do not have the trigonal angle force &#39;</span>
                                   <span class="s">&#39;table parameters&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaOutOfPlaneBendForce</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">coeffs</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendQuintic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUT_OF_PLANE_BEND_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Missing out-of-plane bend parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addOutOfPlaneBend</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                    <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_pi_torsion_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_pi_torsion_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_pi_torsion_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba pi-torsion force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaPiTorsionForce</span>
<span class="sd">            The pi-torsion force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaPiTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PI_TORSION_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&#39;Missing pi-torsion parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPiTorsion</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_stretch_bend_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_stretch_bend_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_stretch_bend_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the OpenMM Amoeba stretch-bend force for this system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaStretchBendForce</span>
<span class="sd">            The stretch-bend force containing all terms in this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Conversion factor taken from pyopenmm/processTinkerForceField.py</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="mf">41.84</span> <span class="c"># 4.184 * 10</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaStretchBendForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STRETCH_BEND_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">strbnd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ParameterError</span><span class="p">(</span><span class="s">&quot;Missing stretch-bend parameters&quot;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addStretchBend</span><span class="p">(</span><span class="n">strbnd</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req1</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req2</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_torsion_torsion_force"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.Structure.omm_torsion_torsion_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_torsion_torsion_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the OpenMM Amoeba coupled-torsion (CMAP) force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaTorsionTorsionForce</span>
<span class="sd">            The torsion-torsion (CMAP) force with all coupled-torsion parameters</span>
<span class="sd">            for this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Not implemented yet...</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s">&quot;Torsion-torsions not yet implemented&quot;</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">_prune_empty_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty bonds &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))):</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty angles &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">))):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">angle</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_dihedrals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty dihedrals &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">))):</span>
            <span class="n">dihed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dihed</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_rb_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty R-B torsions &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">))):</span>
            <span class="n">dihed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dihed</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_ureys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty Urey-Bradley terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">))):</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ub</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_impropers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty improper torsions &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">))):</span>
            <span class="n">imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_cmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty CMAP terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">))):</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">cmap</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_trigonal_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty trigonal angles &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">))):</span>
            <span class="n">ta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">ta</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">ta</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_out_of_plane_bends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty out-of-plane bends &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">))):</span>
            <span class="n">oop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">oop</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">oop</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">oop</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_pi_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty pi-torsions &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">))):</span>
            <span class="n">pit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pit</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom6</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pit</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_stretch_bends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty stretch-bend terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">))):</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">sb</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_torsion_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty torsion-torsion terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">))):</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">tt</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">tt</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">tt</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_chiral_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty chiral frame terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">))):</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_multipole_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty multipole frame terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">))):</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">atom</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mf</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_adjusts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty nonbonded exception adjustments &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">))):</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="nd">@needs_openmm</span>
    <span class="k">def</span> <span class="nf">_get_gb_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets the GB parameters for the requested GB model used by OpenMM</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        implicitSolvent : app.HCT, app.OBC1, app.OBC2, app.GBn, or app.GBn2</span>
<span class="sd">            The object specifying a particular GB model in OpenMM</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parameters : list of float</span>
<span class="sd">            List of parameters for the requested GB model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">:</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.48435382330</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.09085413633</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.700147318409</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.06557401132</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.602256336067</span>
                <span class="k">if</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="c"># Add non-optimized values as defaults</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.85</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.058554</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.733756</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.506378</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.205844</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.425952</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.788440</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.798699</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.437334</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.733599</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.503364</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.316828</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.192915</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.061039</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.867814</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.876635</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.387882</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.703469</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.867814</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.876635</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.387882</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mbondi3</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">screen</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="c"># Replace with defaults</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_gb_rad_screen</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">)</span>

        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">length_conv</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">screen</span><span class="p">))</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="k">return</span> <span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="c">#===================================================</span>

    <span class="c"># Support concatenating and replicating the Structure</span>

    <span class="k">def</span> <span class="nf">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">+=</span> <span class="n">other</span>
        <span class="k">return</span> <span class="n">cp</span>

    <span class="k">def</span> <span class="nf">__iadd__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Structure</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="c"># The basic approach taken here is to extend the atom list, then scan</span>
        <span class="c"># through all of the valence terms in `other`, adding them to the</span>
        <span class="c"># corresponding arrays of `self`, using an offset to look into the atom</span>
        <span class="c"># array. The types are done a little differently. The types are all</span>
        <span class="c"># copied into a &quot;temporary&quot; array so they have the same index as the</span>
        <span class="c"># original Structure `other`, and as the valence terms are created the</span>
        <span class="c"># reference to that type is added. Afterwards, those types are tacked on</span>
        <span class="c"># to the end of the types list on `self`</span>
        <span class="n">aoffset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">roffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c"># No residues... must be an empty structure</span>
            <span class="n">roffset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="n">roffset</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                          <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">copy_valence_terms</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span> <span class="n">otyp</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">styp</span><span class="p">,</span> <span class="n">attrlist</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Copies the valence terms from one list to another;</span>
<span class="sd">            oval=Other VALence; otyp=Other TYPe; sval=Self VALence;</span>
<span class="sd">            styp=Self TYPe; attrlist=ATTRibute LIST (atom1, atom2, ...)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">otypcp</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy</span><span class="p">(</span><span class="n">typ</span><span class="p">)</span> <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">otyp</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">oval</span><span class="p">:</span>
                <span class="n">ats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrlist</span><span class="p">]</span>
                <span class="c"># Replace any atoms with the ones from self.atoms</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ats</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
                        <span class="n">ats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="n">aoffset</span><span class="p">]</span>
                <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">otypcp</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">kws</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">otypcp</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">sval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)(</span><span class="o">*</span><span class="n">ats</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;funct&#39;</span><span class="p">):</span>
                    <span class="n">sval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">funct</span>
            <span class="c"># Now tack on the &quot;new&quot; types copied from `other`</span>
            <span class="n">styp</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">otypcp</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">styp</span><span class="p">,</span> <span class="s">&#39;claim&#39;</span><span class="p">):</span>
                <span class="n">styp</span><span class="o">.</span><span class="n">claim</span><span class="p">()</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span>
                           <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span>
                           <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                           <span class="n">other</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">,</span>
                            <span class="s">&#39;atom6&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">,</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;chirality&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span>
                           <span class="p">[],</span> <span class="p">[</span><span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;frame_pt_num&#39;</span><span class="p">,</span> <span class="s">&#39;vectail&#39;</span><span class="p">,</span> <span class="s">&#39;vechead&#39;</span><span class="p">,</span>
                           <span class="s">&#39;nvec&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="p">[],</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="p">[],</span>
                           <span class="p">[</span><span class="s">&#39;bs&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;move&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">other</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">other</span><span class="o">.</span><span class="n">_coordinates</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">coordinates</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__mul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncopies</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Replicates the current Structure `ncopies` times &quot;&quot;&quot;</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cp</span><span class="o">.</span><span class="n">__imul__</span><span class="p">(</span><span class="n">ncopies</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="n">__rmul__</span> <span class="o">=</span> <span class="n">__mul__</span>

    <span class="k">def</span> <span class="nf">__imul__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ncopies</span><span class="p">,</span> <span class="n">other</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncopies</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="c"># The basic approach here is similar to what we used in __iadd__, except</span>
        <span class="c"># we don&#39;t have to extend the type arrays at all -- we just point to the</span>
        <span class="c"># same one that the first copy pointed to.</span>
        <span class="k">def</span> <span class="nf">copy_valence_terms</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">styp</span><span class="p">,</span> <span class="n">attrlist</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Copies the valence terms from one list to another;</span>
<span class="sd">            oval=Other VALence; otyp=Other TYPe; sval=Self VALence;</span>
<span class="sd">            styp=Self TYPe; attrlist=ATTRibute LIST (atom1, atom2, ...)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">oval</span><span class="p">:</span>
                <span class="n">ats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrlist</span><span class="p">]</span>
                <span class="c"># Replace any atoms with the ones from self.atoms</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">at</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ats</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
                        <span class="n">ats</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="n">aoffset</span><span class="p">]</span>
                <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">styp</span> <span class="ow">and</span> <span class="n">val</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">kws</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">styp</span><span class="p">[</span><span class="n">val</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">sval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)(</span><span class="o">*</span><span class="n">ats</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&#39;funct&#39;</span><span class="p">):</span>
                    <span class="n">sval</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">funct</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">funct</span>
        <span class="k">if</span> <span class="n">other</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">other</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncopies</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">aoffset</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
            <span class="n">roffset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">copy</span><span class="p">(</span><span class="n">atom</span><span class="p">),</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">idx</span><span class="o">+</span><span class="n">roffset</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                              <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span>
                               <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span> <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;improper&#39;</span><span class="p">,</span>
                                <span class="s">&#39;ignore_end&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                               <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">,</span>
                                <span class="s">&#39;atom6&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">,</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span>
                               <span class="p">[],</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;chirality&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[</span><span class="s">&#39;atom&#39;</span><span class="p">,</span> <span class="s">&#39;frame_pt_num&#39;</span><span class="p">,</span> <span class="s">&#39;vectail&#39;</span><span class="p">,</span> <span class="s">&#39;vechead&#39;</span><span class="p">,</span>
                               <span class="s">&#39;nvec&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span>
                               <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
            <span class="n">copy_valence_terms</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="n">aoffset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">,</span> <span class="p">[],</span>
                               <span class="p">[</span><span class="s">&#39;bs&#39;</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="s">&#39;move&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">ncopies</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_coordinates</span> <span class="o">=</span> <span class="n">coords</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="c">#===================================================</span>

    <span class="c"># For the bool-ness of Structure. An empty structure evaluates to</span>
    <span class="c"># boolean-false, but this means that the structure must have no atoms,</span>
    <span class="c"># residues, topological features, or parameter types at all.</span>

    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">donors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsion_types</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># For Python 2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bool__</span><span class="p">()</span>

    <span class="c">#===================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an OpenMM force to a system IFF the force is not None &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c"># It&#39;s possible we got multiple forces to add</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</div>
<span class="k">class</span> <span class="nc">_StructureViewerCreator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Class responsible for creating a StructureView when indexed &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">struct</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">struct</span> <span class="o">=</span> <span class="n">struct</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">struct</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">integer_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>

        <span class="n">view</span> <span class="o">=</span> <span class="n">StructureView</span><span class="p">()</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">_get_selection_array</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="c"># _get_selection_array might have returned either an Atom or None if</span>
        <span class="c"># there is no selection. Handle those and return, or continue if we got</span>
        <span class="c"># a list of atoms</span>
        <span class="k">if</span> <span class="n">selection</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">view</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">Atom</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">selection</span>
        <span class="n">sumsel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sumsel</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># No atoms selected. Return None</span>
            <span class="k">return</span> <span class="n">view</span>
        <span class="c"># The cumulative sum of selection will give our index + 1 of each</span>
        <span class="c"># selected atom into the new structure</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">selection</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">)):</span>
            <span class="n">scan</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scan</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="c"># Zero-out the unselected atoms</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="n">selection</span><span class="p">)]</span>
        <span class="c"># Copy all parameters</span>
        <span class="n">sel_res</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span> <span class="k">continue</span>
            <span class="n">view</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="ow">in</span> <span class="n">sel_res</span><span class="p">:</span> <span class="k">continue</span>
            <span class="n">view</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="p">)</span>
            <span class="n">sel_res</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">add_valence_terms</span><span class="p">(</span><span class="n">oval</span><span class="p">,</span> <span class="n">sval</span><span class="p">,</span> <span class="n">attrlist</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Adds the valence terms from one list to another;</span>
<span class="sd">            oval=Other VALence; otyp=Other TYPe; sval=Self VALence;</span>
<span class="sd">            styp=Self TYPe; attrlist=ATTRibute LIST (atom1, atom2, ...)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">sval</span><span class="p">:</span>
                <span class="n">ats</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrlist</span><span class="p">]</span>
                <span class="c"># Make sure all of our atoms in this valence term is &quot;selected&quot;</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="p">[</span><span class="n">at</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">ats</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">at</span><span class="p">,</span> <span class="n">Atom</span><span class="p">)]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="c"># Add the type if applicable</span>
                <span class="n">oval</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">bonds</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">angles</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">rb_torsions</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">impropers</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">cmaps</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">,</span>
                           <span class="s">&#39;atom6&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">,</span> <span class="s">&#39;atom3&#39;</span><span class="p">,</span> <span class="s">&#39;atom4&#39;</span><span class="p">,</span> <span class="s">&#39;atom5&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">,</span>
                          <span class="p">[</span><span class="s">&#39;atom&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">adjusts</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">donors</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="n">add_valence_terms</span><span class="p">(</span><span class="n">view</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">acceptors</span><span class="p">,</span> <span class="p">[</span><span class="s">&#39;atom1&#39;</span><span class="p">,</span> <span class="s">&#39;atom2&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">view</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="StructureView"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.StructureView">[docs]</a><span class="k">class</span> <span class="nc">StructureView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A view of a Structure. In many cases, this can serve as a duck-typed</span>
<span class="sd">    Structure and it has many of the same attributes. However, none of its lists</span>
<span class="sd">    *own* their objects, and the lists of atoms, residues, and</span>
<span class="sd">    parameters/topologies are regular lists, rather than TrackedList instances.</span>
<span class="sd">    Therefore, the indexes correspond to the indexes from the *original*</span>
<span class="sd">    Structure from which this view was taken. Furthermore, there are no &quot;type&quot;</span>
<span class="sd">    lists, as they would be exactly equivalent to the type lists of the parent</span>
<span class="sd">    Structure instance.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : :class:`AtomList`</span>
<span class="sd">        List of all atoms in the structure</span>
<span class="sd">    residues : :class:`ResidueList`</span>
<span class="sd">        List of all residues in the structure</span>
<span class="sd">    bonds : :class:`TrackedList` (:class:`Bond`)</span>
<span class="sd">        List of all bonds in the structure</span>
<span class="sd">    angles : :class:`TrackedList` (:class:`Angle`)</span>
<span class="sd">        List of all angles in the structure</span>
<span class="sd">    dihedrals : :class:`TrackedList` (:class:`Dihedral`)</span>
<span class="sd">        List of all dihedrals in the structure</span>
<span class="sd">    rb_torsions : :class:`TrackedList` (:class:`RBTorsion`)</span>
<span class="sd">        List of all Ryckaert-Bellemans torsions in the structure</span>
<span class="sd">    urey_bradleys : :class:`TrackedList` (:class:`UreyBradley`)</span>
<span class="sd">        List of all Urey-Bradley angle bends in the structure</span>
<span class="sd">    impropers : :class:`TrackedList` (:class:`Improper`)</span>
<span class="sd">        List of all CHARMM-style improper torsions in the structure</span>
<span class="sd">    cmaps : :class:`TrackedList` (:class:`Cmap`)</span>
<span class="sd">        List of all CMAP objects in the structure</span>
<span class="sd">    trigonal_angles : :class:`TrackedList` (:class:`TrigonalAngle`)</span>
<span class="sd">        List of all AMOEBA-style trigonal angles in the structure</span>
<span class="sd">    out_of_plane_bends : :class:`TrackedList` (:class:`OutOfPlaneBends`)</span>
<span class="sd">        List of all AMOEBA-style out-of-plane bending angles</span>
<span class="sd">    pi_torsions : :class:`TrackedList` (:class:`PiTorsion`)</span>
<span class="sd">        List of all AMOEBA-style pi-torsion angles</span>
<span class="sd">    stretch_bends : :class:`TrackedList` (:class:`StretchBend`)</span>
<span class="sd">        List of all AMOEBA-style stretch-bend compound bond/angle terms</span>
<span class="sd">    torsion_torsions : :class:`TrackedList` (:class:`TorsionTorsion`)</span>
<span class="sd">        List of all AMOEBA-style coupled torsion-torsion terms</span>
<span class="sd">    chiral_frames : :class:`TrackedList` (:class:`ChiralFrame`)</span>
<span class="sd">        List of all AMOEBA-style chiral frames defined in the structure</span>
<span class="sd">    multipole_frames : :class:`TrackedList` (:class:`MultipoleFrame`)</span>
<span class="sd">        List of all AMOEBA-style multipole frames defined in the structure</span>
<span class="sd">    adjusts : :class:`TrackedList` (:class:`NonbondedException`)</span>
<span class="sd">        List of all nonbonded pair-exception rules</span>
<span class="sd">    acceptors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond acceptors, if that information is present</span>
<span class="sd">    donors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond donors, if that information is present</span>
<span class="sd">    positions : u.Quantity(list(Vec3), u.angstroms)</span>
<span class="sd">        Unit-bearing atomic coordinates. If not all atoms have coordinates, this</span>
<span class="sd">        property is None</span>
<span class="sd">    coordinates : np.ndarray of shape (nframes, natom, 3)</span>
<span class="sd">        If no coordinates are set, this is set to None. The first frame will</span>
<span class="sd">        match the coordinates present on the atoms.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donors</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="StructureView.to_dataframe"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.StructureView.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Generates a DataFrame from the current Structure&#39;s atomic properties</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        df : DataFrame</span>
<span class="sd">            DataFrame with all atomic properties</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`parmed.utils.pandautils.create_dataframe` for full</span>
<span class="sd">        documentation of the generated DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.utils.pandautils</span> <span class="kn">import</span> <span class="n">create_dataframe</span>
        <span class="k">return</span> <span class="n">create_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="StructureView.load_dataframe"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.StructureView.load_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">load_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Loads atomic properties from an input DataFrame</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            A pandas DataFrame with atomic properties that will be used to set</span>
<span class="sd">            the properties on the current list of atoms</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :func:`parmed.utils.pandautils.load_dataframe` for full documentation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">parmed.utils.pandautils</span> <span class="kn">import</span> <span class="n">load_dataframe</span>
        <span class="k">return</span> <span class="n">load_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="StructureView.coordinates"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.StructureView.coordinates">[docs]</a>    <span class="k">def</span> <span class="nf">coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="StructureView.positions"><a class="viewcode-back" href="../../api/parmed/parmed.structure.html#parmed.structure.StructureView.positions">[docs]</a>    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">Vec3</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
</div>
    <span class="k">def</span> <span class="nf">__bool__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rb_torsions</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">)</span>
        <span class="c"># Ignore types here because it&#39;s just a view</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">natom</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="n">nres</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">)</span>
        <span class="n">nextra</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">])</span>
        <span class="n">retstr</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s"> </span><span class="si">%d</span><span class="s"> atoms&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">natom</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">nextra</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; [</span><span class="si">%d</span><span class="s"> EPs]&#39;</span> <span class="o">%</span> <span class="n">nextra</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; </span><span class="si">%d</span><span class="s"> residues&#39;</span> <span class="o">%</span> <span class="n">nres</span><span class="p">)</span>
        <span class="n">nbond</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">retstr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;; </span><span class="si">%d</span><span class="s"> bonds&gt;&#39;</span> <span class="o">%</span> <span class="n">nbond</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">retstr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__nonzero__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># For Python 2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__bool__</span><span class="p">()</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ParmEd 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li>
          <li><a href="../parmed.html" >parmed</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jason Swails.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
  </body>
</html>