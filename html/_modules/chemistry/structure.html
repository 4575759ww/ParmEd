<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>chemistry.structure &mdash; ParmEd 2.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="ParmEd 2.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ParmEd 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for chemistry.structure</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module contains the core base class for all of the chemical structures with</span>
<span class="sd">various topological and force field features.</span>

<span class="sd">Author: Jason Swails</span>
<span class="sd">Contributors: Pawel Janowski</span>

<span class="sd">Copyright (C) 2014 - 2015  Jason Swails</span>

<span class="sd">This program is free software; you can redistribute it and/or modify it under</span>
<span class="sd">the terms of the GNU Lesser General Public License as published by the Free</span>
<span class="sd">Software Foundation; either version 2 of the License, or (at your option) any</span>
<span class="sd">later version.</span>

<span class="sd">This program is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="sd">WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A</span>
<span class="sd">PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.</span>

<span class="sd">You should have received a copy of the GNU Lesser General Public License along</span>
<span class="sd">with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="sd">59 Temple Place - Suite 330</span>
<span class="sd">Boston, MA 02111-1307, USA.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">bz2</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">bz2</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">from</span> <span class="nn">chemistry.constants</span> <span class="kn">import</span> <span class="n">DEG_TO_RAD</span>
<span class="kn">from</span> <span class="nn">chemistry.exceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">PDBError</span><span class="p">,</span> <span class="n">PDBWarning</span><span class="p">,</span> <span class="n">AnisouWarning</span><span class="p">,</span>
        <span class="n">ChemError</span><span class="p">,</span> <span class="n">MissingParameter</span><span class="p">,</span> <span class="n">MissingParameterWarning</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">chemistry.geometry</span> <span class="kn">import</span> <span class="p">(</span><span class="n">box_lengths_and_angles_to_vectors</span><span class="p">,</span>
        <span class="n">box_vectors_to_lengths_and_angles</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">chemistry.pdbx</span> <span class="kn">import</span> <span class="n">PdbxReader</span><span class="p">,</span> <span class="n">PdbxWriter</span><span class="p">,</span> <span class="n">containers</span>
<span class="kn">from</span> <span class="nn">chemistry.periodic_table</span> <span class="kn">import</span> <span class="n">AtomicNum</span><span class="p">,</span> <span class="n">Mass</span><span class="p">,</span> <span class="n">Element</span>
<span class="kn">from</span> <span class="nn">chemistry.residue</span> <span class="kn">import</span> <span class="n">WATER_NAMES</span>
<span class="kn">from</span> <span class="nn">chemistry.topologyobjects</span> <span class="kn">import</span> <span class="p">(</span><span class="n">AtomList</span><span class="p">,</span> <span class="n">ResidueList</span><span class="p">,</span> <span class="n">TrackedList</span><span class="p">,</span>
        <span class="n">AngleType</span><span class="p">,</span> <span class="n">DihedralType</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">,</span> <span class="n">BondType</span><span class="p">,</span> <span class="n">ImproperType</span><span class="p">,</span>
        <span class="n">CmapType</span><span class="p">,</span> <span class="n">OutOfPlaneBendType</span><span class="p">,</span> <span class="n">StretchBendType</span><span class="p">,</span> <span class="n">TorsionTorsionType</span><span class="p">,</span>
        <span class="n">NonbondedExceptionType</span><span class="p">,</span> <span class="n">Bond</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">Dihedral</span><span class="p">,</span> <span class="n">UreyBradley</span><span class="p">,</span> <span class="n">Improper</span><span class="p">,</span>
        <span class="n">Cmap</span><span class="p">,</span> <span class="n">TrigonalAngle</span><span class="p">,</span> <span class="n">OutOfPlaneBend</span><span class="p">,</span> <span class="n">PiTorsion</span><span class="p">,</span> <span class="n">StretchBend</span><span class="p">,</span>
        <span class="n">TorsionTorsion</span><span class="p">,</span> <span class="n">ChiralFrame</span><span class="p">,</span> <span class="n">MultipoleFrame</span><span class="p">,</span> <span class="n">NonbondedException</span><span class="p">,</span>
        <span class="n">AcceptorDonor</span><span class="p">,</span> <span class="n">Group</span><span class="p">,</span> <span class="n">Atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">,</span> <span class="n">TwoParticleExtraPointFrame</span><span class="p">,</span>
        <span class="n">ThreeParticleExtraPointFrame</span><span class="p">,</span> <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">chemistry</span> <span class="kn">import</span> <span class="n">unit</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">compat24</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gzip</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">gzip</span> <span class="o">=</span> <span class="bp">None</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
    <span class="n">create_array</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">create_array</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

<span class="c"># Try to import the OpenMM modules</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">simtk.openmm</span> <span class="kn">import</span> <span class="n">app</span>
    <span class="kn">from</span> <span class="nn">simtk</span> <span class="kn">import</span> <span class="n">openmm</span> <span class="k">as</span> <span class="n">mm</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">app</span> <span class="o">=</span> <span class="n">mm</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="needs_openmm"><a class="viewcode-back" href="../../api/chemistry/chemistry.structure.html#chemistry.structure.needs_openmm">[docs]</a><span class="k">def</span> <span class="nf">needs_openmm</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapped</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;Could not find OpenMM Python bindings&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapped</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<span class="c"># Private attributes and methods</span>
</div>
<span class="n">relatere</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;RELATED ID: *(\w+) *RELATED DB: *(\w+)&#39;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_compare_atoms</span><span class="p">(</span><span class="n">old_atom</span><span class="p">,</span> <span class="n">new_atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares two atom instances, along with the residue name, number, and chain</span>
<span class="sd">    identifier, to determine if two atoms are actually the *same* atom, but</span>
<span class="sd">    simply different conformations</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    old_atom : :class:`Atom`</span>
<span class="sd">        The original atom that has been added to the structure already</span>
<span class="sd">    new_atom : :class:`Atom`</span>
<span class="sd">        The new atom that we want to see if it is the same as the old atom</span>
<span class="sd">    resname : ``str``</span>
<span class="sd">        The name of the residue that the new atom would belong to</span>
<span class="sd">    resid : ``int``</span>
<span class="sd">        The number of the residue that the new atom would belong to</span>
<span class="sd">    chain : ``str``</span>
<span class="sd">        The chain identifier that the new atom would belong to</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True if they are the same atom, False otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">new_atom</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">resname</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">resid</span><span class="p">:</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">old_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span> <span class="o">!=</span> <span class="n">chain</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span> <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>

<span class="k">def</span> <span class="nf">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.7</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.55</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">14</span><span class="p">:</span> <span class="k">return</span> <span class="mf">2.1</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="k">return</span> <span class="mf">1.8</span>
    <span class="k">return</span> <span class="mf">1.5</span>

<span class="k">def</span> <span class="nf">_mbondi</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">bondeds</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span>
        <span class="k">if</span> <span class="n">bondeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.3</span>
        <span class="k">if</span> <span class="n">bondeds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">0.8</span>
        <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">return</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.3</span>
        <span class="k">return</span> <span class="mf">1.2</span>
    <span class="k">return</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_mbondi3</span><span class="p">(</span><span class="n">atom</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;GLU&#39;</span><span class="p">,</span> <span class="s">&#39;ASP&#39;</span><span class="p">,</span> <span class="s">&#39;GL4&#39;</span><span class="p">,</span> <span class="s">&#39;AS4&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;OE&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;OD&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.4</span>
    <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;ARG&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HH&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;HE&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="mf">1.17</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;OXT&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">1.4</span>
    <span class="k">return</span> <span class="n">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

<span class="nd">@needs_openmm</span>
<span class="k">def</span> <span class="nf">_gb_rad_screen</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the default GB parameters for a given atom according to a specific</span>
<span class="sd">    Generalized Born model</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    atom : :class:`Atom`</span>
<span class="sd">        The atom to get the default GB parameters for</span>
<span class="sd">    model : ``app.HCT, app.OBC1, or app.OBC2``</span>
<span class="sd">        The GB model to get the default parameters for (app.GBn and app.GBn2 are</span>
<span class="sd">        already handled in Structure._get_gb_parameters)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    radius, screen [,alpha, beta, gamma] : ``float, float [,float, float, float]``</span>
<span class="sd">        The intrinsic radius of the atom and the screening factor of the atom.</span>
<span class="sd">        If the model is GBn2, alpha, beta, and gamma parameters are also</span>
<span class="sd">        returned</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">model</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">):</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">_mbondi2</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">rad</span> <span class="o">=</span> <span class="n">_mbondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.72</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.79</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.85</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">9</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.88</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.86</span>
    <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span> <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.96</span>
    <span class="k">return</span> <span class="n">rad</span><span class="p">,</span> <span class="mf">0.8</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>

<div class="viewcode-block" id="Structure"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure">[docs]</a><span class="k">class</span> <span class="nc">Structure</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A chemical structure composed of atoms, bonds, angles, torsions, and other</span>
<span class="sd">    topological features</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    atoms : :class:`AtomList`</span>
<span class="sd">        List of all atoms in the structure</span>
<span class="sd">    residues : :class:`ResidueList`</span>
<span class="sd">        List of all residues in the structure</span>
<span class="sd">    bonds : :class:`TrackedList` (:class:`Bond`)</span>
<span class="sd">        List of all bonds in the structure</span>
<span class="sd">    angles : :class:`TrackedList` (:class:`Angle`)</span>
<span class="sd">        List of all angles in the structure</span>
<span class="sd">    dihedrals : :class:`TrackedList` (:class:`Dihedral`)</span>
<span class="sd">        List of all dihedrals in the structure -- only one term per dihedral, so</span>
<span class="sd">        multi-term dihedral parameters will have the same 4 atoms appear</span>
<span class="sd">        multiple times in the list</span>
<span class="sd">    urey_bradleys : :class:`TrackedList` (:class:`UreyBradley`)</span>
<span class="sd">        List of all Urey-Bradley angle bends in the structure</span>
<span class="sd">    impropers : :class:`TrackedList` (:class:`Improper`)</span>
<span class="sd">        List of all CHARMM-style improper torsions in the structure</span>
<span class="sd">    cmaps : :class:`TrackedList` (:class:`Cmap`)</span>
<span class="sd">        List of all CMAP objects in the structure</span>
<span class="sd">    trigonal_angles : :class:`TrackedList` (:class:`TrigonalAngle`)</span>
<span class="sd">        List of all AMOEBA-style trigonal angles in the structure</span>
<span class="sd">    out_of_plane_bends : :class:`TrackedList` (:class:`OutOfPlaneBends`)</span>
<span class="sd">        List of all AMOEBA-style out-of-plane bending angles</span>
<span class="sd">    pi_torsions : :class:`TrackedList` (:class:`PiTorsion`)</span>
<span class="sd">        List of all AMOEBA-style pi-torsion angles</span>
<span class="sd">    stretch_bends : :class:`TrackedList` (:class:`StretchBend`)</span>
<span class="sd">        List of all AMOEBA-style stretch-bend compound bond/angle terms</span>
<span class="sd">    torsion_torsions : :class:`TrackedList` (:class:`TorsionTorsion`)</span>
<span class="sd">        List of all AMOEBA-style coupled torsion-torsion terms</span>
<span class="sd">    chiral_frames : :class:`TrackedList` (:class:`ChiralFrame`)</span>
<span class="sd">        List of all AMOEBA-style chiral frames defined in the structure</span>
<span class="sd">    multipole_frames : :class:`TrackedList` (:class:`MultipoleFrame`)</span>
<span class="sd">        List of all AMOEBA-style multipole frames defined in the structure</span>
<span class="sd">    adjusts : :class:`TrackedList` (:class:`NonbondedException`)</span>
<span class="sd">        List of all AMOEBA-style nonbonded pair-exception rules</span>
<span class="sd">    acceptors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond acceptors, if that information is present</span>
<span class="sd">    donors : :class:`TrackedList` (:class:`AcceptorDonor`)</span>
<span class="sd">        List of all H-bond donors, if that information is present</span>
<span class="sd">    groups : :class:`TrackedList` (:class:`Group`)</span>
<span class="sd">        List of all CHARMM-style GROUP objects (whatever those are used for)</span>
<span class="sd">    box : ``list of 6 floats``</span>
<span class="sd">        Box dimensions (a, b, c, alpha, beta, gamma) for the unit cell. If no</span>
<span class="sd">        box is defined, `box` is set to `None`</span>
<span class="sd">    space_group : ``str``</span>
<span class="sd">        The space group of the structure (default is &quot;P 1&quot;)</span>

<span class="sd">    This class also has a handful of type lists for each of the attributes above</span>
<span class="sd">    (excluding `atoms`, `residues`, `chiral_frames`, and `multipole_frames`).</span>
<span class="sd">    They are all TrackedList instances that are designed to hold the relevant</span>
<span class="sd">    parameter type. The list is:</span>
<span class="sd">        bond_types, angle_types, dihedral_types, urey_bradley_types,</span>
<span class="sd">        improper_types, cmap_types, trigonal_angle_types,</span>
<span class="sd">        out_of_plane_bend_types, pi_torsion_types, stretch_bend_types,</span>
<span class="sd">        torsion_torsion_types, adjust_types</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    dihedral_types _may_ be a list of :class:`DihedralType` instances, since</span>
<span class="sd">    torsion profiles are often represented by a Fourier series with multiple</span>
<span class="sd">    terms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Force groups assigned to each type of force</span>
    <span class="n">BOND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ANGLE_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">DIHEDRAL_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">UREY_BRADLEY_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">IMPROPER_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">CMAP_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">TRIGONAL_ANGLE_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">6</span>
    <span class="n">OUT_OF_PLANE_BEND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">7</span>
    <span class="n">PI_TORSION_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="n">STRETCH_BEND_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">9</span>
    <span class="n">TORSION_TORSION_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">NONBONDED_FORCE_GROUP</span> <span class="o">=</span> <span class="mi">11</span>

    <span class="c">#===================================================</span>

<div class="viewcode-block" id="Structure.__init__"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c"># Topological object lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="o">=</span> <span class="n">AtomList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span> <span class="o">=</span> <span class="n">ResidueList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="c"># Extraneous information stored in CHARMM PSF files... not used as far</span>
        <span class="c"># as I can tell for much of anything</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donors</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>

        <span class="c"># Parameter type lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span> <span class="o">=</span> <span class="n">TrackedList</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="s">&quot;P 1&quot;</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.add_atom"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.add_atom">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">inscode</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new atom to the Structure, adding a new residue to `residues` if</span>
<span class="sd">        it has a different name or number as the last residue added and adding</span>
<span class="sd">        it to the `atoms` list.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom : :class:`Atom`</span>
<span class="sd">            The atom to add to this residue list</span>
<span class="sd">        resname : ``str``</span>
<span class="sd">            The name of the residue this atom belongs to</span>
<span class="sd">        resnum : ``int``</span>
<span class="sd">            The number of the residue this atom belongs to</span>
<span class="sd">        chain : ``str``</span>
<span class="sd">            The chain ID character for this residue</span>
<span class="sd">        inscode : ``str``</span>
<span class="sd">            The insertion code ID character for this residue (it is stripped)</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        If the residue name and number differ from the last residue in this</span>
<span class="sd">        list, a new residue is added and the atom is added to that residue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">inscode</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.add_atom_to_residue"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.add_atom_to_residue">[docs]</a>    <span class="k">def</span> <span class="nf">add_atom_to_residue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">residue</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a new atom to the Structure at the end if the given residue</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        atom : :class:`Atom`</span>
<span class="sd">            The atom to add to the system</span>
<span class="sd">        residue : :class:`Residue`</span>
<span class="sd">            The residue to which to add this atom. It MUST be part of this</span>
<span class="sd">            Structure instance already or a ValueError is raised</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        This atom is added at the end of the residue and is inserted into the</span>
<span class="sd">        `atoms` list in such a way that all residues are composed of atoms</span>
<span class="sd">        contiguous in the atoms list. For large systems, this may be a</span>
<span class="sd">        relatively expensive operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Make sure residue belongs to this list</span>
        <span class="k">if</span> <span class="n">residue</span><span class="o">.</span><span class="n">list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Residue is not part of the structure&#39;</span><span class="p">)</span>
        <span class="n">last_atom</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">residue</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="c"># Special-case if this is going to be the last atom</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span> <span class="ow">or</span> <span class="n">last_atom</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">last_atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">atom</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A deep copy of the Structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="c">#===================================================</span>

<div class="viewcode-block" id="Structure.copy"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cls</span><span class="p">,</span> <span class="n">split_dihedrals</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes a copy of the current structure as an instance of a specified</span>
<span class="sd">        subclass</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cls : Structure subclass</span>
<span class="sd">            The returned object is a copy of this structure as a `cls` instance</span>
<span class="sd">        split_dihedrals : ``bool``</span>
<span class="sd">            If True, then the Dihedral entries will be split up so that each one</span>
<span class="sd">            is paired with a single DihedralType (rather than a</span>
<span class="sd">            DihedralTypeList)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        *cls* instance</span>
<span class="sd">            The instance of the Structure subclass `cls` with a copy of the</span>
<span class="sd">            current Structure&#39;s topology information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">cls</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">number</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">)</span>
        <span class="c"># Now copy all of the types</span>
        <span class="k">for</span> <span class="n">bt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">bt</span><span class="o">.</span><span class="n">req</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AngleType</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">split_dihedrals</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                <span class="n">dt</span><span class="o">.</span><span class="n">starting_index</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">DihedralType</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                             <span class="n">t</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">scnb</span><span class="p">,</span>
                                             <span class="nb">list</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">DihedralType</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                         <span class="n">t</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">scnb</span><span class="p">,</span>
                                         <span class="nb">list</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="n">dtl</span> <span class="o">=</span> <span class="n">DihedralTypeList</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">dt</span><span class="p">:</span>
                        <span class="n">dtl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DihedralType</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span>
                                                <span class="n">t</span><span class="o">.</span><span class="n">scnb</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtl</span> <span class="o">=</span> <span class="n">DihedralType</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">dt</span><span class="o">.</span><span class="n">scee</span><span class="p">,</span>
                                       <span class="n">dt</span><span class="o">.</span><span class="n">scnb</span><span class="p">)</span>
                <span class="n">dtl</span><span class="o">.</span><span class="n">list</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtl</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ut</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BondType</span><span class="p">(</span><span class="n">ut</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">ut</span><span class="o">.</span><span class="n">req</span><span class="p">,</span>
                                                 <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ImproperType</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">psi_k</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">psi_eq</span><span class="p">,</span>
                                                 <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">CmapType</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>
                                         <span class="nb">list</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">ta</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AngleType</span><span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">ta</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">ot</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">OutOfPlaneBendType</span><span class="p">(</span><span class="n">ot</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">DihedralType</span><span class="p">(</span><span class="n">pt</span><span class="o">.</span><span class="n">phi_k</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">per</span><span class="p">,</span> <span class="n">pt</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                 <span class="nb">list</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">StretchBendType</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">req1</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">req2</span><span class="p">,</span> <span class="n">st</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                                    <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TorsionTorsionType</span><span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">ang1</span><span class="p">[:],</span> <span class="n">tt</span><span class="o">.</span><span class="n">ang2</span><span class="p">[:],</span>
                                       <span class="n">tt</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">data</span><span class="p">[:],</span> <span class="n">tt</span><span class="o">.</span><span class="n">dfda1</span><span class="o">.</span><span class="n">data</span><span class="p">[:],</span>
                                       <span class="n">tt</span><span class="o">.</span><span class="n">dfda2</span><span class="o">.</span><span class="n">data</span><span class="p">[:],</span> <span class="n">tt</span><span class="o">.</span><span class="n">d2fda1da2</span><span class="o">.</span><span class="n">data</span><span class="p">[:],</span>
                                       <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">NonbondedExceptionType</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">vdw_weight</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">multipole_weight</span><span class="p">,</span>
                                           <span class="n">at</span><span class="o">.</span><span class="n">direct_weight</span><span class="p">,</span> <span class="n">at</span><span class="o">.</span><span class="n">polar_weight</span><span class="p">,</span>
                                           <span class="n">at</span><span class="o">.</span><span class="n">mutual_weight</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c"># Now create the topological objects</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span>
        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Bond</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">c</span><span class="o">.</span><span class="n">bond_types</span><span class="p">[</span><span class="n">b</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Angle</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                          <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">angle_types</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">split_dihedrals</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;__iter__&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">)):</span>
                        <span class="n">ie</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">ti</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">starting_index</span> <span class="o">+</span> <span class="n">i</span>
                        <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="n">Dihedral</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                         <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">ie</span><span class="p">,</span>
                                         <span class="nb">type</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">ti</span><span class="p">])</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">starting_index</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">Dihedral</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                 <span class="n">improper</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">improper</span><span class="p">,</span> <span class="n">ignore_end</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">,</span>
                                 <span class="nb">type</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">dihedral_types</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
                <span class="p">)</span>
        <span class="k">for</span> <span class="n">ub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">UreyBradley</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">c</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="p">[</span><span class="n">ub</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Improper</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                             <span class="n">c</span><span class="o">.</span><span class="n">improper_types</span><span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">cm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Cmap</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                         <span class="n">atoms</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">c</span><span class="o">.</span><span class="n">cmap_types</span><span class="p">[</span><span class="n">cm</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TrigonalAngle</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                  <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                  <span class="n">c</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">OutOfPlaneBend</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">c</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">[</span><span class="n">o</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">PiTorsion</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                              <span class="n">c</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">StretchBend</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">atoms</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">c</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">TorsionTorsion</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">atoms</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                   <span class="n">c</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">ChiralFrame</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">ch</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                <span class="n">ch</span><span class="o">.</span><span class="n">chirality</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">MultipoleFrame</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">m</span><span class="o">.</span><span class="n">frame_pt_num</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">vectail</span><span class="p">,</span>
                                   <span class="n">m</span><span class="o">.</span><span class="n">vechead</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">nvec</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">NonbondedException</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span>
                                       <span class="n">c</span><span class="o">.</span><span class="n">adjust_types</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AcceptorDonor</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">AcceptorDonor</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Group</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">bs</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">g</span><span class="o">.</span><span class="n">move</span><span class="p">))</span>
        <span class="n">c</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.is_changed"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.is_changed">[docs]</a>    <span class="k">def</span> <span class="nf">is_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Determines if any of the topology has changed for this structure &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">changed</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.unchange"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.unchange">[docs]</a>    <span class="k">def</span> <span class="nf">unchange</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Toggles all lists so that they do not indicate any changes &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acceptors</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">donors</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Parameter type lists</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dihedral_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradley_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">improper_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmap_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bend_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsion_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_types</span><span class="o">.</span><span class="n">changed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.prune_empty_terms"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.prune_empty_terms">[docs]</a>    <span class="k">def</span> <span class="nf">prune_empty_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Looks through all of the topological lists and gets rid of terms</span>
<span class="sd">        in which at least one of the atoms is None or has an `idx` attribute set</span>
<span class="sd">        to -1 (indicating that it has been removed from the `atoms` atom list)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_bonds</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_angles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_dihedrals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_ureys</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_impropers</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_cmaps</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_trigonal_angles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_out_of_plane_bends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_pi_torsions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_stretch_bends</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_torsion_torsions</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_chiral_frames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_multipole_frames</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prune_empty_adjusts</span><span class="p">()</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.update_dihedral_exclusions"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.update_dihedral_exclusions">[docs]</a>    <span class="k">def</span> <span class="nf">update_dihedral_exclusions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Nonbonded exclusions and exceptions have the following priority:</span>

<span class="sd">        bond -&gt; angle -&gt; dihedral</span>

<span class="sd">        Since bonds and angles are completely excluded, any ring systems in</span>
<span class="sd">        which two atoms are attached by a bond or angle as well as a dihedral</span>
<span class="sd">        should be completely excluded as the bond and angle exclusion rules take</span>
<span class="sd">        precedence.  If a Bond or Angle was _added_ to the structure between a</span>
<span class="sd">        pair of atoms previously connected only by a dihedral term, it&#39;s</span>
<span class="sd">        possible that those two atoms have both an exclusion *and* an exception</span>
<span class="sd">        defined. The result of this scenario is that sander and pmemd will</span>
<span class="sd">        happily compute an energy, _including_ the 1-4 nonbonded terms between</span>
<span class="sd">        atoms now connected by a bond or an Angle.  OpenMM, on the other hand,</span>
<span class="sd">        will complain about an exception specified multiple times. This method</span>
<span class="sd">        scans through all of the dihedrals in which `ignore_end` is `False` and</span>
<span class="sd">        turns it to `True` if the two end atoms are in the bond or angle</span>
<span class="sd">        partners arrays</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">dihedral</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">bond_partners</span> <span class="ow">or</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">dihedral</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">angle_partners</span><span class="p">):</span>
                <span class="n">dihedral</span><span class="o">.</span><span class="n">ignore_end</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.strip"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.strip">[docs]</a>    <span class="k">def</span> <span class="nf">strip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes a subset of the atoms corresponding to an atom-based selection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        selection : :class:`AmberMask`, ``str``, or ``iterable``</span>
<span class="sd">            This is the selection of atoms that will be deleted from this</span>
<span class="sd">            structure. If it is a string, it will be interpreted as an</span>
<span class="sd">            AmberMask. If it is an AmberMask, it will be converted to a</span>
<span class="sd">            selection of atoms. If it is an iterable, it must be the same length</span>
<span class="sd">            as the `atoms` list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">chemistry.amber</span> <span class="kn">import</span> <span class="n">AmberMask</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="n">AmberMask</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">selection</span><span class="o">.</span><span class="n">parm</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;passed mask does not belong to Structure&#39;</span><span class="p">)</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">selection</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">selection</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">sel</span> <span class="o">=</span> <span class="n">AmberMask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">)</span><span class="o">.</span><span class="n">Selection</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sel</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Selection not a supported type [</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span>
                                <span class="nb">type</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Selection iterable wrong length&#39;</span><span class="p">)</span>
        <span class="n">atomlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sel</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">atomlist</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.write_pdb"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.write_pdb">[docs]</a>    <span class="k">def</span> <span class="nf">write_pdb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">altlocs</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">write_anisou</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">charmm</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a PDB file from the current Structure instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : ``str or file-like``</span>
<span class="sd">            Either a file name or a file-like object containing a `write`</span>
<span class="sd">            method to which to write the PDB file. If it is a filename that</span>
<span class="sd">            ends with .gz or .bz2, a compressed version will be written using</span>
<span class="sd">            either gzip or bzip2, respectively.</span>
<span class="sd">        renumber : ``bool``</span>
<span class="sd">            If True, renumber the atoms and residues sequentially as they are</span>
<span class="sd">            stored in the structure.  If False, use the original numbering if</span>
<span class="sd">            it was assigned previously</span>
<span class="sd">        coordinates : ``array-like of float``</span>
<span class="sd">            If provided, these coordinates will be written to the PDB file</span>
<span class="sd">            instead of the coordinates stored in the structure. These</span>
<span class="sd">            coordinates should line up with the atom order in the structure</span>
<span class="sd">            (not necessarily the order of the &quot;original&quot; PDB file if they</span>
<span class="sd">            differ)</span>
<span class="sd">        altlocs : ``str``</span>
<span class="sd">            Keyword controlling which alternate locations are printed to the</span>
<span class="sd">            resulting PDB file. Allowable options are:</span>

<span class="sd">                - &#39;all&#39; : (default) print all alternate locations</span>
<span class="sd">                - &#39;first&#39; : print only the first alternate locations</span>
<span class="sd">                - &#39;occupancy&#39; : print the one with the largest occupancy. If two</span>
<span class="sd">                  conformers have the same occupancy, the first one to occur is</span>
<span class="sd">                  printed</span>

<span class="sd">            Input is case-insensitive, and partial strings are permitted as long</span>
<span class="sd">            as it is a substring of one of the above options that uniquely</span>
<span class="sd">            identifies the choice.</span>
<span class="sd">        write_anisou : ``bool``</span>
<span class="sd">            If True, an ANISOU record is written for every atom that has one. If</span>
<span class="sd">            False, ANISOU records are not written</span>
<span class="sd">        charmm : ``bool``</span>
<span class="sd">            If True, SEGID will be written in columns 73 to 76 of the PDB file</span>
<span class="sd">            in the typical CHARMM-style PDB output. This will be omitted for any</span>
<span class="sd">            atom that does not contain a SEGID identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;all&#39;</span>
        <span class="k">elif</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;first&#39;</span>
        <span class="k">elif</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;occupancy&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;occupancy&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Illegal value of occupancy [</span><span class="si">%s</span><span class="s">]; expected &#39;all&#39;, &quot;</span>
                             <span class="s">&quot;&#39;first&#39;, or &#39;occupancy&#39;&quot;</span> <span class="o">%</span> <span class="n">altlocs</span><span class="p">)</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dest</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bz2&#39;</span><span class="p">):</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">atomrec</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ATOM  </span><span class="si">%5d</span><span class="s"> </span><span class="si">%-4s%1s%-3s</span><span class="s"> </span><span class="si">%1s%4d%1s</span><span class="s">   </span><span class="si">%8.3f%8.3f%8.3f%6.2f</span><span class="s">&#39;</span>
                   <span class="s">&#39;</span><span class="si">%6.2f</span><span class="s">      </span><span class="si">%-4s%2s%-2s</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">anisourec</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;ANISOU</span><span class="si">%5d</span><span class="s"> </span><span class="si">%-4s%1s%-3s</span><span class="s"> </span><span class="si">%1s%4d%1s</span><span class="s"> </span><span class="si">%7d%7d%7d%7d%7d%7d</span><span class="s">&#39;</span>
                     <span class="s">&#39;      </span><span class="si">%2s%-2s</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">terrec</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;TER   </span><span class="si">%5d</span><span class="s">      </span><span class="si">%-3s</span><span class="s"> </span><span class="si">%1s%4d</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;CRYST1</span><span class="si">%9.3f%9.3f%9.3f%7.2f%7.2f%7.2f</span><span class="s"> </span><span class="si">%-11s%4s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">space_group</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">crdsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot find length of coordinates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crdsize</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">coordinates</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unsupported coordinate dimensionality&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unsupported coordinate shape&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">crdsize</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Coordinates has unexpected shape&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">))</span>
        <span class="c"># Create a function to process each atom and return which one we want</span>
        <span class="c"># to print, based on our alternate location choice</span>
        <span class="k">if</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">other_locations</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="n">coords</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;occupancy&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">occupancy</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">atom</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">other_locations</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">&gt;</span> <span class="n">occ</span><span class="p">:</span>
                        <span class="n">occ</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">occupancy</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Should not be here!&quot;</span><span class="p">)</span>
        <span class="n">nmore</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># how many *extra* atoms have been added?</span>
        <span class="n">last_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_rnumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
                <span class="c"># Figure out the serial numbers we want to print</span>
                <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmore</span><span class="p">)</span>
                    <span class="n">rnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">rnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_rnumber</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">anum</span> <span class="o">=</span> <span class="n">anum</span> <span class="o">-</span> <span class="n">anum</span> <span class="o">//</span> <span class="mi">100000</span> <span class="o">*</span> <span class="mi">100000</span>
                <span class="n">rnum</span> <span class="o">=</span> <span class="n">rnum</span> <span class="o">-</span> <span class="n">rnum</span> <span class="o">//</span> <span class="mi">10000</span> <span class="o">*</span> <span class="mi">10000</span>
                <span class="n">last_number</span> <span class="o">=</span> <span class="n">anum</span>
                <span class="n">last_rnumber</span> <span class="o">=</span> <span class="n">rnum</span>
                <span class="c"># Do any necessary name munging to respect the PDB spec</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Element</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%-3s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">pa</span><span class="o">.</span><span class="n">name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">aname</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">charmm</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="s">&#39;segid&#39;</span><span class="p">):</span>
                    <span class="n">segid</span> <span class="o">=</span> <span class="n">pa</span><span class="o">.</span><span class="n">segid</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">segid</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atomrec</span> <span class="o">%</span> <span class="p">(</span><span class="n">anum</span> <span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span>
                           <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rnum</span><span class="p">,</span>
                           <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">occupancy</span><span class="p">,</span>
                           <span class="n">pa</span><span class="o">.</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">segid</span><span class="p">,</span>
                           <span class="n">Element</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">write_anisou</span> <span class="ow">and</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">anisou</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ani</span><span class="o">*</span><span class="mf">1e4</span><span class="p">)</span> <span class="k">for</span> <span class="n">ani</span> <span class="ow">in</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">]</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anisourec</span> <span class="o">%</span> <span class="p">(</span><span class="n">anum</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span>
                               <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rnum</span><span class="p">,</span>
                               <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">anisou</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                               <span class="n">Element</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">others</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">oatom</span> <span class="o">=</span> <span class="n">others</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xz</span>
                    <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                        <span class="n">nmore</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmore</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">anum</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_number</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="n">anum</span> <span class="o">-</span> <span class="n">anum</span> <span class="o">//</span> <span class="mi">100000</span> <span class="o">*</span> <span class="mi">100000</span>
                    <span class="n">last_number</span> <span class="o">=</span> <span class="n">anum</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">Element</span><span class="p">[</span><span class="n">oatom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">aname</span> <span class="o">=</span> <span class="s">&#39; </span><span class="si">%-3s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">oatom</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aname</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">charmm</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">oatom</span><span class="p">,</span> <span class="s">&#39;segid&#39;</span><span class="p">):</span>
                        <span class="n">segid</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">segid</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">segid</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                    <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">atomrec</span> <span class="o">%</span> <span class="p">(</span><span class="n">anum</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">occupancy</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">segid</span><span class="p">,</span>
                               <span class="n">Element</span><span class="p">[</span><span class="n">oatom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">write_anisou</span> <span class="ow">and</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">anisou</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">ani</span><span class="o">*</span><span class="mf">1e4</span><span class="p">)</span> <span class="k">for</span> <span class="n">ani</span> <span class="ow">in</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">]</span>
                        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">anisourec</span> <span class="o">%</span> <span class="p">(</span><span class="n">anum</span><span class="p">,</span> <span class="n">aname</span><span class="p">,</span>
                            <span class="n">oatom</span><span class="o">.</span><span class="n">altloc</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">rnum</span><span class="p">,</span>
                            <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                            <span class="n">anisou</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">anisou</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                            <span class="n">Element</span><span class="p">[</span><span class="n">oatom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s">&#39;&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">ter</span><span class="p">:</span>
                <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">terrec</span> <span class="o">%</span> <span class="p">(</span><span class="n">anum</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">rnum</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                    <span class="n">nmore</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">last_number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">dest</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%-80s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;END&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">#===================================================</span>
</div>
<div class="viewcode-block" id="Structure.write_cif"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.write_cif">[docs]</a>    <span class="k">def</span> <span class="nf">write_cif</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                  <span class="n">altlocs</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="n">write_anisou</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a PDB file from the current Structure instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dest : ``str or file-like``</span>
<span class="sd">            Either a file name or a file-like object containing a `write`</span>
<span class="sd">            method to which to write the PDB file. If it is a filename that</span>
<span class="sd">            ends with .gz or .bz2, a compressed version will be written using</span>
<span class="sd">            either gzip or bzip2, respectively.</span>
<span class="sd">        renumber : ``bool``</span>
<span class="sd">            If True, renumber the atoms and residues sequentially as they are</span>
<span class="sd">            stored in the structure.  If False, use the original numbering if</span>
<span class="sd">            it was assigned previously</span>
<span class="sd">        coordinates : ``array-like of float``</span>
<span class="sd">            If provided, these coordinates will be written to the PDB file</span>
<span class="sd">            instead of the coordinates stored in the structure. These</span>
<span class="sd">            coordinates should line up with the atom order in the structure</span>
<span class="sd">            (not necessarily the order of the &quot;original&quot; PDB file if they</span>
<span class="sd">            differ)</span>
<span class="sd">        altlocs : ``str``</span>
<span class="sd">            Keyword controlling which alternate locations are printed to the</span>
<span class="sd">            resulting PDB file. Allowable options are:</span>

<span class="sd">                - &#39;all&#39; : (default) print all alternate locations</span>
<span class="sd">                - &#39;first&#39; : print only the first alternate locations</span>
<span class="sd">                - &#39;occupancy&#39; : print the one with the largest occupancy. If two</span>
<span class="sd">                  conformers have the same occupancy, the first one to occur is</span>
<span class="sd">                  printed</span>

<span class="sd">            Input is case-insensitive, and partial strings are permitted as long</span>
<span class="sd">            as it is a substring of one of the above options that uniquely</span>
<span class="sd">            identifies the choice.</span>
<span class="sd">        write_anisou : ``bool``</span>
<span class="sd">            If True, an ANISOU record is written for every atom that has one. If</span>
<span class="sd">            False, ANISOU records are not written</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;all&#39;</span>
        <span class="k">elif</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;first&#39;</span>
        <span class="k">elif</span> <span class="n">altlocs</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;occupancy&#39;</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">altlocs</span><span class="p">)]:</span>
            <span class="n">altlocs</span> <span class="o">=</span> <span class="s">&#39;occupancy&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Illegal value of occupancy [</span><span class="si">%s</span><span class="s">]; expected &#39;all&#39;, &quot;</span>
                             <span class="s">&quot;&#39;first&#39;, or &#39;occupancy&#39;&quot;</span> <span class="o">%</span> <span class="n">altlocs</span><span class="p">)</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dest</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bz2&#39;</span><span class="p">):</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="c"># Make the main container</span>
        <span class="n">cont</span> <span class="o">=</span> <span class="n">containers</span><span class="o">.</span><span class="n">DataContainer</span><span class="p">(</span><span class="s">&#39;cell&#39;</span><span class="p">)</span>
        <span class="c"># Add cell info if applicable</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="n">containers</span><span class="o">.</span><span class="n">DataCategory</span><span class="p">(</span><span class="s">&#39;cell&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;length_a&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;length_b&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;length_c&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;angle_alpha&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;angle_beta&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">appendAttribute</span><span class="p">(</span><span class="s">&#39;angle_gamma&#39;</span><span class="p">)</span>
            <span class="n">cell</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">[:])</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coordinates</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">crdsize</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Cannot find length of coordinates&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crdsize</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="n">coordinates</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">coordinates</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unsupported coordinate dimensionality&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coords</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Unsupported coordinate shape&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">crdsize</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="n">coordinates</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Coordinates has unexpected shape&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">[[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="o">*</span><span class="n">coords</span><span class="p">))</span>
        <span class="c"># Create a function to process each atom and return which one we want</span>
        <span class="c"># to print, based on our alternate location choice</span>
        <span class="k">if</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">other_locations</span><span class="p">,</span> <span class="n">coords</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;first&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="k">return</span> <span class="n">atom</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="n">coords</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">altlocs</span> <span class="o">==</span> <span class="s">&#39;occupancy&#39;</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">):</span>
                <span class="n">occ</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">occupancy</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">atom</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">other_locations</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">occupancy</span> <span class="o">&gt;</span> <span class="n">occ</span><span class="p">:</span>
                        <span class="n">occ</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">occupancy</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Should not be here!&quot;</span><span class="p">)</span>
        <span class="c"># Now add the atom section. Include all names that the CIF standard</span>
        <span class="c"># usually includes, but put &#39;?&#39; in sections that contain data we don&#39;t</span>
        <span class="c"># store in the Structure, Residue, or Atom classes</span>
        <span class="n">cifatoms</span> <span class="o">=</span> <span class="n">containers</span><span class="o">.</span><span class="n">DataCategory</span><span class="p">(</span><span class="s">&#39;atom_site&#39;</span><span class="p">)</span>
        <span class="n">cont</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cifatoms</span><span class="p">)</span>
        <span class="n">cifatoms</span><span class="o">.</span><span class="n">setAttributeNameList</span><span class="p">(</span>
                <span class="p">[</span><span class="s">&#39;group_PDB&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;type_symbol&#39;</span><span class="p">,</span> <span class="s">&#39;label_atom_id&#39;</span><span class="p">,</span>
                 <span class="s">&#39;label_alt_id&#39;</span><span class="p">,</span> <span class="s">&#39;label_comp_id&#39;</span><span class="p">,</span> <span class="s">&#39;label_asym_id&#39;</span><span class="p">,</span>
                 <span class="s">&#39;label_entity_id&#39;</span><span class="p">,</span> <span class="s">&#39;label_seq_id&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_PDB_ins_code&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Cartn_x&#39;</span><span class="p">,</span> <span class="s">&#39;Cartn_y&#39;</span><span class="p">,</span> <span class="s">&#39;Cartn_z&#39;</span><span class="p">,</span> <span class="s">&#39;occupancy&#39;</span><span class="p">,</span> <span class="s">&#39;B_iso_or_equiv&#39;</span><span class="p">,</span>
                 <span class="s">&#39;Cartn_x_esd&#39;</span><span class="p">,</span> <span class="s">&#39;Cartn_y_esd&#39;</span><span class="p">,</span> <span class="s">&#39;Cartn_z_esd&#39;</span><span class="p">,</span> <span class="s">&#39;occupancy_esd&#39;</span><span class="p">,</span>
                 <span class="s">&#39;B_iso_or_equiv_esd&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_formal_charge&#39;</span><span class="p">,</span> <span class="s">&#39;auth_seq_id&#39;</span><span class="p">,</span>
                 <span class="s">&#39;auth_comp_id&#39;</span><span class="p">,</span> <span class="s">&#39;auth_asym_id&#39;</span><span class="p">,</span> <span class="s">&#39;auth_atom_id&#39;</span><span class="p">,</span>
                 <span class="s">&#39;pdbx_PDB_model_num&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c"># Generator expression here instead of list comp, since the generator</span>
        <span class="c"># need only execute until the first True (no point in wasting the time</span>
        <span class="c"># or space creating the entire list just to see if one is True...)</span>
        <span class="n">write_anisou</span> <span class="o">=</span> <span class="n">write_anisou</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
                                            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write_anisou</span><span class="p">:</span>
            <span class="n">cifanisou</span> <span class="o">=</span> <span class="n">containers</span><span class="o">.</span><span class="n">DataCategory</span><span class="p">(</span><span class="s">&#39;atom_site_anisotrop&#39;</span><span class="p">)</span>
            <span class="n">cont</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cifanisou</span><span class="p">)</span>
            <span class="n">cifanisou</span><span class="o">.</span><span class="n">setAttributeNameList</span><span class="p">(</span>
                    <span class="p">[</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;type_symbol&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_label_atom_id&#39;</span><span class="p">,</span>
                    <span class="s">&#39;pdbx_label_alt_id&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_label_comp_id&#39;</span><span class="p">,</span>
                    <span class="s">&#39;pdbx_label_asym_id&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_label_seq_id&#39;</span><span class="p">,</span> <span class="s">&#39;U[1][1]&#39;</span><span class="p">,</span>
                    <span class="s">&#39;U[2][2]&#39;</span><span class="p">,</span> <span class="s">&#39;U[3][3]&#39;</span><span class="p">,</span> <span class="s">&#39;U[1][2]&#39;</span><span class="p">,</span> <span class="s">&#39;U[1][3]&#39;</span><span class="p">,</span> <span class="s">&#39;U[2][3]&#39;</span><span class="p">,</span>
                    <span class="s">&#39;U[1][1]_esd&#39;</span><span class="p">,</span> <span class="s">&#39;U[2][2]_esd&#39;</span><span class="p">,</span> <span class="s">&#39;U[3][3]_esd&#39;</span><span class="p">,</span> <span class="s">&#39;U[1][2]_esd&#39;</span><span class="p">,</span>
                    <span class="s">&#39;U[1][3]_esd&#39;</span><span class="p">,</span> <span class="s">&#39;U[2][3]_esd&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_auth_seq_id&#39;</span><span class="p">,</span>
                    <span class="s">&#39;pdbx_auth_comp_id&#39;</span><span class="p">,</span> <span class="s">&#39;pdbx_auth_asym_id&#39;</span><span class="p">,</span>
                    <span class="s">&#39;pdbx_auth_atom_id&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="n">nmore</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># how many *extra* atoms have been added?</span>
        <span class="n">last_number</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">last_rnumber</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">atoms</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atoms</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">atom</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
                <span class="n">pa</span><span class="p">,</span> <span class="n">others</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">=</span> <span class="n">print_atoms</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">coords</span><span class="p">)</span>
                <span class="c"># Figure out the serial numbers we want to print</span>
                <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmore</span><span class="p">)</span>
                    <span class="n">rnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_number</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">rnum</span> <span class="o">=</span> <span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_rnumber</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">last_number</span> <span class="o">=</span> <span class="n">anum</span>
                <span class="n">last_rnumber</span> <span class="o">=</span> <span class="n">rnum</span>
                <span class="n">cifatoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">[</span><span class="s">&#39;ATOM&#39;</span><span class="p">,</span> <span class="n">anum</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                         <span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span>
                         <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">occupancy</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">bfactor</span><span class="p">,</span>
                         <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                         <span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">write_anisou</span> <span class="ow">and</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cifanisou</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="n">anum</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="n">pa</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                             <span class="n">pa</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                             <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                             <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">pa</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span>
                             <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">pa</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">others</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">oatom</span> <span class="o">=</span> <span class="n">others</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">xz</span>
                    <span class="k">if</span> <span class="n">renumber</span><span class="p">:</span>
                        <span class="n">nmore</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">anum</span> <span class="o">=</span> <span class="p">(</span><span class="n">pa</span><span class="o">.</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nmore</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">anum</span> <span class="o">=</span> <span class="n">oatom</span><span class="o">.</span><span class="n">number</span> <span class="ow">or</span> <span class="n">last_number</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="n">last_number</span> <span class="o">=</span> <span class="n">anum</span>
                    <span class="n">cifatoms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="p">[</span><span class="s">&#39;ATOM&#39;</span><span class="p">,</span> <span class="n">anum</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="n">oatom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                             <span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span>
                             <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">insertion_code</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">occupancy</span><span class="p">,</span>
                             <span class="n">oatom</span><span class="o">.</span><span class="n">bfactor</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span>
                             <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">write_anisou</span> <span class="ow">and</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">cifanisou</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">anum</span><span class="p">,</span> <span class="n">Element</span><span class="p">[</span><span class="n">oatom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
                                 <span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">altloc</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                                 <span class="n">rnum</span><span class="p">,</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                 <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">oatom</span><span class="o">.</span><span class="n">anisou</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span>
                                 <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="s">&#39;?&#39;</span><span class="p">,</span> <span class="n">rnum</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">chain</span><span class="p">,</span>
                                 <span class="n">oatom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                        <span class="p">)</span>
        <span class="c"># Now write the PDBx file</span>
        <span class="n">writer</span> <span class="o">=</span> <span class="n">PdbxWriter</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">([</span><span class="n">cont</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span>
            <span class="n">dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.topology"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.topology">[docs]</a>    <span class="k">def</span> <span class="nf">topology</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The OpenMM Topology object. Cached when possible, but any changes to the</span>
<span class="sd">        Structure instance results in the topology being deleted and rebuilt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_changed</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prune_empty_terms</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_topology</span> <span class="o">=</span> <span class="n">top</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">Topology</span><span class="p">()</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">last_chain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">chain</span>
            <span class="n">last_residue</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">last_omm_residue</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ChemError</span><span class="p">(</span><span class="s">&#39;No residues and/or atoms exist; &#39;</span>
                            <span class="s">&#39;cannot create Topology&#39;</span><span class="p">)</span>
        <span class="c"># Add the atoms</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="c"># See if we need to add a new residue</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">last_residue</span><span class="p">:</span>
                <span class="c"># See if we need a new chain</span>
                <span class="k">if</span> <span class="n">last_chain</span> <span class="o">!=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span><span class="p">:</span>
                    <span class="n">last_chain</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span>
                    <span class="n">chain</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addChain</span><span class="p">()</span>
                <span class="n">last_residue</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">residue</span>
                <span class="n">last_omm_residue</span> <span class="o">=</span> <span class="n">top</span><span class="o">.</span><span class="n">addResidue</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">element</span><span class="o">.</span><span class="n">Element</span><span class="o">.</span><span class="n">getByAtomicNumber</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">atomic_number</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">elem</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">top</span><span class="o">.</span><span class="n">addAtom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">last_omm_residue</span><span class="p">)</span>
        <span class="c"># Add the bonds</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">top</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">],</span> <span class="n">atoms</span><span class="p">[</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">])</span>
        <span class="c"># Set the unit cell dimensions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">top</span><span class="o">.</span><span class="n">setPeriodicBoxVectors</span><span class="p">(</span>
                    <span class="n">box_lengths_and_angles_to_vectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">top</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic positions for every atom in the system. If set with unitless</span>
<span class="sd">        numbers, those numbers are assumed to be in angstroms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">xz</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span>

    <span class="nd">@positions.setter</span>
<div class="viewcode-block" id="Structure.positions"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.positions">[docs]</a>    <span class="k">def</span> <span class="nf">positions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic positions for every atom in the system. If set with unitless</span>
<span class="sd">        numbers, those numbers are assumed to be in angstroms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="c"># See if the array is flattened</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="c"># It had better all be 3-length iterables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong shape for position array&#39;</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic velocities for every atom in the system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">a</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span><span class="n">a</span><span class="o">.</span><span class="n">vz</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">picosecond</span>

    <span class="nd">@velocities.setter</span>
<div class="viewcode-block" id="Structure.velocities"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.velocities">[docs]</a>    <span class="k">def</span> <span class="nf">velocities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A list of 3-element Quantity tuples of dimension length representing the</span>
<span class="sd">        atomic velocities for every atom in the system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">picoseconds</span><span class="p">)</span>
        <span class="c"># See if the array is flattened</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="c"># It had better all be 3-length iterables</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="n">i3</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">3</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">vx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">vz</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">i3</span><span class="p">:</span><span class="n">i3</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Wrong shape for velocities array&#39;</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        3, 3-element tuple of unit cell vectors that are Quantity objects of</span>
<span class="sd">        dimension length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">box_lengths_and_angles_to_vectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">)</span>

    <span class="nd">@box_vectors.setter</span>
<div class="viewcode-block" id="Structure.box_vectors"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.box_vectors">[docs]</a>    <span class="k">def</span> <span class="nf">box_vectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        3, 3-element tuple of unit cell vectors that are Quantity objects of</span>
<span class="sd">        dimension length</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">G</span><span class="p">)</span> <span class="o">=</span> <span class="n">box_vectors_to_lengths_and_angles</span><span class="p">(</span><span class="o">*</span><span class="n">value</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">B</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">G</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">create_array</span><span class="p">([</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">G</span><span class="p">])</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.createSystem"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.createSystem">[docs]</a>    <span class="k">def</span> <span class="nf">createSystem</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">8.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                     <span class="n">switchDistance</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                     <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">rigidWater</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">implicitSolvent</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">implicitSolventSaltConc</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liters</span><span class="p">,</span>
                     <span class="n">temperature</span><span class="o">=</span><span class="mf">298.15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                     <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                     <span class="n">useSASA</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">removeCMMotion</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">hydrogenMass</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                     <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                     <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                     <span class="n">forceNBFIX</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct an OpenMM System representing the topology described by the</span>
<span class="sd">        prmtop file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating point number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff.</span>
<span class="sd">        switchDistance : float or distance Quantity</span>
<span class="sd">            The distance at which the switching function is turned on for van</span>
<span class="sd">            der Waals interactions. This is ignored when no cutoff is used, and</span>
<span class="sd">            no switch is used if switchDistance is 0, negative, or greater than</span>
<span class="sd">            the cutoff</span>
<span class="sd">        constraints : None, app.HBonds, app.HAngles, or app.AllBonds</span>
<span class="sd">            Which type of constraints to add to the system (e.g., SHAKE). None</span>
<span class="sd">            means no bonds are constrained. HBonds means bonds with hydrogen are</span>
<span class="sd">            constrained</span>
<span class="sd">        rigidWater : bool=True</span>
<span class="sd">            If True, water is kept rigid regardless of the value of constraints.</span>
<span class="sd">            A value of False is ignored if constraints is not None.</span>
<span class="sd">        implicitSolvent : None, app.HCT, app.OBC1, app.OBC2, app.GBn, app.GBn2</span>
<span class="sd">            The Generalized Born implicit solvent model to use.</span>
<span class="sd">        implicitSolventKappa : float or 1/distance Quantity = None</span>
<span class="sd">            This is the Debye kappa property related to modeling saltwater</span>
<span class="sd">            conditions in GB. It should have units of 1/distance (1/nanometers</span>
<span class="sd">            is assumed if no units present). A value of None means that kappa</span>
<span class="sd">            will be calculated from implicitSolventSaltConc (below)</span>
<span class="sd">        implicitSolventSaltConc : float or amount/volume Quantity=0 moles/liter</span>
<span class="sd">            If implicitSolventKappa is None, the kappa will be computed from the</span>
<span class="sd">            salt concentration. It should have units compatible with mol/L</span>
<span class="sd">        temperature : float or temperature Quantity = 298.15 kelvin</span>
<span class="sd">            This is only used to compute kappa from implicitSolventSaltConc</span>
<span class="sd">        soluteDielectric : float=1.0</span>
<span class="sd">            The dielectric constant of the protein interior used in GB</span>
<span class="sd">        solventDielectric : float=78.5</span>
<span class="sd">            The dielectric constant of the water used in GB</span>
<span class="sd">        useSASA : bool=False</span>
<span class="sd">            If True, use the ACE non-polar solvation model. Otherwise, use no</span>
<span class="sd">            SASA-based nonpolar solvation model.</span>
<span class="sd">        removeCMMotion : bool=True</span>
<span class="sd">            If True, the center-of-mass motion will be removed periodically</span>
<span class="sd">            during the simulation. If False, it will not.</span>
<span class="sd">        hydrogenMass : float or mass quantity = None</span>
<span class="sd">            If not None, hydrogen masses will be changed to this mass and the</span>
<span class="sd">            difference subtracted from the attached heavy atom (hydrogen mass</span>
<span class="sd">            repartitioning)</span>
<span class="sd">        ewaldErrorTolerance : float=0.0005</span>
<span class="sd">            When using PME or Ewald, the Ewald parameters will be calculated</span>
<span class="sd">            from this value</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If False, the energies and forces from the constrained degrees of</span>
<span class="sd">            freedom will NOT be computed. If True, they will (but those degrees</span>
<span class="sd">            of freedom will *still* be constrained).</span>
<span class="sd">        verbose : bool=False</span>
<span class="sd">            If True, the progress of this subroutine will be printed to stdout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Establish defaults</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">System</span><span class="p">()</span>
        <span class="c"># Make sure periodic simulations have a box</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;No periodic boundary conditions detected&#39;</span><span class="p">)</span>
        <span class="c"># Do hydrogen mass repartitioning if necessary</span>
        <span class="n">masses</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">mass</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">hydrogenMass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">hydrogenMass</span><span class="p">):</span>
                <span class="n">hydrogenMass</span> <span class="o">=</span> <span class="n">hydrogenMass</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">dalton</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hydrogenMass</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Hydrogen mass must be positive&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">heavy_atom</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">bond_partners</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">a2</span><span class="o">.</span><span class="n">element</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">heavy_atom</span> <span class="o">=</span> <span class="n">a2</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">heavy_atom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">masses</span><span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hydrogenMass</span>
                        <span class="n">masses</span><span class="p">[</span><span class="n">heavy_atom</span><span class="o">.</span><span class="n">idx</span><span class="p">]</span> <span class="o">-=</span> <span class="n">hydrogenMass</span> <span class="o">-</span> <span class="n">atom</span><span class="o">.</span><span class="n">mass</span>
        <span class="k">for</span> <span class="n">mass</span> <span class="ow">in</span> <span class="n">masses</span><span class="p">:</span> <span class="n">system</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">mass</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omm_add_constraints</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">)</span>
        <span class="c"># Add the various types of forces</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding bonds...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_bond_force</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">,</span>
                                    <span class="n">flexibleConstraints</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding angles...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_angle_force</span><span class="p">(</span><span class="n">constraints</span><span class="p">,</span> <span class="n">flexibleConstraints</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding dihedrals...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_dihedral_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding Urey-Bradleys...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_urey_bradley_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding improper torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_improper_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding CMAP torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_cmap_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding trigonal angle terms...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_trigonal_angle_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding out-of-plane bends...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_out_of_plane_bend_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding pi-torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_pi_torsion_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding stretch-bends...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_stretch_bend_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding torsion-torsions...&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">omm_torsion_torsion_force</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding Nonbonded force...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">rf_dielc</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_dielc</span> <span class="o">=</span> <span class="mf">78.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">omm_nonbonded_force</span><span class="p">(</span><span class="n">nonbondedMethod</span><span class="p">,</span> <span class="n">nonbondedCutoff</span><span class="p">,</span>
                                         <span class="n">switchDistance</span><span class="p">,</span><span class="n">ewaldErrorTolerance</span><span class="p">,</span>
                                         <span class="n">rf_dielc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="k">print</span><span class="p">(</span><span class="s">&#39;Adding GB force...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">omm_gbsa_force</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="p">,</span>
                                        <span class="n">nonbondedCutoff</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span>
                                        <span class="n">solventDielectric</span><span class="p">,</span> <span class="n">implicitSolventKappa</span><span class="p">,</span>
                                        <span class="n">implicitSolventSaltConc</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span>
                                        <span class="n">useSASA</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">removeCMMotion</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CMMotionRemover</span><span class="p">())</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">system</span><span class="o">.</span><span class="n">setDefaultPeriodicBoxVectors</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box_vectors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">omm_set_virtual_sites</span><span class="p">(</span><span class="n">system</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">system</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_add_constraints"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_add_constraints">[docs]</a>    <span class="k">def</span> <span class="nf">omm_add_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">constraints</span><span class="p">,</span> <span class="n">rigidWater</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds constraints to a given system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : mm.System</span>
<span class="sd">            The OpenMM system for which constraints should be added</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            Which kind of constraints should be used</span>
<span class="sd">        rigidWater : bool</span>
<span class="sd">            If True, water bonds are constrained regardless of whether</span>
<span class="sd">            constrains is None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rigidWater</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">AllBonds</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Unrecognized constraints option (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span>
                             <span class="n">constraints</span><span class="p">)</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="c"># Rigid water only</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                <span class="c"># Skip all extra points... don&#39;t constrain those</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">WATER_NAMES</span> <span class="ow">or</span>
                        <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">WATER_NAMES</span><span class="p">):</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                         <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c"># Other types of constraints</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span> <span class="ow">or</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span>
                    <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
                <span class="n">num_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span>
                         <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">num_h</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">):</span>
                    <span class="c"># Constrain this angle</span>
                    <span class="n">l1</span> <span class="o">=</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                            <span class="n">l1</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">*</span> <span class="n">length_conv</span>
                        <span class="k">elif</span> <span class="n">bond</span> <span class="ow">in</span> <span class="n">angle</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                            <span class="n">l2</span> <span class="o">=</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span> <span class="o">*</span> <span class="n">length_conv</span>
                    <span class="c"># Law of cosines to find the constraint distance</span>
                    <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">l2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">continue</span> <span class="c"># no bonds found...</span>
                    <span class="n">cost</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="o">*</span><span class="n">DEG_TO_RAD</span><span class="p">)</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">l1</span><span class="o">*</span><span class="n">l1</span> <span class="o">+</span> <span class="n">l2</span><span class="o">*</span><span class="n">l2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">l1</span><span class="o">*</span><span class="n">l2</span><span class="o">*</span><span class="n">cost</span><span class="p">)</span><span class="o">*</span><span class="n">length_conv</span>
                    <span class="n">system</span><span class="o">.</span><span class="n">addConstraint</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_set_virtual_sites"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_set_virtual_sites">[docs]</a>    <span class="k">def</span> <span class="nf">omm_set_virtual_sites</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the virtual sites in a given OpenMM `System` object from the extra</span>
<span class="sd">        points defined in this system</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        system : mm.System</span>
<span class="sd">            The system for which the virtual sites will be set. All particles</span>
<span class="sd">            must have already been added to this System before calling this</span>
<span class="sd">            method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">system</span><span class="o">.</span><span class="n">getNumParticles</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;OpenMM System does not correspond to Structure&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">ExtraPoint</span><span class="p">):</span> <span class="k">continue</span>
            <span class="c"># This is a virtual site... get its frame type</span>
            <span class="n">typ</span> <span class="o">=</span> <span class="n">atom</span><span class="o">.</span><span class="n">frame_type</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">get_weights</span><span class="p">()</span>
            <span class="n">refatoms</span> <span class="o">=</span> <span class="n">typ</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">TwoParticleExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">TwoParticleAverageSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">ThreeParticleExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">ThreeParticleAverageSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                                    <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">OutOfPlaneExtraPointFrame</span><span class="p">):</span>
                <span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">refatoms</span>
                <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span> <span class="o">=</span> <span class="n">weights</span>
                <span class="n">system</span><span class="o">.</span><span class="n">setVirtualSite</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                        <span class="n">mm</span><span class="o">.</span><span class="n">OutOfPlaneSite</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">w3</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_bond_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_bond_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_bond_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rigidWater</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                       <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an OpenMM Bond Force object (or AmoebaBondForce if the bonds are</span>
<span class="sd">        for an Amoeba-parametrized system)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            The types of constraints that are on the system. If</span>
<span class="sd">            flexibleConstraints is False, then the constrained bonds will not be</span>
<span class="sd">            added to the resulting Force</span>
<span class="sd">        rigidWater : bool=True</span>
<span class="sd">            Should water-H bonds be constrained regardless of `constraints`?</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If True, all bonds are added to the force regardless of</span>
<span class="sd">            `constraints`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force</span>
<span class="sd">            HarmonicBondForce (or AmoebaBondForce if this is an Amoeba system),</span>
<span class="sd">            or None if there are no bonds to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">flexibleConstraints</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">HAngles</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">AllBonds</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span> <span class="c"># No bonds to add</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">_ambfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">_ommfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">_ambfrc</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">_ommfrc</span><span class="p">)</span>
        <span class="c"># See if we need to add Amoeba bonds or regular bonds</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaBondForce</span><span class="p">()</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setGlobalBondCubic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">length_conv</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setGlobalBondQuartic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bond_types</span><span class="o">.</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="n">length_conv</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">BOND_FORCE_GROUP</span><span class="p">)</span>
        <span class="c"># Add the bonds</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="ow">not</span> <span class="n">flexibleConstraints</span> <span class="ow">and</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HBonds</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find necessary parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                          <span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">bond</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="c"># Done adding the force</span>
        <span class="k">if</span> <span class="n">force</span><span class="o">.</span><span class="n">getNumBonds</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_angle_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_angle_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_angle_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">flexibleConstraints</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an OpenMM HarmonicAngleForce object (or AmoebaAngleForce if the</span>
<span class="sd">        angles are for an Amoeba-parametrized system)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        constraints : None, app.HBonds, app.AllBonds, or app.HAngles</span>
<span class="sd">            The types of constraints that are on the system. If</span>
<span class="sd">            flexibleConstraints is False, then the constrained bonds will not be</span>
<span class="sd">            added to the resulting Force</span>
<span class="sd">        flexibleConstraints : bool=True</span>
<span class="sd">            If True, all bonds are added to the force regardless of</span>
<span class="sd">            `constraints`</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        force</span>
<span class="sd">            HarmonicAngleForce (or AmoebaAngleForce if this is an Amoeba</span>
<span class="sd">            system), or None if there are no angles to add</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle_types</span><span class="o">.</span><span class="n">coeffs</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaAngleForce</span><span class="p">()</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAnglePentic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalAngleSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicAngleForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ANGLE_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">num_h</span> <span class="o">=</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">+</span>
                     <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">constraints</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HAngles</span> <span class="ow">and</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="p">(</span><span class="n">num_h</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">flexibleConstraints</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">angle</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find angle parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                           <span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">angle</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">force</span><span class="o">.</span><span class="n">getNumAngles</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_dihedral_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_dihedral_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_dihedral_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM PeriodicTorsionForce modeling dihedrals</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PeriodicTorsionForce</span>
<span class="sd">            Or None if no torsions are present in this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">PeriodicTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">DIHEDRAL_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">tor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find torsion parameters&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="n">tor</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                     <span class="nb">int</span><span class="p">(</span><span class="n">typ</span><span class="o">.</span><span class="n">per</span><span class="p">),</span> <span class="n">typ</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span>
                                     <span class="n">typ</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                 <span class="n">tor</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">per</span><span class="p">),</span>
                                 <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phase</span><span class="p">,</span> <span class="n">tor</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_urey_bradley_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_urey_bradley_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_urey_bradley_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM Urey-Bradley force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        HarmonicBondForce</span>
<span class="sd">            Or None, if no urey-bradleys are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">_ambfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalorie_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">_ommfrc</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilojoule_per_mole</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">_ambfrc</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">_ommfrc</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">HarmonicBondForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">UREY_BRADLEY_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">urey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">urey</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find urey-bradley parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addBond</span><span class="p">(</span><span class="n">urey</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">urey</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                          <span class="n">urey</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">urey</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_improper_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_improper_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_improper_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM improper torsion force (quadratic bias)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CustomTorsionForce</span>
<span class="sd">            With the formula k*(phi-phi0)^2, or None if there are no impropers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CustomTorsionForce</span><span class="p">(</span><span class="s">&quot;k*(theta-theta0)^2&quot;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s">&#39;k&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">addPerTorsionParameter</span><span class="p">(</span><span class="s">&#39;theta0&#39;</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">IMPROPER_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">imp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">imp</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find improper torsion &#39;</span>
                                       <span class="s">&#39;parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">,</span>
                             <span class="n">imp</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">psi_eq</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_cmap_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_cmap_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_cmap_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM CMAP torsion force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        CMAPTorsionForce</span>
<span class="sd">            Or None, if no CMAP terms are present</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">CMAPTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CMAP_FORCE_GROUP</span><span class="p">)</span>
        <span class="c"># First get the list of cmap maps we&#39;re going to use. Just store the IDs</span>
        <span class="c"># so we have simple integer comparisons to do later</span>
        <span class="n">cmap_type_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cmap_map</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmap</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Cannot find CMAP torsion parameters&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">id</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cmap_type_list</span><span class="p">:</span>
                <span class="n">ct</span> <span class="o">=</span> <span class="n">cmap</span><span class="o">.</span><span class="n">type</span>
                <span class="n">cmap_type_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">ct</span><span class="p">))</span>
                <span class="c"># OpenMM takes the correction maps in the range 0 to 360</span>
                <span class="c"># degrees, but we store it in -180 -- 180 (and in the transpose</span>
                <span class="c"># of what OpenMM expects).</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">switch_range</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">force</span><span class="o">.</span><span class="n">addMap</span><span class="p">(</span><span class="n">ct</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">*</span><span class="n">frc_conv</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">grid</span><span class="p">])</span>
                <span class="n">cmap_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">ct</span><span class="p">)]</span> <span class="o">=</span> <span class="n">m</span>
        <span class="c"># Now add all of the cmaps</span>
        <span class="k">for</span> <span class="n">cmap</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addTorsion</span><span class="p">(</span><span class="n">cmap_map</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">type</span><span class="p">)],</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                             <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_nonbonded_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_nonbonded_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_nonbonded_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mi">8</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">switchDistance</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                            <span class="n">ewaldErrorTolerance</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">,</span>
                            <span class="n">reactionFieldDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the OpenMM NonbondedForce instance</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating point number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff.</span>
<span class="sd">        switchDistance : float or distance Quantity</span>
<span class="sd">            The distance at which the switching function is turned on for van</span>
<span class="sd">            der Waals interactions. This is ignored when no cutoff is used, and</span>
<span class="sd">            no switch is used if switchDistance is 0, negative, or greater than</span>
<span class="sd">            the cutoff</span>
<span class="sd">        ewaldErrorTolerance : float=0.0005</span>
<span class="sd">            When using PME or Ewald, the Ewald parameters will be calculated</span>
<span class="sd">            from this value</span>
<span class="sd">        reactionFieldDielectric : float=78.5</span>
<span class="sd">            If the nonbondedMethod is CutoffPeriodic or CutoffNonPeriodic, the</span>
<span class="sd">            region beyond the cutoff is treated using a reaction field method</span>
<span class="sd">            with this dielectric constant. It should be set to 1 if another</span>
<span class="sd">            implicit solvent model is being used (e.g., GB)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        NonbondedForce</span>
<span class="sd">            This just implements the very basic NonbondedForce with the typical</span>
<span class="sd">            charge-charge and 12-6 Lennard-Jones interactions with the</span>
<span class="sd">            Lorentz-Berthelot combining rules.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Subclasses of Structure for which this nonbonded treatment is inadequate</span>
<span class="sd">        should override this method to implement what is needed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="n">ene_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">):</span>
            <span class="n">nonbondedCutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">PME</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">PME</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="n">ewaldErrorTolerance</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">Ewald</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">NonbondedForce</span><span class="o">.</span><span class="n">Ewald</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setEwaldErrorTolerance</span><span class="p">(</span><span class="n">ewaldErrorTolerance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized nonbondedMethod (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                             <span class="n">nonbondedMethod</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setReactionFieldDielectric</span><span class="p">(</span><span class="n">reactionFieldDielectric</span><span class="p">)</span>
        <span class="c"># Now add the particles</span>
        <span class="n">sigma_scale</span> <span class="o">=</span> <span class="n">length_conv</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">rmin</span><span class="o">*</span><span class="n">sigma_scale</span><span class="p">,</span>
                              <span class="nb">abs</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">epsilon</span><span class="o">*</span><span class="n">ene_conv</span><span class="p">))</span>
        <span class="c"># Now add the exceptions. First add potential 1-4&#39;s from the dihedrals.</span>
        <span class="c"># If dihedral.ignore_end is False, a 1-4 is added with the appropriate</span>
        <span class="c"># scaling factor</span>
        <span class="n">sigma_scale</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">length_conv</span>
        <span class="k">for</span> <span class="n">dih</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dih</span><span class="o">.</span><span class="n">ignore_end</span><span class="p">:</span> <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DihedralTypeList</span><span class="p">):</span>
                <span class="n">scee</span> <span class="o">=</span> <span class="n">scnb</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">scee</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">scnb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
                    <span class="n">scee</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scee</span>
                    <span class="n">scnb</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scnb</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c"># Scaling factors of 0 will result in divide-by-zero errors. So</span>
                <span class="c"># force them to 1.</span>
                <span class="n">scee</span> <span class="o">=</span> <span class="n">scee</span> <span class="ow">or</span> <span class="mf">1.0</span>
                <span class="n">scnb</span> <span class="o">=</span> <span class="n">scnb</span> <span class="ow">or</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scee</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scee</span>
                <span class="n">scnb</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">scnb</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">rij</span><span class="p">,</span> <span class="n">wdij</span><span class="p">,</span> <span class="n">rij14</span><span class="p">,</span> <span class="n">wdij14</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">atom_type</span><span class="o">.</span><span class="n">nbfix</span><span class="p">[</span>
                                                <span class="nb">str</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">atom_type</span><span class="p">)]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                <span class="n">sigprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">rmin_14</span> <span class="o">+</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">rmin_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_scale</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="n">wdij14</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                <span class="n">sigprod</span> <span class="o">=</span> <span class="n">rij</span> <span class="o">*</span> <span class="n">length_conv</span> <span class="o">*</span> <span class="n">sigma_scale</span>
            <span class="n">chgprod</span> <span class="o">=</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">charge</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">charge</span> <span class="o">/</span> <span class="n">scee</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span>
                               <span class="n">sigprod</span><span class="p">,</span> <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                <span class="n">sigprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">rmin_14</span> <span class="o">+</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">rmin_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_scale</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span> <span class="n">sigprod</span><span class="p">,</span>
                                   <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                <span class="n">sigprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">rmin_14</span> <span class="o">+</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">rmin_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_scale</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">child</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span> <span class="n">sigprod</span><span class="p">,</span>
                                   <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">dih</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">epsilon_14</span> <span class="o">*</span> <span class="n">c2</span><span class="o">.</span><span class="n">epsilon_14</span><span class="p">)</span>
                    <span class="n">epsprod</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">epsprod</span><span class="p">)</span> <span class="o">*</span> <span class="n">ene_conv</span> <span class="o">/</span> <span class="n">scnb</span>
                    <span class="n">sigprod</span> <span class="o">=</span> <span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">rmin_14</span> <span class="o">+</span> <span class="n">c2</span><span class="o">.</span><span class="n">rmin_14</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_scale</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">chgprod</span><span class="p">,</span> <span class="n">sigprod</span><span class="p">,</span>
                                       <span class="n">epsprod</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="c"># Now add the bonds, angles, and exclusions. These will always wipe out</span>
        <span class="c"># existing exceptions and 0 out that exception</span>
        <span class="k">for</span> <span class="n">bond</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">angle</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">a2</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">exclusion_partners</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">a2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c1</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c2</span> <span class="ow">in</span> <span class="n">a2</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="n">force</span><span class="o">.</span><span class="n">addException</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">c2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">switchDistance</span> <span class="ow">and</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">switchDistance</span><span class="p">):</span>
                <span class="n">switchDistance</span> <span class="o">=</span> <span class="n">switchDistance</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">switchDistance</span> <span class="o">&lt;</span> <span class="n">nonbondedCutoff</span><span class="p">:</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setUseSwitchingFunction</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">force</span><span class="o">.</span><span class="n">setSwitchingDistance</span><span class="p">(</span><span class="n">switchDistance</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_gbsa_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_gbsa_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_gbsa_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">,</span>
                       <span class="n">nonbondedMethod</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">nonbondedCutoff</span><span class="o">=</span><span class="mf">30.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="p">,</span>
                       <span class="n">soluteDielectric</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">solventDielectric</span><span class="o">=</span><span class="mf">78.5</span><span class="p">,</span>
                       <span class="n">implicitSolventKappa</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                       <span class="n">implicitSolventSaltConc</span><span class="o">=</span><span class="mf">0.0</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liter</span><span class="p">,</span>
                       <span class="n">temperature</span><span class="o">=</span><span class="mf">298.15</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">,</span>
                       <span class="n">useSASA</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a Generalized Born force for running implicit solvent</span>
<span class="sd">        calculations</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        implicitSolvent : app.HCT, app.OBC1, app.OBC2, app.GBn, app.GBn2</span>
<span class="sd">            The Generalized Born implicit solvent model to use.</span>
<span class="sd">        nonbondedMethod : cutoff method</span>
<span class="sd">            This is the cutoff method. It can be either the NoCutoff,</span>
<span class="sd">            CutoffNonPeriodic, CutoffPeriodic, PME, or Ewald objects from the</span>
<span class="sd">            simtk.openmm.app namespace. Default is NoCutoff</span>
<span class="sd">        nonbondedCutoff : float or distance Quantity</span>
<span class="sd">            The nonbonded cutoff must be either a floating opint number</span>
<span class="sd">            (interpreted as nanometers) or a Quantity with attached units. This</span>
<span class="sd">            is ignored if nonbondedMethod is NoCutoff</span>
<span class="sd">        implicitSolventKappa : float or 1/distance Quantity = None</span>
<span class="sd">            This is the Debye kappa property related to modeling saltwater</span>
<span class="sd">            conditions in GB. It should have units of 1/distance (1/nanometers</span>
<span class="sd">            is assumed if no units present). A value of None means that kappa</span>
<span class="sd">            will be calculated from implicitSolventSaltConc (below)</span>
<span class="sd">        implicitSolventSaltConc : float or amount/volume Quantity=0 moles/liter</span>
<span class="sd">            If implicitSolventKappa is None, the kappa will be computed from the</span>
<span class="sd">            salt concentration. It should have units compatible with mol/L</span>
<span class="sd">        temperature : float or temperature Quantity = 298.15 kelvin</span>
<span class="sd">            This is only used to compute kappa from implicitSolventSaltConc</span>
<span class="sd">        soluteDielectric : float=1.0</span>
<span class="sd">            The dielectric constant of the protein interior used in GB</span>
<span class="sd">        solventDielectric : float=78.5</span>
<span class="sd">            The dielectric constant of the water used in GB</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">simtk.openmm.app.internal.customgbforces</span> <span class="kn">import</span> <span class="p">(</span><span class="n">GBSAHCTForce</span><span class="p">,</span>
                <span class="n">GBSAOBC1Force</span><span class="p">,</span> <span class="n">GBSAOBC2Force</span><span class="p">,</span> <span class="n">GBSAGBnForce</span><span class="p">,</span> <span class="n">GBSAGBn2Force</span><span class="p">,</span>
                <span class="n">convertParameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">useSASA</span><span class="p">:</span>
            <span class="n">sasa</span> <span class="o">=</span> <span class="s">&#39;ACE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sasa</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nonbondedMethod</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">HCT</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">,</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">,</span>
                <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unrecognized implicit solvent model&#39;</span><span class="p">)</span>
        <span class="n">gb_parms</span> <span class="o">=</span> <span class="n">convertParameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_gb_parameters</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">),</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="n">implicitSolvent</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">implicitSolventKappa</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">implicitSolventSaltConc</span><span class="p">):</span>
                <span class="n">sc</span> <span class="o">=</span> <span class="n">implicitSolventSaltConc</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">moles</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">liter</span><span class="p">)</span>
                <span class="n">implicitSolventSaltConc</span> <span class="o">=</span> <span class="n">sc</span>
            <span class="k">if</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">temperature</span><span class="p">):</span>
                <span class="n">temperature</span> <span class="o">=</span> <span class="n">temperature</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kelvin</span><span class="p">)</span>
            <span class="c"># The constant is 1 / sqrt(eps_0 * kB / (2*NA*q^2*1000)) where NA is</span>
            <span class="c"># Avogadro&#39;s number, eps_0 is the permittivity of free space, q is</span>
            <span class="c"># the charge (this # matches Amber&#39;s conversion factor)</span>
            <span class="n">implicitSolventKappa</span> <span class="o">=</span> <span class="mf">50.33355</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">implicitSolventSaltConc</span>
                                          <span class="o">/</span> <span class="n">solventDielectric</span> <span class="o">/</span> <span class="n">temperature</span><span class="p">)</span>
            <span class="c"># Multiply by 0.73 to account for ion exclusions, and multiply by 10</span>
            <span class="c"># to convert to 1/nm from 1/angstroms</span>
            <span class="n">implicitSolventKappa</span> <span class="o">*=</span> <span class="mf">7.3</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">implicitSolventKappa</span><span class="p">):</span>
            <span class="n">implicitSolventKappa</span> <span class="o">=</span> <span class="n">implicitSolventKappa</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="o">**-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">u</span><span class="o">.</span><span class="n">is_quantity</span><span class="p">(</span><span class="n">nonbondedCutoff</span><span class="p">):</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span><span class="o">.</span><span class="n">value_in_unit</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cutoff</span> <span class="o">=</span> <span class="n">nonbondedCutoff</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">HCT</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAHCTForce</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                 <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC1</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAOBC1Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">OBC2</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAOBC2Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAGBnForce</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                 <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="n">force</span> <span class="o">=</span> <span class="n">GBSAGBn2Force</span><span class="p">(</span><span class="n">solventDielectric</span><span class="p">,</span> <span class="n">soluteDielectric</span><span class="p">,</span> <span class="n">sasa</span><span class="p">,</span>
                                  <span class="n">cutoff</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">implicitSolventKappa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Unexpected implicit solvent model... &#39;</span>
                             <span class="s">&#39;should not be here&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addParticle</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">charge</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">gb_parms</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="c"># Set cutoff method</span>
        <span class="k">if</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">NoCutoff</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">nonbondedMethod</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">:</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffNonPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># cutoff periodic (PME, CutoffPeriodic, Ewald)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setNonbondedMethod</span><span class="p">(</span><span class="n">mm</span><span class="o">.</span><span class="n">CustomGBForce</span><span class="o">.</span><span class="n">CutoffPeriodic</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">setCutoffDistance</span><span class="p">(</span><span class="n">cutoff</span><span class="p">)</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">NONBONDED_FORCE_GROUP</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>

    <span class="c"># Amoeba-specific forces below</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_trigonal_angle_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_trigonal_angle_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_trigonal_angle_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba trigonal-angle force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaInPlaneAngleForce</span>
<span class="sd">            The trigonal in-plane Angle force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Do not have the trigonal angle force &#39;</span>
                                   <span class="s">&#39;table parameters&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaInPlaneAngleForce</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angle_types</span><span class="o">.</span><span class="n">coeffs</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleQuintic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalInPlaneAngleSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TRIGONAL_ANGLE_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Missing trigonal angle parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addAngle</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                           <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">theteq</span><span class="p">,</span>
                           <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_out_of_plane_bend_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_out_of_plane_bend_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_out_of_plane_bend_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba out-of-plane bend force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaOutOfPlaneBendForce</span>
<span class="sd">            The out-of-plane bend Angle force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span> <span class="s">&#39;degree&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="p">,</span> <span class="s">&#39;coeffs&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Do not have the trigonal angle force &#39;</span>
                                   <span class="s">&#39;table parameters&#39;</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaOutOfPlaneBendForce</span><span class="p">()</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bend_types</span><span class="o">.</span><span class="n">coeffs</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendCubic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendQuartic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendQuintic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setAmoebaGlobalOutOfPlaneBendSextic</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">OUT_OF_PLANE_BEND_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Missing out-of-plane bend parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addOutOfPlaneBend</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                    <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_pi_torsion_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_pi_torsion_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_pi_torsion_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Creates the Amoeba pi-torsion force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaPiTorsionForce</span>
<span class="sd">            The pi-torsion force</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">kilocalories</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">kilojoules</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaPiTorsionForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">PI_TORSION_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ang</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ang</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&#39;Missing pi-torsion parameters&#39;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addPiTorsion</span><span class="p">(</span><span class="n">ang</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="n">ang</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ang</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                               <span class="n">ang</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">phi_k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">force</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_stretch_bend_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_stretch_bend_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_stretch_bend_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the OpenMM Amoeba stretch-bend force for this system</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaStretchBendForce</span>
<span class="sd">            The stretch-bend force containing all terms in this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Conversion factor taken from pyopenmm/processTinkerForceField.py</span>
        <span class="n">frc_conv</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="mf">41.84</span> <span class="c"># 4.184 * 10</span>
        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstroms</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometers</span><span class="p">)</span>
        <span class="n">force</span> <span class="o">=</span> <span class="n">mm</span><span class="o">.</span><span class="n">AmoebaStretchBendForce</span><span class="p">()</span>
        <span class="n">force</span><span class="o">.</span><span class="n">setForceGroup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">STRETCH_BEND_FORCE_GROUP</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">strbnd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">MissingParameter</span><span class="p">(</span><span class="s">&quot;Missing stretch-bend parameters&quot;</span><span class="p">)</span>
            <span class="n">force</span><span class="o">.</span><span class="n">addStretchBend</span><span class="p">(</span><span class="n">strbnd</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req1</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">req2</span><span class="o">*</span><span class="n">length_conv</span><span class="p">,</span>
                                 <span class="n">strbnd</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">k</span><span class="o">*</span><span class="n">frc_conv</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="nd">@needs_openmm</span>
<div class="viewcode-block" id="Structure.omm_torsion_torsion_force"><a class="viewcode-back" href="../../structobj/chemistry.structure.Structure.html#chemistry.structure.Structure.omm_torsion_torsion_force">[docs]</a>    <span class="k">def</span> <span class="nf">omm_torsion_torsion_force</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Create the OpenMM Amoeba coupled-torsion (CMAP) force</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AmoebaTorsionTorsionForce</span>
<span class="sd">            The torsion-torsion (CMAP) force with all coupled-torsion parameters</span>
<span class="sd">            for this system</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">:</span> <span class="k">return</span> <span class="bp">None</span>
        <span class="c"># Not implemented yet...</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Torsion-torsions found, but not yet implemented!&quot;</span><span class="p">,</span>
                      <span class="n">MissingParameterWarning</span><span class="p">)</span>

    <span class="c">#===================================================</span>
</div>
    <span class="k">def</span> <span class="nf">_prune_empty_bonds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty bonds &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">))):</span>
            <span class="n">bond</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">bond</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">bond</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bonds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty angles &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">))):</span>
            <span class="n">angle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">angle</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">angle</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">angle</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">angle</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_dihedrals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty dihedrals &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">))):</span>
            <span class="n">dihed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">dihed</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">dihed</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">dihed</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">dihed</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">dihedrals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_ureys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty Urey-Bradley terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">))):</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ub</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">ub</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">urey_bradleys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_impropers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty improper torsions &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">))):</span>
            <span class="n">imp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">imp</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">imp</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">imp</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">imp</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">impropers</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_cmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty CMAP terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">))):</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">cmap</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cmap</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">cmap</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">cmap</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmaps</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_trigonal_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty trigonal angles &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">))):</span>
            <span class="n">ta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">ta</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">ta</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">ta</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">ta</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigonal_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_out_of_plane_bends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty out-of-plane bends &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">))):</span>
            <span class="n">oop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">oop</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">oop</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">oop</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">oop</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_of_plane_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_pi_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty pi-torsions &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">))):</span>
            <span class="n">pit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">pit</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom6</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">pit</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">pit</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">pit</span><span class="o">.</span><span class="n">atom6</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pi_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_stretch_bends</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty stretch-bend terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">))):</span>
            <span class="n">sb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">sb</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">sb</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">sb</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="c"># Not stored anywhere, no need to call delete()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">stretch_bends</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_torsion_torsions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty torsion-torsion terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">))):</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom3</span> <span class="ow">is</span> <span class="bp">None</span>
                    <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom4</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom5</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">tt</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">tt</span><span class="o">.</span><span class="n">atom3</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">tt</span><span class="o">.</span><span class="n">atom4</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span>
                    <span class="n">tt</span><span class="o">.</span><span class="n">atom5</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">tt</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">torsion_torsions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_chiral_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty chiral frame terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">))):</span>
            <span class="n">cf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">cf</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">chiral_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_multipole_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty multipole frame terms &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">))):</span>
            <span class="n">mf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">mf</span><span class="o">.</span><span class="n">atom</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">mf</span><span class="o">.</span><span class="n">atom</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">multipole_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="k">def</span> <span class="nf">_prune_empty_adjusts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets rid of any empty nonbonded exception adjustments &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">))):</span>
            <span class="n">adj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom1</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom1</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">adj</span><span class="o">.</span><span class="n">atom2</span><span class="o">.</span><span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjusts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="c">#===================================================</span>

    <span class="nd">@needs_openmm</span>
    <span class="k">def</span> <span class="nf">_get_gb_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Gets the GB parameters for the requested GB model used by OpenMM</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        implicitSolvent : app.HCT, app.OBC1, app.OBC2, app.GBn, or app.GBn2</span>
<span class="sd">            The object specifying a particular GB model in OpenMM</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        parameters : list of float</span>
<span class="sd">            List of parameters for the requested GB model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn</span><span class="p">:</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.48435382330</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.09085413633</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.700147318409</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.06557401132</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.602256336067</span>
                <span class="k">if</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_bondi</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="c"># Add non-optimized values as defaults</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.8</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="p">[</span><span class="mf">4.85</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.058554</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.733756</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.506378</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.205844</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.425952</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.788440</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.798699</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.437334</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">7</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.733599</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.503364</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.316828</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.192915</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.061039</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.867814</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.876635</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.387882</span>
                <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span> <span class="o">==</span> <span class="mi">16</span><span class="p">:</span>
                    <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.703469</span>
                    <span class="n">alpha</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.867814</span>
                    <span class="n">beta</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.876635</span>
                    <span class="n">gamma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.387882</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_mbondi3</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">radii</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="n">screen</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">screen</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="c"># Replace with defaults</span>
                    <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">screen</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_gb_rad_screen</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">implicitSolvent</span><span class="p">)</span>

        <span class="n">length_conv</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">angstrom</span><span class="o">.</span><span class="n">conversion_factor_to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">nanometer</span><span class="p">)</span>
        <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">length_conv</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">radii</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">implicitSolvent</span> <span class="ow">is</span> <span class="n">app</span><span class="o">.</span><span class="n">GBn2</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">screen</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">radii</span><span class="p">,</span> <span class="n">screen</span><span class="p">)</span>

    <span class="c">#===================================================</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_force_to_system</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">force</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Adds an OpenMM force to a system IFF the force is not None &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">force</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="k">return</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">force</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="c"># It&#39;s possible we got multiple forces to add</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">force</span><span class="p">:</span>
                <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">system</span><span class="o">.</span><span class="n">addForce</span><span class="p">(</span><span class="n">force</span><span class="p">)</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</div>
<div class="viewcode-block" id="read_PDB"><a class="viewcode-back" href="../../structobj/chemistry.structure.read_PDB.html#chemistry.structure.read_PDB">[docs]</a><span class="k">def</span> <span class="nf">read_PDB</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PDB file and return a populated `Structure` class</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : ``str or file-like``</span>
<span class="sd">        Name of PDB file to read, or a file-like object that can iterate over</span>
<span class="sd">        the lines of a PDB. Compressed file names can be specified and are</span>
<span class="sd">        determined by file-name extension (e.g., file.pdb.gz, file.pdb.bz2)</span>

<span class="sd">    Metadata</span>
<span class="sd">    --------</span>
<span class="sd">    The PDB parser also adds metadata to the returned Structure object that may</span>
<span class="sd">    be present in the PDB file</span>

<span class="sd">    experimental : ``str``</span>
<span class="sd">        EXPDTA record</span>
<span class="sd">    journal : ``str``</span>
<span class="sd">        JRNL record</span>
<span class="sd">    authors : ``str``</span>
<span class="sd">        AUTHOR records</span>
<span class="sd">    keywords : ``str``</span>
<span class="sd">        KEYWDS records</span>
<span class="sd">    doi : ``str``</span>
<span class="sd">        DOI from the JRNL record</span>
<span class="sd">    pmid : ``str``</span>
<span class="sd">        PMID from the JRNL record</span>
<span class="sd">    journal_authors : ``str``</span>
<span class="sd">        Author info from the JRNL record</span>
<span class="sd">    volume : ``str``</span>
<span class="sd">        Volume of the published article from the JRNL record</span>
<span class="sd">    page : ``str``</span>
<span class="sd">        Page of the published article from the JRNL record</span>
<span class="sd">    title : ``str``</span>
<span class="sd">        TITL section of the JRNL record</span>
<span class="sd">    year : ``int``</span>
<span class="sd">        Year that the article was published, from the JRNL record</span>
<span class="sd">    related_entries : ``list of (str, str)``</span>
<span class="sd">        List of entries in other databases</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structure</span>
<span class="sd">    </span>
<span class="sd">    structure : :class:`Structure`</span>
<span class="sd">        The Structure object initialized with all of the information from the</span>
<span class="sd">        PDB file.  No bonds or other topological features are added by default.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The returned structure has an extra attribute, pdbxyz, that contains all of</span>
<span class="sd">    the coordinates for all of the frames in the PDB file as a list of NATOM*3</span>
<span class="sd">    lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">relatere</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gzip</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;gzip is not available for compressed PDB&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bz2&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bz2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;bz2 is not available for compressed PDB&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
    <span class="c"># Add metadata fields</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">experimental</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">pmid</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">journal_authors</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">volume_page</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">related_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">modelno</span> <span class="o">=</span> <span class="mi">1</span> <span class="c"># For PDB files with multiple MODELs</span>
    <span class="n">atomno</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">all_coordinates</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c"># Support hexadecimal numbering like that printed by VMD</span>
    <span class="n">last_atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">()</span>
    <span class="n">last_atom_added</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">last_resid</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">resend</span> <span class="o">=</span> <span class="mi">26</span>
    <span class="n">res_hex</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">atom_hex</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">atom_overflow</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">ZEROSET</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;0&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileobj</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;ascii&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># Assume this is a string in Py3 which doesn&#39;t have &#39;decode&#39;</span>
                <span class="k">pass</span>
            <span class="n">rec</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;ATOM  &#39;</span> <span class="ow">or</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;HETATM&#39;</span><span class="p">:</span>
                <span class="n">atomno</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">atnum</span><span class="p">,</span> <span class="n">atname</span><span class="p">,</span> <span class="n">altloc</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span>
                <span class="n">resname</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">resid</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="n">resend</span><span class="p">]</span>
                <span class="n">inscode</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">38</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">38</span><span class="p">:</span><span class="mi">46</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">54</span><span class="p">]</span>
                <span class="n">occupancy</span><span class="p">,</span> <span class="n">bfactor</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">54</span><span class="p">:</span><span class="mi">60</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">60</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span>
                <span class="n">elem</span><span class="p">,</span> <span class="n">chg</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">76</span><span class="p">:</span><span class="mi">78</span><span class="p">],</span> <span class="n">line</span><span class="p">[</span><span class="mi">78</span><span class="p">:</span><span class="mi">80</span><span class="p">]</span>
                <span class="n">segid</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">72</span><span class="p">:</span><span class="mi">76</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="c"># CHARMM-specific</span>
                <span class="n">atname</span> <span class="o">=</span> <span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">altloc</span> <span class="o">=</span> <span class="n">altloc</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">resname</span> <span class="o">=</span> <span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">inscode</span> <span class="o">=</span> <span class="n">inscode</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="n">elem</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%-2s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">elem</span> <span class="c"># Make sure we have at least 2 characters</span>
                <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atsym</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">atsym</span><span class="p">]</span>
                    <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">atsym</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c"># Now try based on the atom name... but don&#39;t try too hard</span>
                    <span class="c"># (e.g., don&#39;t try to differentiate b/w Ca and C)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">sym</span> <span class="o">=</span> <span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                            <span class="n">sym</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                            <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
                            <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                            <span class="n">atomic_number</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># give up</span>
                            <span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bfactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">bfactor</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">bfactor</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">occupancy</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">occupancy</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">occupancy</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c"># Figure out what my residue number is and see if the PDB is</span>
                <span class="c"># outputting residue numbers in hexadecimal (e.g., VMD)</span>
                <span class="k">if</span> <span class="n">last_resid</span> <span class="o">&gt;=</span> <span class="mi">9999</span> <span class="ow">and</span> <span class="n">resend</span> <span class="o">==</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">res_hex</span> <span class="ow">and</span> <span class="n">resid</span> <span class="o">==</span> <span class="s">&#39;9999&#39;</span><span class="p">:</span>
                        <span class="n">resid</span> <span class="o">=</span> <span class="mi">9999</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">res_hex</span><span class="p">:</span>
                        <span class="n">res_hex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">10000</span>
                    <span class="c"># So now we know if we use hexadecimal or not. If we do,</span>
                    <span class="c"># convert. Otherwise, stay put</span>
                    <span class="k">if</span> <span class="n">res_hex</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">resid</span> <span class="o">==</span> <span class="s">&#39;****&#39;</span><span class="p">:</span>
                                <span class="n">resid</span> <span class="o">=</span> <span class="bp">None</span> <span class="c"># Figure out by unique atoms</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="n">e</span>
                    <span class="k">elif</span> <span class="n">resid</span> <span class="o">==</span> <span class="s">&#39;1000&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                        <span class="n">resend</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">resid</span> <span class="o">=</span> <span class="mi">10000</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">resend</span> <span class="o">&gt;</span> <span class="mi">26</span><span class="p">:</span>
                    <span class="c"># VMD extends the field now... ugh.</span>
                    <span class="k">if</span> <span class="n">resid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;1&#39;</span> <span class="ow">and</span> <span class="nb">set</span><span class="p">(</span><span class="n">resid</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="n">ZEROSET</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="n">resend</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;0&#39;</span><span class="p">:</span>
                            <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span>
                            <span class="n">resend</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
                <span class="c"># If the number has cycled, it too may be hexadecimal</span>
                <span class="k">if</span> <span class="n">atom_hex</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atnum</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">atnum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
                            <span class="n">atom_overflow</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">atnum</span> <span class="o">=</span> <span class="n">last_atom_added</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Could not convert </span><span class="si">%s</span><span class="s"> to int&#39;</span> <span class="o">%</span>
                                             <span class="n">atnum</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">atom_overflow</span><span class="p">:</span>
                    <span class="n">atnum</span> <span class="o">=</span> <span class="n">last_atom_added</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atnum</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">atnum</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="s">&#39;*&#39;</span><span class="p">):</span>
                            <span class="n">atom_overflow</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">atnum</span> <span class="o">=</span> <span class="n">last_atom_added</span><span class="o">.</span><span class="n">number</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atnum</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
                            <span class="n">atom_hex</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="c"># It&#39;s possible that the residue number has cycled so much that</span>
                <span class="c"># it is now filled with ****&#39;s. In that case, start a new</span>
                <span class="c"># residue if the current residue repeats the same atom name as</span>
                <span class="c"># the &#39;last&#39; residue. Do not worry about atom numbers going to</span>
                <span class="c"># *****&#39;s, since that is &gt;1M atoms.</span>
                <span class="k">if</span> <span class="n">resid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">residues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">atname</span><span class="p">:</span>
                            <span class="n">resid</span> <span class="o">=</span> <span class="n">last_resid</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="n">resid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Still part of the last residue</span>
                    <span class="n">resid</span> <span class="o">=</span> <span class="n">last_resid</span>
                <span class="n">last_resid</span> <span class="o">=</span> <span class="n">resid</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">chg</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">chg</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">atname</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;EP&#39;</span><span class="p">,</span> <span class="s">&#39;LP&#39;</span><span class="p">):</span> <span class="c"># lone pair</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">ExtraPoint</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atname</span><span class="p">,</span>
                                <span class="n">charge</span><span class="o">=</span><span class="n">chg</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">occupancy</span><span class="o">=</span><span class="n">occupancy</span><span class="p">,</span>
                                <span class="n">bfactor</span><span class="o">=</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">altloc</span><span class="o">=</span><span class="n">altloc</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">atnum</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atname</span><span class="p">,</span>
                                <span class="n">charge</span><span class="o">=</span><span class="n">chg</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">occupancy</span><span class="o">=</span><span class="n">occupancy</span><span class="p">,</span>
                                <span class="n">bfactor</span><span class="o">=</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">altloc</span><span class="o">=</span><span class="n">altloc</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">atnum</span><span class="p">)</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">segid</span><span class="p">:</span> <span class="n">atom</span><span class="o">.</span><span class="n">segid</span> <span class="o">=</span> <span class="n">segid</span>
                <span class="k">if</span> <span class="n">_compare_atoms</span><span class="p">(</span><span class="n">last_atom</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
                    <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="n">last_atom</span><span class="o">.</span><span class="n">residue</span>
                    <span class="n">last_atom</span><span class="o">.</span><span class="n">other_locations</span><span class="p">[</span><span class="n">altloc</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span>
                    <span class="n">last_atom_added</span> <span class="o">=</span> <span class="n">atom</span>
                    <span class="k">continue</span>
                <span class="n">last_atom</span> <span class="o">=</span> <span class="n">last_atom_added</span> <span class="o">=</span> <span class="n">atom</span>
                <span class="k">if</span> <span class="n">modelno</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">inscode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">orig_atom</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">[</span><span class="n">atomno</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">PDBError</span><span class="p">(</span><span class="s">&#39;Atom </span><span class="si">%d</span><span class="s"> differs in MODEL </span><span class="si">%d</span><span class="s"> [</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> vs. &#39;</span>
                                       <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomno</span><span class="p">,</span> <span class="n">modelno</span><span class="p">,</span>
                                       <span class="n">atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span>
                                       <span class="n">atname</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">orig_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">resname</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="ow">or</span> <span class="n">orig_atom</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()):</span>
                        <span class="k">raise</span> <span class="n">PDBError</span><span class="p">(</span><span class="s">&#39;Atom </span><span class="si">%d</span><span class="s"> differs in MODEL </span><span class="si">%d</span><span class="s"> [</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s"> vs. &#39;</span>
                                       <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">atomno</span><span class="p">,</span> <span class="n">modelno</span><span class="p">,</span>
                                       <span class="n">orig_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">orig_atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                       <span class="n">resname</span><span class="p">,</span> <span class="n">atname</span><span class="p">))</span>
                <span class="n">coordinates</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;ANISOU&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">11</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Problem parsing atom number from ANISOU &#39;</span>
                                  <span class="s">&#39;record&#39;</span><span class="p">,</span> <span class="n">AnisouWarning</span><span class="p">)</span>
                    <span class="k">continue</span> <span class="c"># Skip the rest of this record</span>
                <span class="n">aname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">altloc</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">rname</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">17</span><span class="p">:</span><span class="mi">20</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">chain</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">resid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">22</span><span class="p">:</span><span class="mi">26</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Problem parsing residue number from ANISOU &#39;</span>
                                  <span class="s">&#39;record&#39;</span><span class="p">,</span> <span class="n">AnisouWarning</span><span class="p">)</span>
                    <span class="k">continue</span> <span class="c"># Skip the rest of this record</span>
                <span class="n">icode</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">u11</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="mi">35</span><span class="p">])</span>
                    <span class="n">u22</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">35</span><span class="p">:</span><span class="mi">42</span><span class="p">])</span>
                    <span class="n">u33</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">42</span><span class="p">:</span><span class="mi">49</span><span class="p">])</span>
                    <span class="n">u12</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">49</span><span class="p">:</span><span class="mi">56</span><span class="p">])</span>
                    <span class="n">u13</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">63</span><span class="p">])</span>
                    <span class="n">u23</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">70</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Problem parsing anisotropic factors from &#39;</span>
                                  <span class="s">&#39;ANISOU record&#39;</span><span class="p">,</span> <span class="n">AnisouWarning</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">last_atom_added</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Orphaned ANISOU record. Poorly formatted &#39;</span>
                                  <span class="s">&#39;PDB file&#39;</span><span class="p">,</span> <span class="n">AnisouWarning</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">la</span> <span class="o">=</span> <span class="n">last_atom_added</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">la</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">aname</span> <span class="ow">or</span> <span class="n">la</span><span class="o">.</span><span class="n">number</span> <span class="o">!=</span> <span class="n">atnum</span> <span class="ow">or</span>
                        <span class="n">la</span><span class="o">.</span><span class="n">altloc</span> <span class="o">!=</span> <span class="n">altloc</span> <span class="ow">or</span> <span class="n">la</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">rname</span> <span class="ow">or</span>
                        <span class="n">la</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">chain</span> <span class="o">!=</span> <span class="n">chain</span> <span class="ow">or</span>
                        <span class="n">la</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">insertion_code</span> <span class="o">!=</span> <span class="n">icode</span><span class="p">):</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;ANISOU record does not match previous atom&#39;</span><span class="p">,</span>
                                  <span class="n">AnisouWarning</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">la</span><span class="o">.</span><span class="n">anisou</span> <span class="o">=</span> <span class="n">create_array</span><span class="p">([</span><span class="n">u11</span><span class="o">/</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">u22</span><span class="o">/</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">u33</span><span class="o">/</span><span class="mf">1e4</span><span class="p">,</span>
                                          <span class="n">u12</span><span class="o">/</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">u13</span><span class="o">/</span><span class="mf">1e4</span><span class="p">,</span> <span class="n">u23</span><span class="o">/</span><span class="mf">1e4</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">rec</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;TER&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">modelno</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">last_atom</span><span class="o">.</span><span class="n">residue</span><span class="o">.</span><span class="n">ter</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;ENDMDL&#39;</span><span class="p">:</span>
                <span class="c"># End the current model</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">PDBError</span><span class="p">(</span><span class="s">&#39;MODEL ended before any atoms read in&#39;</span><span class="p">)</span>
                <span class="n">modelno</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="s">&#39;Inconsistent atom numbers in some PDB models&#39;</span><span class="p">)</span>
                <span class="n">all_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
                <span class="n">atomno</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">resend</span> <span class="o">=</span> <span class="mi">26</span>
                <span class="n">atom_overflow</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;MODEL &#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">modelno</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span><span class="o">*</span><span class="mi">3</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="s">&#39;Inconsistent atom numbers in some PDB models&#39;</span><span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;MODEL not explicitly ended&#39;</span><span class="p">,</span> <span class="n">PDBWarning</span><span class="p">)</span>
                    <span class="n">all_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
                    <span class="n">coordinates</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">modelno</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">atomno</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">resend</span> <span class="o">=</span> <span class="mi">26</span>
                <span class="n">atom_overflow</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;CRYST1&#39;</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">15</span><span class="p">])</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">15</span><span class="p">:</span><span class="mi">24</span><span class="p">])</span>
                <span class="n">c</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">24</span><span class="p">:</span><span class="mi">33</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">33</span><span class="p">:</span><span class="mi">40</span><span class="p">])</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">40</span><span class="p">:</span><span class="mi">47</span><span class="p">])</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">47</span><span class="p">:</span><span class="mi">54</span><span class="p">])</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="n">B</span> <span class="o">=</span> <span class="n">C</span> <span class="o">=</span> <span class="mf">90.0</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">55</span><span class="p">:</span><span class="mi">66</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;EXPDTA&#39;</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">experimental</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;AUTHOR&#39;</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">authors</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;JRNL  &#39;</span><span class="p">:</span>
                <span class="n">part</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">part</span> <span class="o">==</span> <span class="s">&#39;AUTH&#39;</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">journal_authors</span> <span class="o">+=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s">&#39;TITL&#39;</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">title</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s">&#39;REF &#39;</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">journal</span> <span class="o">+=</span> <span class="s">&#39; </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:</span><span class="mi">47</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">18</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">51</span><span class="p">:</span><span class="mi">55</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">61</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">struct</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">62</span><span class="p">:</span><span class="mi">66</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s">&#39;PMID&#39;</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">pmid</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">part</span> <span class="o">==</span> <span class="s">&#39;DOI &#39;</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;KEYWDS&#39;</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">,&#39;</span> <span class="o">%</span> <span class="n">line</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
            <span class="k">elif</span> <span class="n">rec</span> <span class="o">==</span> <span class="s">&#39;REMARK&#39;</span> <span class="ow">and</span> <span class="n">line</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; 900&#39;</span><span class="p">:</span>
                <span class="c"># Related entries</span>
                <span class="n">rematch</span> <span class="o">=</span> <span class="n">relatere</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">11</span><span class="p">:])</span>
                <span class="k">if</span> <span class="n">rematch</span><span class="p">:</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">related_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rematch</span><span class="o">.</span><span class="n">groups</span><span class="p">())</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># Make sure our file is closed if we opened it</span>
        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># Post-process some of the metadata to make it more reader-friendly</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
                                        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">struct</span><span class="o">.</span><span class="n">unchange</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">coordinates</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;bad number of atoms in some PDB models&#39;</span><span class="p">)</span>
        <span class="n">all_coordinates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coordinates</span><span class="p">)</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">pdbxyz</span> <span class="o">=</span> <span class="n">all_coordinates</span>
    <span class="k">return</span> <span class="n">struct</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</div>
<div class="viewcode-block" id="write_PDB"><a class="viewcode-back" href="../../api/chemistry/chemistry.structure.html#chemistry.structure.write_PDB">[docs]</a><span class="k">def</span> <span class="nf">write_PDB</span><span class="p">(</span><span class="n">struct</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">renumber</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">coordinates</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">altlocs</span><span class="o">=</span><span class="s">&#39;all&#39;</span><span class="p">,</span>
              <span class="n">write_anisou</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">charmm</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Write a PDB file from a structure instance</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    struct : :class:`Structure`</span>
<span class="sd">        A Structure instance from which to write the PDB file</span>
<span class="sd">    dest : ``str or file-like``</span>
<span class="sd">        Either a file name or a file-like object containing a `write`</span>
<span class="sd">        method to which to write the PDB file</span>
<span class="sd">    renumber : ``bool``</span>
<span class="sd">        If True, renumber the atoms and residues sequentially as they are</span>
<span class="sd">        stored in the structure.  If False, use the original numbering if</span>
<span class="sd">        it was assigned previously</span>
<span class="sd">    coordinates : ``array-like of float``</span>
<span class="sd">        If provided, these coordinates will be written to the PDB file</span>
<span class="sd">        instead of the coordinates stored in the structure. These</span>
<span class="sd">        coordinates should line up with the atom order in the structure</span>
<span class="sd">        (not necessarily the order of the &quot;original&quot; PDB file if they</span>
<span class="sd">        differ)</span>
<span class="sd">    altlocs : ``str``</span>
<span class="sd">        Keyword controlling which alternate locations are printed to the</span>
<span class="sd">        resulting PDB file. Allowable options are:</span>
<span class="sd">            - &#39;all&#39; : (default) print all alternate locations</span>
<span class="sd">            - &#39;first&#39; : print only the first alternate locations</span>
<span class="sd">            - &#39;occupancy&#39; : print the one with the largest occupancy. If two</span>
<span class="sd">              conformers have the same occupancy, the first one to occur is</span>
<span class="sd">              printed</span>
<span class="sd">        Input is case-insensitive, and partial strings are permitted as long</span>
<span class="sd">        as it is a substring of one of the above options that uniquely</span>
<span class="sd">        identifies the choice.</span>
<span class="sd">    write_anisou : ``bool``</span>
<span class="sd">        If True, an ANISOU record is written for every atom that has one. If</span>
<span class="sd">        False, ANISOU records are not written</span>
<span class="sd">    charmm : ``bool``</span>
<span class="sd">        If True, SEGID will be written in columns 73 to 76 of the PDB file in</span>
<span class="sd">        the typical CHARMM-style PDB output. This will be omitted for any atom</span>
<span class="sd">        that does not contain a SEGID identifier.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">struct</span><span class="o">.</span><span class="n">write_pdb</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">renumber</span><span class="p">,</span> <span class="n">coordinates</span><span class="p">,</span> <span class="n">altlocs</span><span class="p">,</span> <span class="n">write_anisou</span><span class="p">,</span> <span class="n">charmm</span><span class="p">)</span>

<span class="c">#++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
</div>
<div class="viewcode-block" id="read_CIF"><a class="viewcode-back" href="../../structobj/chemistry.structure.read_CIF.html#chemistry.structure.read_CIF">[docs]</a><span class="k">def</span> <span class="nf">read_CIF</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read a PDBx or mmCIF file and return a populated `Structure` class</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : ``str or file-like``</span>
<span class="sd">        Name of PDB file to read, or a file-like object that can iterate over</span>
<span class="sd">        the lines of a PDB. Compressed file names can be specified and are</span>
<span class="sd">        determined by file-name extension (e.g., file.pdb.gz, file.pdb.bz2)</span>

<span class="sd">    Metadata</span>
<span class="sd">    --------</span>
<span class="sd">    The PDB parser also adds metadata to the returned Structure object that may</span>
<span class="sd">    be present in the PDB file</span>

<span class="sd">    experimental : ``str``</span>
<span class="sd">        EXPDTA record</span>
<span class="sd">    journal : ``str``</span>
<span class="sd">        JRNL record</span>
<span class="sd">    authors : ``str``</span>
<span class="sd">        AUTHOR records</span>
<span class="sd">    keywords : ``str``</span>
<span class="sd">        KEYWDS records</span>
<span class="sd">    doi : ``str``</span>
<span class="sd">        DOI from the JRNL record</span>
<span class="sd">    pmid : ``str``</span>
<span class="sd">        PMID from the JRNL record</span>
<span class="sd">    journal_authors : ``str``</span>
<span class="sd">        Author info from the JRNL record</span>
<span class="sd">    volume : ``str``</span>
<span class="sd">        Volume of the published article from the JRNL record</span>
<span class="sd">    page : ``str``</span>
<span class="sd">        Page of the published article from the JRNL record</span>
<span class="sd">    title : ``str``</span>
<span class="sd">        TITL section of the JRNL record</span>
<span class="sd">    year : ``str``</span>
<span class="sd">        Year that the article was published, from the JRNL record</span>
<span class="sd">    related_entries : ``list of (str, str)``</span>
<span class="sd">        List of entries in other databases</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    structure1 [, structure2 [, structure3 [, ...] ] ]</span>

<span class="sd">    structure# : :class:`Structure`</span>
<span class="sd">        The Structure object initialized with all of the information from the</span>
<span class="sd">        PDBx/mmCIF file.  No bonds or other topological features are added by</span>
<span class="sd">        default. If multiple structures are defined in the CIF file, multiple</span>
<span class="sd">        Structure instances will be returned as a tuple.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The returned structure has an extra attribute, pdbxyz, that contains all of</span>
<span class="sd">    the coordinates for all of the frames in the PDB file as a list of NATOM*3</span>
<span class="sd">    lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.gz&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">gzip</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;gzip is not available for compressed PDB&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;.bz2&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bz2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s">&#39;bz2 is not available for compressed PDB&#39;</span><span class="p">)</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="n">bz2</span><span class="o">.</span><span class="n">BZ2File</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fileobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">own_handle</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">fileobj</span> <span class="o">=</span> <span class="n">filename</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cifobj</span> <span class="o">=</span> <span class="n">PdbxReader</span><span class="p">(</span><span class="n">fileobj</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cifobj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">own_handle</span><span class="p">:</span> <span class="n">fileobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">cont</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">struct</span> <span class="o">=</span> <span class="n">Structure</span><span class="p">()</span>
        <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">struct</span><span class="p">)</span>

        <span class="c"># Now we have the data. First get the metadata if it exists</span>
        <span class="n">exptl</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;exptl&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exptl</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">experimental</span> <span class="o">=</span> <span class="n">exptl</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s">&#39;method&#39;</span><span class="p">)</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;audit_author&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">auth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nameidx</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nameidx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">authors</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">t</span><span class="p">[</span><span class="n">nameidx</span><span class="p">]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span>
                                           <span class="n">auth</span><span class="o">.</span><span class="n">getRowList</span><span class="p">()])</span>
        <span class="n">cite</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;citation_author&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">nameidx</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nameidx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">journal_authors</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">cite</span><span class="o">.</span><span class="n">getRowCount</span><span class="p">()):</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="n">nameidx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">a</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">journal_authors</span><span class="p">:</span>
                        <span class="n">journal_authors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">journal_authors</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">journal_authors</span><span class="p">)</span>
        <span class="n">cite</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;citation&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cite</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">doiid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_database_id_DOI&#39;</span><span class="p">)</span>
            <span class="n">pmiid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_database_id_PubMed&#39;</span><span class="p">)</span>
            <span class="n">titlid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span>
            <span class="n">yearid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;year&#39;</span><span class="p">)</span>
            <span class="n">pageid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;page_first&#39;</span><span class="p">)</span>
            <span class="n">jrnlid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;journal_abbrev&#39;</span><span class="p">)</span>
            <span class="n">volid</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;journal_volume&#39;</span><span class="p">)</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">cite</span><span class="o">.</span><span class="n">getRowList</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">doiid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">doiid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span>
                                            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">doiid</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;?&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pmiid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">pmid</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">pmiid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span>
                                            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">pmiid</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;?&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">titlid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">titlid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">yearid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">yearid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pageid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">page</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">pageid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">jrnlid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">journal</span> <span class="o">=</span> <span class="s">&#39;; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">jrnlid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">volid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">volid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
        <span class="n">keywds</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;struct_keywords&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keywds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">textid</span> <span class="o">=</span> <span class="n">keywds</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;text&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">textid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">keywds</span><span class="o">.</span><span class="n">getRowList</span><span class="p">()</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">row</span><span class="p">[</span><span class="n">textid</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">])</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
        <span class="n">dbase</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;pdbx_database_related&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dbase</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">dbid</span> <span class="o">=</span> <span class="n">dbase</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;db_id&#39;</span><span class="p">)</span>
            <span class="n">nameid</span> <span class="o">=</span> <span class="n">dbase</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;db_name&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dbid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">nameid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">rows</span> <span class="o">=</span> <span class="n">dbase</span><span class="o">.</span><span class="n">getRowList</span><span class="p">()</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">related_entries</span> <span class="o">=</span> <span class="p">[(</span><span class="n">r</span><span class="p">[</span><span class="n">dbid</span><span class="p">],</span> <span class="n">r</span><span class="p">[</span><span class="n">nameid</span><span class="p">])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">]</span>
        <span class="c"># Now go through all of the atoms. Any items that do *not* exist are</span>
        <span class="c"># given an index of -1. So we append an empty string on the end of each</span>
        <span class="c"># row so that the default value for any un-specified value is the empty</span>
        <span class="c"># string. This avoids needing any conditionals inside the loop</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;atom_site&#39;</span><span class="p">)</span>
        <span class="n">atnumid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">elemid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;type_symbol&#39;</span><span class="p">)</span>
        <span class="n">atnameid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;auth_atom_id&#39;</span><span class="p">)</span>
        <span class="n">altlocid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;label_alt_id&#39;</span><span class="p">)</span>
        <span class="n">resnameid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;auth_comp_id&#39;</span><span class="p">)</span>
        <span class="n">chainid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;auth_asym_id&#39;</span><span class="p">)</span>
        <span class="n">resnumid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;auth_seq_id&#39;</span><span class="p">)</span>
        <span class="n">inscodeid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_PDB_ins_code&#39;</span><span class="p">)</span>
        <span class="n">xid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;Cartn_x&#39;</span><span class="p">)</span>
        <span class="n">yid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;Cartn_y&#39;</span><span class="p">)</span>
        <span class="n">zid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;Cartn_z&#39;</span><span class="p">)</span>
        <span class="n">occupid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;occupancy&#39;</span><span class="p">)</span>
        <span class="n">bfactorid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;B_iso_or_equiv&#39;</span><span class="p">)</span>
        <span class="n">chargeid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_formal_charge&#39;</span><span class="p">)</span>
        <span class="n">modelid</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_PDB_model_num&#39;</span><span class="p">)</span>
        <span class="n">origmodel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">lastmodel</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">atommap</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">last_atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">atoms</span><span class="o">.</span><span class="n">getRowCount</span><span class="p">()):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
            <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">atnumid</span><span class="p">])</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">elemid</span><span class="p">]</span>
            <span class="n">atname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">atnameid</span><span class="p">]</span>
            <span class="n">altloc</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">altlocid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">altloc</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span> <span class="n">altloc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="n">resname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">resnameid</span><span class="p">]</span>
            <span class="n">chain</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">chainid</span><span class="p">]</span>
            <span class="n">resnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">resnumid</span><span class="p">])</span>
            <span class="n">inscode</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">inscodeid</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">inscode</span> <span class="ow">in</span> <span class="s">&#39;?.&#39;</span><span class="p">:</span> <span class="n">inscode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">modelid</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">model</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">origmodel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">origmodel</span> <span class="o">=</span> <span class="n">lastmodel</span> <span class="o">=</span> <span class="n">model</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xid</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">yid</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">zid</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">occup</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">occupid</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">occup</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bfactor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">bfactorid</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">bfactor</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">charge</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">chargeid</span><span class="p">]</span>
            <span class="c"># Try to figure out the element</span>
            <span class="n">elem</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%-2s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">elem</span> <span class="c"># Make sure we have at least 2 characters</span>
            <span class="k">if</span> <span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">:</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39; &#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">atsym</span> <span class="o">=</span> <span class="p">(</span><span class="n">elem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">elem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">atsym</span><span class="p">]</span>
                <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">atsym</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="c"># Now try based on the atom name... but don&#39;t try too hard</span>
                <span class="c"># (e.g., don&#39;t try to differentiate b/w Ca and C)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                    <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">sym</span> <span class="o">=</span> <span class="n">atname</span><span class="o">.</span><span class="n">strip</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">sym</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">sym</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                        <span class="n">atomic_number</span> <span class="o">=</span> <span class="n">AtomicNum</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="n">Mass</span><span class="p">[</span><span class="n">sym</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="n">atomic_number</span> <span class="o">=</span> <span class="mi">0</span> <span class="c"># give up</span>
                        <span class="n">mass</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">if</span> <span class="n">atname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;EP&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">atname</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;LP&#39;</span><span class="p">):</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">ExtraPoint</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atname</span><span class="p">,</span>
                                  <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">occupancy</span><span class="o">=</span><span class="n">occup</span><span class="p">,</span>
                                  <span class="n">bfactor</span><span class="o">=</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">altloc</span><span class="o">=</span><span class="n">altloc</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">atnum</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">atom</span> <span class="o">=</span> <span class="n">Atom</span><span class="p">(</span><span class="n">atomic_number</span><span class="o">=</span><span class="n">atomic_number</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">atname</span><span class="p">,</span>
                            <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">mass</span><span class="o">=</span><span class="n">mass</span><span class="p">,</span> <span class="n">occupancy</span><span class="o">=</span><span class="n">occup</span><span class="p">,</span>
                            <span class="n">bfactor</span><span class="o">=</span><span class="n">bfactor</span><span class="p">,</span> <span class="n">altloc</span><span class="o">=</span><span class="n">altloc</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">atnum</span><span class="p">)</span>
            <span class="n">atom</span><span class="o">.</span><span class="n">xx</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">xz</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
            <span class="k">if</span> <span class="n">_compare_atoms</span><span class="p">(</span><span class="n">last_atom</span><span class="p">,</span> <span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="p">):</span>
                <span class="n">atom</span><span class="o">.</span><span class="n">residue</span> <span class="o">=</span> <span class="n">last_atom</span><span class="o">.</span><span class="n">residue</span>
                <span class="n">last_atom</span><span class="o">.</span><span class="n">other_locations</span><span class="p">[</span><span class="n">altloc</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="n">origmodel</span><span class="p">:</span>
                    <span class="c"># Only add the atoms once</span>
                    <span class="n">struct</span><span class="o">.</span><span class="n">add_atom</span><span class="p">(</span><span class="n">atom</span><span class="p">,</span> <span class="n">resname</span><span class="p">,</span> <span class="n">resnum</span><span class="p">,</span> <span class="n">chain</span><span class="p">,</span> <span class="n">inscode</span><span class="p">)</span>
                <span class="n">last_atom</span> <span class="o">=</span> <span class="n">atom</span>
                <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="n">lastmodel</span><span class="p">:</span>
                    <span class="n">xyz</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">lastmodel</span> <span class="o">==</span> <span class="n">origmodel</span><span class="p">:</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pdbxyz</span> <span class="o">=</span> <span class="p">[</span><span class="n">xyz</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">struct</span><span class="o">.</span><span class="n">pdbxyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
                    <span class="n">xyz</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c"># Keep a mapping in case we need to go back and add attributes, like</span>
            <span class="c"># anisotropic b-factors</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="n">origmodel</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">resnum</span><span class="p">,</span><span class="n">resname</span><span class="p">,</span><span class="n">inscode</span><span class="p">,</span><span class="n">chain</span><span class="p">,</span><span class="n">atnum</span><span class="p">,</span><span class="n">altloc</span><span class="p">,</span><span class="n">atname</span><span class="p">)</span>
                <span class="n">atommap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">atom</span>
        <span class="c"># Check for unit cell parameters</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;cell&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">aid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;length_a&#39;</span><span class="p">)</span>
            <span class="n">bid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;length_b&#39;</span><span class="p">)</span>
            <span class="n">cid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;length_c&#39;</span><span class="p">)</span>
            <span class="n">alphaid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;angle_alpha&#39;</span><span class="p">)</span>
            <span class="n">betaid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;angle_beta&#39;</span><span class="p">)</span>
            <span class="n">gammaid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;angle_gamma&#39;</span><span class="p">)</span>
            <span class="n">spaceid</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;space_group_name_H-M&#39;</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">struct</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">create_array</span><span class="p">(</span>
                    <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">aid</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">bid</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">cid</span><span class="p">]),</span>
                     <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">alphaid</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">betaid</span><span class="p">]),</span>
                     <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">gammaid</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">spaceid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">space_group</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">spaceid</span><span class="p">]</span>
        <span class="c"># Check for anisotropic B-factors</span>
        <span class="n">anisou</span> <span class="o">=</span> <span class="n">cont</span><span class="o">.</span><span class="n">getObj</span><span class="p">(</span><span class="s">&#39;atom_site_anisotrop&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">anisou</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">atnumid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span>
            <span class="n">atnameid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_auth_atom_id&#39;</span><span class="p">)</span>
            <span class="n">altlocid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_label_alt_id&#39;</span><span class="p">)</span>
            <span class="n">resnameid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_auth_comp_id&#39;</span><span class="p">)</span>
            <span class="n">chainid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_auth_asym_id&#39;</span><span class="p">)</span>
            <span class="n">resnumid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_auth_seq_id&#39;</span><span class="p">)</span>
            <span class="n">inscodeid</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;pdbx_PDB_ins_code&#39;</span><span class="p">)</span>
            <span class="n">u11id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[1][1]&#39;</span><span class="p">)</span>
            <span class="n">u22id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[2][2]&#39;</span><span class="p">)</span>
            <span class="n">u33id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[3][3]&#39;</span><span class="p">)</span>
            <span class="n">u12id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[1][2]&#39;</span><span class="p">)</span>
            <span class="n">u13id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[1][3]&#39;</span><span class="p">)</span>
            <span class="n">u23id</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getAttributeIndex</span><span class="p">(</span><span class="s">&#39;U[2][3]&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="p">(</span><span class="n">atnumid</span><span class="p">,</span> <span class="n">atnameid</span><span class="p">,</span> <span class="n">altlocid</span><span class="p">,</span> <span class="n">resnameid</span><span class="p">,</span> <span class="n">chainid</span><span class="p">,</span> <span class="n">resnumid</span><span class="p">,</span>
                      <span class="n">u11id</span><span class="p">,</span> <span class="n">u22id</span><span class="p">,</span> <span class="n">u33id</span><span class="p">,</span> <span class="n">u12id</span><span class="p">,</span> <span class="n">u13id</span><span class="p">,</span> <span class="n">u23id</span><span class="p">):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Incomplete anisotropic B-factor CIF section. &#39;</span>
                              <span class="s">&#39;Skipping&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">anisou</span><span class="o">.</span><span class="n">getRowCount</span><span class="p">()):</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="n">anisou</span><span class="o">.</span><span class="n">getRow</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span>
                        <span class="n">atnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">atnumid</span><span class="p">])</span>
                        <span class="n">atname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">atnameid</span><span class="p">]</span>
                        <span class="n">altloc</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">altlocid</span><span class="p">]</span>
                        <span class="n">resname</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">resnameid</span><span class="p">]</span>
                        <span class="n">chain</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">chainid</span><span class="p">]</span>
                        <span class="n">resnum</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">resnumid</span><span class="p">])</span>
                        <span class="n">inscode</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">inscodeid</span><span class="p">]</span>
                        <span class="n">u11</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u11id</span><span class="p">])</span>
                        <span class="n">u22</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u22id</span><span class="p">])</span>
                        <span class="n">u33</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u33id</span><span class="p">])</span>
                        <span class="n">u12</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u12id</span><span class="p">])</span>
                        <span class="n">u13</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u13id</span><span class="p">])</span>
                        <span class="n">u23</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">u23id</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">altloc</span> <span class="o">==</span> <span class="s">&#39;.&#39;</span><span class="p">:</span> <span class="n">altloc</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="k">if</span> <span class="n">inscode</span> <span class="ow">in</span> <span class="s">&#39;?.&#39;</span><span class="p">:</span> <span class="n">inscode</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">resnum</span><span class="p">,</span><span class="n">resname</span><span class="p">,</span><span class="n">inscode</span><span class="p">,</span><span class="n">chain</span><span class="p">,</span><span class="n">atnum</span><span class="p">,</span><span class="n">altloc</span><span class="p">,</span><span class="n">atname</span><span class="p">)</span>
                        <span class="n">atommap</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">anisou</span> <span class="o">=</span> <span class="n">create_array</span><span class="p">(</span>
                                <span class="p">[</span><span class="n">u11</span><span class="p">,</span> <span class="n">u22</span><span class="p">,</span> <span class="n">u33</span><span class="p">,</span> <span class="n">u12</span><span class="p">,</span> <span class="n">u13</span><span class="p">,</span> <span class="n">u23</span><span class="p">]</span>
                        <span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
                    <span class="c"># If at least one went wrong, set them all to None</span>
                    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atommap</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                        <span class="n">atom</span><span class="o">.</span><span class="n">anisou</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&#39;Problem processing anisotropic B-factors. &#39;</span>
                                  <span class="s">&#39;Skipping&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">xyz</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">print</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">atoms</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;Corrupt CIF; all models must have the same &#39;</span>
                                 <span class="s">&#39;atoms&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">pdbxyz</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xyz</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="c"># Hasn&#39;t been assigned yet</span>
                <span class="n">struct</span><span class="o">.</span><span class="n">pdbxyz</span> <span class="o">=</span> <span class="n">xyz</span>

    <span class="c"># Build the return value</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">structures</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">ParmEd 2.0 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2015, Jason Swails.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>